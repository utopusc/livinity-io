---
phase: v2.0-p05-live-canvas-livhub
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/ui/src/routes/ai-chat/skills-panel.tsx
  - livos/packages/ui/src/routes/ai-chat/index.tsx
  - nexus/packages/core/src/api.ts
  - livos/packages/livinityd/source/modules/ai/routes.ts
autonomous: true

must_haves:
  truths:
    - "User can browse the LivHub marketplace with skill names, descriptions, versions, and permissions"
    - "Skills can be installed from LivHub with permission review before installation"
    - "Skills can be uninstalled and immediately removed from agent's available tools"
    - "LivHub supports multiple Git-based registries (not just one source)"
    - "Skill catalog is cached with configurable TTL and manual refresh"
    - "LivHub branding replaces the old 'Skills' label"
  artifacts:
    - path: "livos/packages/ui/src/routes/ai-chat/skills-panel.tsx"
      provides: "LivHub-branded marketplace with multi-registry display, install/uninstall, permission review, refresh, and registry management"
      exports: ["default (SkillsPanel)"]
    - path: "livos/packages/ui/src/routes/ai-chat/index.tsx"
      provides: "Updated sidebar tab label from 'Skills' to 'LivHub'"
      contains: "LivHub"
    - path: "nexus/packages/core/src/api.ts"
      provides: "New /api/skills/registries GET and POST endpoints for multi-registry management, /api/skills/refresh POST endpoint"
      contains: "/api/skills/registries"
    - path: "livos/packages/livinityd/source/modules/ai/routes.ts"
      provides: "tRPC proxy routes for registry management and catalog refresh"
      contains: "listRegistries"
  key_links:
    - from: "livos/packages/ui/src/routes/ai-chat/skills-panel.tsx"
      to: "tRPC routes"
      via: "tRPC queries for catalog, installed skills, registries"
      pattern: "trpcReact\\.ai\\.(listRegistries|addRegistry|refreshCatalog)"
    - from: "livos/packages/livinityd/source/modules/ai/routes.ts"
      to: "nexus/packages/core/src/api.ts"
      via: "tRPC proxy routes fetch from Nexus /api/skills/* endpoints"
      pattern: "fetch.*api/skills"
    - from: "nexus/packages/core/src/api.ts"
      to: "skill-registry-client.ts"
      via: "API endpoints call SkillRegistryClient methods"
      pattern: "skillRegistryClient"
---

<objective>
Upgrade the existing Skills panel to LivHub: a full-featured skill marketplace with LivHub branding, multi-registry support (users can add/remove Git-based registries), manual catalog refresh, and improved UI. Also add the Nexus REST endpoints and tRPC proxy routes to support multi-registry CRUD and refresh.

Purpose: LivHub is the skill marketplace for LivOS. The existing skills-panel.tsx already has install/uninstall/permission review. This plan adds LivHub branding, multi-registry management, and catalog refresh — fulfilling HUB-01 through HUB-05.

Output: Updated SkillsPanel with LivHub branding, new registry management section, refresh button, new Nexus endpoints, and tRPC proxy routes.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@livos/packages/ui/src/routes/ai-chat/skills-panel.tsx
@livos/packages/ui/src/routes/ai-chat/index.tsx
@nexus/packages/core/src/api.ts
@nexus/packages/core/src/skill-registry-client.ts
@nexus/packages/core/src/skill-installer.ts
@livos/packages/livinityd/source/modules/ai/routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nexus REST endpoints for registry management and catalog refresh</name>
  <files>
    nexus/packages/core/src/api.ts
    nexus/packages/core/src/skill-registry-client.ts
  </files>
  <action>
**Part A: Add REST endpoints in api.ts**

In `api.ts`, after the existing skill marketplace endpoints (after `/api/skills/uninstall`), add:

```typescript
/** List all configured registries */
app.get('/api/skills/registries', async (_req, res) => {
  if (!skillRegistryClient) {
    res.status(503).json({ error: 'Skill registry not configured' });
    return;
  }
  try {
    const registries = skillRegistryClient.getRegistries();
    res.json({ registries });
  } catch (err) {
    res.status(500).json({ error: formatErrorMessage(err) });
  }
});

/** Add a new registry */
app.post('/api/skills/registries', async (req, res) => {
  if (!skillRegistryClient) {
    res.status(503).json({ error: 'Skill registry not configured' });
    return;
  }
  try {
    const { url } = req.body;
    if (!url || typeof url !== 'string') {
      res.status(400).json({ error: 'url is required' });
      return;
    }
    // Validate GitHub URL format
    if (!url.match(/github\.com\/[^/]+\/[^/]+/)) {
      res.status(400).json({ error: 'URL must be a GitHub repository (e.g. https://github.com/user/repo)' });
      return;
    }
    skillRegistryClient.addRegistry(url);
    // Persist to Redis so registries survive restarts
    // Use the `redis` variable already in scope from createApiServer's ApiDeps (NOT daemon?.redis — Daemon has no public redis getter)
    if (redis) {
      const registries = skillRegistryClient.getRegistries();
      await redis.set('nexus:skills:registries', JSON.stringify(registries));
    }
    res.json({ success: true, registries: skillRegistryClient.getRegistries() });
  } catch (err) {
    res.status(500).json({ error: formatErrorMessage(err) });
  }
});

/** Remove a registry */
app.delete('/api/skills/registries', async (req, res) => {
  if (!skillRegistryClient) {
    res.status(503).json({ error: 'Skill registry not configured' });
    return;
  }
  try {
    const { url } = req.body;
    if (!url || typeof url !== 'string') {
      res.status(400).json({ error: 'url is required' });
      return;
    }
    skillRegistryClient.removeRegistry(url);
    // Persist to Redis
    // Use the `redis` variable already in scope from createApiServer's ApiDeps (NOT daemon?.redis — Daemon has no public redis getter)
    if (redis) {
      const registries = skillRegistryClient.getRegistries();
      await redis.set('nexus:skills:registries', JSON.stringify(registries));
    }
    res.json({ success: true, registries: skillRegistryClient.getRegistries() });
  } catch (err) {
    res.status(500).json({ error: formatErrorMessage(err) });
  }
});

/** Force refresh skill catalog (clears cache and re-fetches) */
app.post('/api/skills/refresh', async (_req, res) => {
  if (!skillRegistryClient) {
    res.status(503).json({ error: 'Skill registry not configured' });
    return;
  }
  try {
    skillRegistryClient.clearCache();
    const skills = await skillRegistryClient.fetchCatalog();
    res.json({ success: true, count: skills.length });
  } catch (err) {
    res.status(500).json({ error: formatErrorMessage(err) });
  }
});
```

**Part B: Add getRegistries() and removeRegistry() methods to SkillRegistryClient**

In `nexus/packages/core/src/skill-registry-client.ts`, add two new public methods:

```typescript
/** Get list of all configured registry URLs */
getRegistries(): string[] {
  return [...this.registries];
}

/** Remove a registry URL. Returns true if it was present. */
removeRegistry(url: string): boolean {
  const normalized = url.replace(/\/+$/, '').replace(/\.git$/, '');
  const idx = this.registries.indexOf(normalized);
  if (idx !== -1) {
    this.registries.splice(idx, 1);
    logger.info('SkillRegistryClient: registry removed', { url: normalized });
    return true;
  }
  return false;
}
```

**Part C: Load persisted registries on startup**

In the initialization code where `SkillRegistryClient` is created (in api.ts or wherever the daemon creates it), add logic to load registries from Redis:

Search for where `skillRegistryClient = new SkillRegistryClient(...)` is created. After `addRegistry(defaultRegistryUrl)`, add:
```typescript
// Load persisted registries from Redis
try {
  const savedRegistries = await redis.get('nexus:skills:registries');
  if (savedRegistries) {
    const urls: string[] = JSON.parse(savedRegistries);
    for (const url of urls) {
      skillRegistryClient.addRegistry(url);
    }
    logger.info('SkillRegistryClient: loaded persisted registries', { count: urls.length });
  }
} catch (err) {
  logger.warn('SkillRegistryClient: failed to load persisted registries', { error: formatErrorMessage(err) });
}
```

If the initialization happens in a file other than api.ts, add the loading there. The key is `nexus:skills:registries` in Redis, which stores a JSON array of registry URL strings.
  </action>
  <verify>
1. Read api.ts — confirm GET/POST/DELETE /api/skills/registries endpoints exist
2. Read api.ts — confirm POST /api/skills/refresh endpoint exists
3. Read skill-registry-client.ts — confirm getRegistries() and removeRegistry() methods exist
4. Confirm registries are persisted to Redis key `nexus:skills:registries`
  </verify>
  <done>Nexus REST endpoints support multi-registry CRUD and catalog refresh, SkillRegistryClient has getRegistries/removeRegistry methods, and registries are persisted in Redis</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade SkillsPanel to LivHub with multi-registry and refresh</name>
  <files>
    livos/packages/ui/src/routes/ai-chat/skills-panel.tsx
    livos/packages/ui/src/routes/ai-chat/index.tsx
    livos/packages/livinityd/source/modules/ai/routes.ts
  </files>
  <action>
**Part A: Add tRPC proxy routes in routes.ts**

In `livos/packages/livinityd/source/modules/ai/routes.ts`, add these routes within the router:

```typescript
/** List skill registries (proxied from Nexus) */
listRegistries: privateProcedure.query(async () => {
  const nexusUrl = getNexusApiUrl()
  const response = await fetch(`${nexusUrl}/api/skills/registries`, {
    headers: process.env.LIV_API_KEY ? { 'X-API-Key': process.env.LIV_API_KEY } : {},
  })
  if (!response.ok) return { registries: [] }
  const data = await response.json() as { registries: string[] }
  return data
}),

/** Add a skill registry (proxied from Nexus) */
addRegistry: privateProcedure
  .input(z.object({ url: z.string().url() }))
  .mutation(async ({ input }) => {
    const nexusUrl = getNexusApiUrl()
    const response = await fetch(`${nexusUrl}/api/skills/registries`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(process.env.LIV_API_KEY ? { 'X-API-Key': process.env.LIV_API_KEY } : {}),
      },
      body: JSON.stringify({ url: input.url }),
    })
    if (!response.ok) {
      const data = await response.json().catch(() => ({ error: 'Failed' })) as { error?: string }
      throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: data.error || `Error: ${response.status}` })
    }
    return await response.json()
  }),

/** Remove a skill registry (proxied from Nexus) */
removeRegistry: privateProcedure
  .input(z.object({ url: z.string() }))
  .mutation(async ({ input }) => {
    const nexusUrl = getNexusApiUrl()
    const response = await fetch(`${nexusUrl}/api/skills/registries`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        ...(process.env.LIV_API_KEY ? { 'X-API-Key': process.env.LIV_API_KEY } : {}),
      },
      body: JSON.stringify({ url: input.url }),
    })
    if (!response.ok) {
      throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: `Error: ${response.status}` })
    }
    return await response.json()
  }),

/** Refresh skill catalog (proxied from Nexus) */
refreshCatalog: privateProcedure.mutation(async () => {
  const nexusUrl = getNexusApiUrl()
  const response = await fetch(`${nexusUrl}/api/skills/refresh`, {
    method: 'POST',
    headers: process.env.LIV_API_KEY ? { 'X-API-Key': process.env.LIV_API_KEY } : {},
  })
  if (!response.ok) {
    throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: `Error: ${response.status}` })
  }
  return await response.json()
}),
```

**Part B: Update skills-panel.tsx — LivHub branding and enhancements**

Rewrite the skills-panel.tsx to add LivHub branding and multi-registry management. The existing install/uninstall/permission review UI already works well — keep it and add:

1. **LivHub branding in the header:**
   Replace the current header:
   ```tsx
   {/* Old */}
   <IconPuzzle size={18} className='text-emerald-400' />
   <h2 className='text-body font-semibold text-text-primary'>Skills</h2>
   ```
   With:
   ```tsx
   <div className='flex h-9 w-9 items-center justify-center rounded-radius-lg bg-gradient-to-br from-indigo-500/20 to-purple-500/20'>
     <IconPuzzle size={18} className='text-indigo-400' />
   </div>
   <div>
     <h2 className='text-body font-semibold text-text-primary'>LivHub</h2>
     <p className='text-caption-sm leading-relaxed text-text-tertiary'>
       Discover and manage skills that extend Liv's capabilities.
     </p>
   </div>
   ```

2. **Add a third tab: "Registries"** alongside Marketplace and Installed:
   ```typescript
   type SkillTab = 'marketplace' | 'installed' | 'registries'
   ```
   Add the tab button:
   ```tsx
   {id: 'registries', label: 'Registries', icon: <IconDatabase size={13} />}
   ```
   Import `IconDatabase` from @tabler/icons-react.

3. **Add a Refresh button** in the Marketplace tab header area:
   ```tsx
   <button
     onClick={handleRefresh}
     disabled={refreshing}
     className='flex items-center gap-1.5 rounded-radius-lg bg-surface-1 px-3 py-1.5 text-caption font-medium text-text-secondary transition-all hover:bg-surface-2 hover:text-text-primary disabled:opacity-40'
     title='Refresh catalog'
   >
     {refreshing ? <IconLoader2 size={13} className='animate-spin' /> : <IconRefresh size={13} />}
     Refresh
   </button>
   ```
   Import `IconRefresh` from @tabler/icons-react.

   The refresh handler uses tRPC:
   ```typescript
   const refreshMutation = trpcReact.ai.refreshCatalog.useMutation()
   const [refreshing, setRefreshing] = useState(false)

   const handleRefresh = async () => {
     setRefreshing(true)
     try {
       await refreshMutation.mutateAsync()
       await fetchCatalog() // Re-fetch the catalog after refresh
     } catch (err) {
       console.error('Refresh error:', err)
     } finally {
       setRefreshing(false)
     }
   }
   ```

   Wait — the existing MarketplaceTab uses direct `fetch` calls to `/api/skills/*`, not tRPC. For consistency with the existing pattern, the refresh button can use the same `skillFetch` helper:
   ```typescript
   const handleRefresh = async () => {
     setRefreshing(true)
     try {
       await skillFetch('/refresh', { method: 'POST' })
       await fetchCatalog()
     } catch (err) {
       console.error('Refresh error:', err)
     } finally {
       setRefreshing(false)
     }
   }
   ```

   Actually, the existing skills-panel.tsx already uses direct fetch to `/api/skills/*` (through the `skillFetch` helper). For the registry endpoints, continue using the same pattern since the Nexus /api/skills/* routes are proxied by the livinityd backend. Check if `/api/skills/registries` and `/api/skills/refresh` need to be proxied.

   Looking at the existing pattern: `skillFetch` calls `fetch(/api/skills/...)` directly. These requests go to the LivOS livinityd server. BUT the skills API endpoints are on Nexus (port 3200). So either:
   - Option A: The livinityd server already proxies /api/skills/* to Nexus (check for this)
   - Option B: The skills-panel.tsx calls Nexus directly

   Looking at the `API_BASE = '/api/skills'` in skills-panel.tsx and the Nexus api.ts having `app.get('/api/skills/marketplace', ...)` — these endpoints are on the Nexus Express server (port 3200). The livinityd server (port 80/443 for the web UI) must be proxying /api/skills/* to Nexus.

   Check if there's a proxy configuration in the livinityd server or Vite config. If there's a Vite proxy for `/api/skills` -> `http://localhost:3200`, then the skills-panel.tsx skillFetch calls work via that proxy.

   Since the existing skillFetch pattern works (the app is deployed and functional), the new endpoints (/api/skills/registries, /api/skills/refresh) will also work through the same proxy as long as they're on the Nexus api.ts.

   **Continue using the `skillFetch` helper pattern** for registries and refresh — no tRPC needed for these since they follow the existing direct-API pattern.

4. **Create RegistriesTab component:**

```tsx
function RegistriesTab() {
  const [registries, setRegistries] = useState<string[]>([])
  const [loading, setLoading] = useState(true)
  const [newUrl, setNewUrl] = useState('')
  const [adding, setAdding] = useState(false)
  const [error, setError] = useState('')

  const fetchRegistries = useCallback(async () => {
    try {
      const data = await skillFetch<{registries: string[]}>('/registries')
      setRegistries(data.registries || [])
    } catch (err) {
      console.error('Failed to fetch registries:', err)
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => { fetchRegistries() }, [fetchRegistries])

  const handleAdd = async () => {
    if (!newUrl.trim()) return
    setError('')
    setAdding(true)
    try {
      const result = await skillFetch<{success: boolean; registries: string[]; error?: string}>('/registries', {
        method: 'POST',
        body: JSON.stringify({ url: newUrl.trim() }),
      })
      if (result.registries) setRegistries(result.registries)
      setNewUrl('')
    } catch (err: any) {
      setError(err.message || 'Failed to add registry')
    } finally {
      setAdding(false)
    }
  }

  const handleRemove = async (url: string) => {
    try {
      const result = await skillFetch<{success: boolean; registries: string[]}>('/registries', {
        method: 'DELETE',
        body: JSON.stringify({ url }),
      })
      if (result.registries) setRegistries(result.registries)
    } catch (err) {
      console.error('Failed to remove registry:', err)
    }
  }

  if (loading) {
    return (
      <div className='flex items-center justify-center py-16'>
        <IconLoader2 size={20} className='animate-spin text-text-tertiary' />
      </div>
    )
  }

  return (
    <div className='p-4'>
      <p className='mb-4 text-caption leading-relaxed text-text-tertiary'>
        Registries are GitHub repositories that contain skill packages.
        LivHub fetches SKILL.md manifests from each registry's <code className='rounded bg-surface-2 px-1 py-0.5 text-caption-sm'>skills/</code> directory.
      </p>

      {/* Add registry form */}
      <div className='mb-5 flex gap-2'>
        <input
          type='text'
          value={newUrl}
          onChange={(e) => setNewUrl(e.target.value)}
          placeholder='https://github.com/user/repo'
          className='flex-1 rounded-radius-lg border border-border-default bg-surface-base py-2.5 px-3 text-body-sm text-text-primary placeholder-text-tertiary outline-none transition-colors focus-visible:border-brand focus-visible:ring-3 focus-visible:ring-brand/20'
          onKeyDown={(e) => e.key === 'Enter' && handleAdd()}
        />
        <button
          onClick={handleAdd}
          disabled={adding || !newUrl.trim()}
          className='flex items-center gap-1.5 rounded-radius-lg bg-brand px-4 py-2 text-body-sm font-medium text-white transition-all hover:bg-brand-lighter disabled:opacity-40'
        >
          {adding ? <IconLoader2 size={14} className='animate-spin' /> : <IconPlus size={14} />}
          Add
        </button>
      </div>

      {error && (
        <div className='mb-4 flex items-start gap-2 rounded-radius-lg bg-red-500/10 px-3 py-2.5 text-caption text-red-400'>
          <IconAlertCircle size={14} className='mt-0.5 flex-shrink-0' />
          <span>{error}</span>
        </div>
      )}

      {/* Registry list */}
      <div className='space-y-2'>
        {registries.length === 0 ? (
          <div className='py-8 text-center text-caption text-text-tertiary'>
            No registries configured. Add a GitHub repository URL above.
          </div>
        ) : (
          registries.map((url) => {
            // Parse owner/repo from URL
            const match = url.match(/github\.com\/([^/]+\/[^/]+)/)
            const repoName = match ? match[1] : url
            return (
              <div key={url} className='flex items-center gap-3 rounded-radius-lg border border-border-subtle bg-surface-base p-3 transition-all hover:border-border-default'>
                <div className='flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-radius-sm bg-surface-2'>
                  <IconDatabase size={14} className='text-text-tertiary' />
                </div>
                <div className='min-w-0 flex-1'>
                  <span className='text-body-sm font-medium text-text-primary'>{repoName}</span>
                  <p className='truncate text-caption-sm text-text-tertiary'>{url}</p>
                </div>
                <button
                  onClick={() => handleRemove(url)}
                  className='rounded-radius-sm p-1.5 text-text-tertiary transition-all hover:bg-red-500/10 hover:text-red-400'
                  title='Remove registry'
                >
                  <IconTrash size={15} />
                </button>
              </div>
            )
          })
        )}
      </div>
    </div>
  )
}
```

Import `IconPlus`, `IconDatabase` from @tabler/icons-react (add to existing imports).

5. **Wire RegistriesTab into the main panel:**
In the tab content section of SkillsPanel, add:
```tsx
{activeTab === 'registries' && <RegistriesTab />}
```

6. **Update the sidebar tab in index.tsx:**
In `livos/packages/ui/src/routes/ai-chat/index.tsx`, change the Skills tab label:
```tsx
{/* Old */}
<IconPuzzle size={14} />
Skills

{/* New */}
<IconPuzzle size={14} />
LivHub
```

This is in the `ConversationSidebar` component where the three tab buttons are rendered (Chat, MCP, Skills). Change "Skills" to "LivHub".

**Part C: tRPC routes.** The tRPC routes from Part A SHOULD be added to `routes.ts` as specified. The `skillFetch` helper in skills-panel.tsx hits `/api/skills/*` which is proxied to Nexus. The tRPC routes are also added for consistency and future consumers. Both approaches work — DO add the tRPC routes to routes.ts.
  </action>
  <verify>
1. Read skills-panel.tsx — confirm "LivHub" branding in header
2. Confirm three tabs: Marketplace, Installed, Registries
3. Confirm RegistriesTab has add/remove registry functionality
4. Confirm Refresh button exists in MarketplaceTab
5. Read index.tsx — confirm sidebar tab label says "LivHub" instead of "Skills"
6. Read api.ts — confirm /api/skills/registries GET/POST/DELETE and /api/skills/refresh POST endpoints
7. Read skill-registry-client.ts — confirm getRegistries() and removeRegistry() methods
  </verify>
  <done>LivHub marketplace has multi-registry management (add/remove Git repos), catalog refresh, LivHub branding, and three tabs (Marketplace, Installed, Registries). Skills can be browsed, installed with permission review, uninstalled, and the catalog refreshes from multiple registries.</done>
</task>

</tasks>

<verification>
1. Confirm LivHub branding: "LivHub" text appears in panel header and sidebar tab
2. Confirm multi-registry: User can add a GitHub URL, see it listed, remove it
3. Confirm refresh: Refresh button clears cache and re-fetches catalog
4. Confirm install/uninstall: Existing flow still works (permission dialog, install button, uninstall button)
5. Confirm Nexus endpoints: GET/POST/DELETE /api/skills/registries, POST /api/skills/refresh
</verification>

<success_criteria>
- LivHub branding replaces "Skills" in both the panel header and sidebar tab
- User can add multiple Git-based registries and remove them
- Registries persist across restarts (stored in Redis)
- Catalog refresh button clears cache and re-fetches from all registries
- Install/uninstall/permission review flow works unchanged
- Three tabs: Marketplace, Installed, Registries
</success_criteria>

<output>
After completion, create `.planning/phases/v2.0-p05-live-canvas-livhub/v2.0-05-04-SUMMARY.md`
</output>
