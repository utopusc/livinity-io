---
phase: v2.0-p05-live-canvas-livhub
plan: 02
subsystem: canvas-frontend
tags: [canvas, iframe, srcdoc, split-pane, react, tailwind, postMessage]
dependency-graph:
  requires:
    - v2.0-05-01 (CanvasManager, tRPC listCanvasArtifacts/getCanvasArtifact routes)
  provides:
    - CanvasIframe sandboxed renderer with CDN-loaded React/Babel/Tailwind/Mermaid/Recharts
    - CanvasPanel split-pane component with header, error bar, close/re-open
    - AI chat layout integration with conditional split-pane (desktop) and full overlay (mobile)
    - Canvas artifact polling during AI execution and one-time fetch on conversation load
  affects:
    - v2.0-05-03 (LivHub may need to reference canvas artifacts in skill context)
tech-stack:
  added: []
  patterns:
    - iframe srcdoc injection (no src URL) for sandboxed content rendering
    - postMessage protocol for cross-origin error reporting from iframe to parent
    - Lazy-loaded CanvasPanel with Suspense fallback
    - Split-pane layout via conditional flex widths (w-1/2 vs flex-1)
key-files:
  created:
    - livos/packages/ui/src/routes/ai-chat/canvas-iframe.tsx
    - livos/packages/ui/src/routes/ai-chat/canvas-panel.tsx
  modified:
    - livos/packages/ui/src/routes/ai-chat/index.tsx
decisions:
  - "srcdoc attribute used for iframe content injection (never src URL) — CANVAS-03 security"
  - "sandbox='allow-scripts allow-popups' with NO allow-same-origin — prevents iframe access to parent DOM/cookies/localStorage"
  - "CDN-loaded libraries inside iframe: React 18 + ReactDOM 18 + Babel standalone + Tailwind CSS + Mermaid + Recharts"
  - "Canvas artifact polling at 1s interval during isLoading, plus one-time fetch on conversation load for persistence"
  - "Desktop: 50/50 split-pane. Mobile: full-screen overlay with close button"
metrics:
  duration: 3min
  completed: 2026-02-21
---

# Phase 5 Plan 02: Canvas UI Summary

Split-pane CanvasPanel with sandboxed iframe renderer (srcdoc, CDN React/Babel/Tailwind/Mermaid/Recharts), postMessage error boundary, and responsive layout (desktop split-pane, mobile full overlay).

## What Was Built

### CanvasIframe (canvas-iframe.tsx)
- `buildSrcdoc()` function generates complete HTML documents for 5 content types: react, html, svg, mermaid, recharts
- React type: loads React 18 UMD + ReactDOM 18 UMD + Babel standalone, wraps content in `<script type="text/babel">`, auto-renders App or Main component
- HTML type: injects content directly, prepends Tailwind CSS CDN if not present
- SVG type: minimal centered HTML wrapper with dark background
- Mermaid type: loads Mermaid 10, initializes with dark theme, wraps content in `<pre class="mermaid">`
- Recharts type: same as react but adds Recharts UMD bundle and destructures all chart components as globals
- Error boundary: `window.onerror` and `window.onunhandledrejection` post errors to parent via `postMessage({type: 'canvas-error', ...})`
- Dark mode base style applied to all types: `body{margin:0;color:#e5e5e5;background:#0a0a0a}`
- iframe rendered with `sandbox="allow-scripts allow-popups"` (NO allow-same-origin)

### CanvasPanel (canvas-panel.tsx)
- Header bar with: cyan gradient icon, artifact title (truncated), type badge (color-coded per type), version badge (v1, v2, etc.), close button (IconX)
- Type color mapping: react=blue, html=emerald, svg=amber, mermaid=purple, recharts=cyan
- Full-height CanvasIframe below header fills remaining space
- Collapsible error bar at bottom: red background, alert icon, error text, dismiss button
- Error state passed as `onError` callback to CanvasIframe

### AI Chat Integration (index.tsx)
- `canvasArtifact` state: `{id, type, title, content, version} | null`
- `canvasMinimized` state: boolean for close/re-open toggle
- Two tRPC queries for canvas discovery:
  - `canvasQuery`: polls `listCanvasArtifacts` at 1s interval while `isLoading` is true
  - `canvasLoadQuery`: one-time fetch when loading existing conversation (staleTime 30s)
- Both queries update `canvasArtifact` with the most recent artifact (sorted by updatedAt desc from backend)
- Layout: chat area gets `w-1/2 min-w-[360px]` when canvas visible on desktop, `flex-1` otherwise
- Desktop: CanvasPanel rendered as `w-1/2 min-w-[360px]` split-pane alongside chat
- Mobile: CanvasPanel rendered as `fixed inset-0 z-50` full overlay
- Minimized state: floating button at top-right with cyan IconCode + artifact title, click to re-open
- Canvas cleared (`null`) and minimized reset (`false`) on new conversation
- CanvasPanel lazy-loaded with Suspense (spinner fallback on desktop, null on mobile)

## Decisions Made

1. **srcdoc over src URL**: Content injected via `srcdoc` attribute to avoid CORS issues and maintain the sandbox security model. The iframe never navigates to a URL.
2. **No allow-same-origin**: CANVAS-03 security requirement. The sandbox only permits `allow-scripts allow-popups`, preventing the iframe from accessing the parent's cookies, localStorage, and DOM.
3. **Dual polling strategy**: During AI execution, poll at 1s to catch new artifacts. On conversation load, do a one-time fetch to restore existing artifacts. This avoids continuous polling when idle.
4. **Desktop split-pane, mobile overlay**: On desktop, the chat and canvas each take 50% with 360px minimum width. On mobile, canvas shows as a full-screen overlay since split-pane would be too narrow.

## Deviations from Plan

None - plan executed exactly as written.

## Commits

| Hash | Description |
|------|-------------|
| fb9c0d4 | feat(v2.0-05-02): add CanvasIframe sandboxed renderer component |
| 4779c2f | feat(v2.0-05-02): add CanvasPanel split-pane and integrate into AI chat |

## Next Phase Readiness

Plan 03 (Agent prompting/tool integration) can proceed. The Canvas UI is ready to render any artifact the AI creates via `canvas_render` tool. The polling mechanism will automatically detect new artifacts during an AI conversation.
