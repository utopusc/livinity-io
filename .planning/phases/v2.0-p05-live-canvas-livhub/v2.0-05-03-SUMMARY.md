---
phase: v2.0-p05-live-canvas-livhub
plan: 03
subsystem: canvas-rendering
tags: [canvas, srcdoc, artifact-types, auto-detection, react, html, svg, mermaid, recharts, dark-theme]
dependency-graph:
  requires:
    - v2.0-05-01 (CanvasManager, tRPC routes)
    - v2.0-05-02 (CanvasIframe basic structure, CanvasPanel, AI chat integration)
  provides:
    - Production-quality per-type srcdoc templates with CDN dependencies and dark styling
    - Type auto-detection from artifact content (detectArtifactType)
    - Comprehensive canvas_render tool description with per-type examples for AI guidance
  affects:
    - v2.0-05-04 (LivHub may render canvas artifacts from skills)
tech-stack:
  added: []
  patterns:
    - Per-type builder functions (buildReactSrcdoc, buildHtmlSrcdoc, etc.) instead of monolithic switch
    - Content-based type detection with priority ordering (SVG > Mermaid > HTML > Recharts > React)
    - Mermaid themeVariables for consistent indigo dark-mode palette
key-files:
  created: []
  modified:
    - livos/packages/ui/src/routes/ai-chat/canvas-iframe.tsx
    - nexus/packages/core/src/daemon.ts
decisions:
  - "Per-type builder functions (not inline switch cases) for maintainability and readability"
  - "Type auto-detection priority: SVG (starts with <svg) > Mermaid (diagram keywords) > HTML (doctype/structural tags) > Recharts (component names) > React (default)"
  - "Mermaid themeVariables use indigo palette (#6366f1 primary, #1e1b4b backgrounds) matching LivOS design"
  - "HTML full-document detection: inject error boundary into existing <head> rather than re-wrapping"
  - "React/Recharts templates destructure hooks and chart components for cleaner AI-generated code"
metrics:
  duration: 3min
  completed: 2026-02-21
---

# Phase 5 Plan 03: Canvas Artifact Types Summary

Production-quality per-type srcdoc templates (React/HTML/SVG/Mermaid/Recharts) with enhanced dark-mode styling, content-based type auto-detection, and comprehensive tool description with inline examples for AI guidance.

## What Was Built

### Enhanced srcdoc Templates (canvas-iframe.tsx)

Refactored from inline switch cases to 5 dedicated builder functions:

**buildReactSrcdoc:** React 18 + Babel standalone + Tailwind CSS with `darkMode: 'class'` config. Destructures all common hooks (useState, useEffect, useRef, useMemo, useCallback, useReducer, useContext, createContext, Fragment). Auto-mounts App, Main, Dashboard, or Page component with descriptive error fallback.

**buildHtmlSrcdoc:** Detects full HTML documents (DOCTYPE/html/head+body) and injects error boundary into existing `<head>` rather than re-wrapping. Fragments get wrapped in full document with Tailwind and dark body class.

**buildSvgSrcdoc:** Centered flexbox layout with dark background. SVG gets responsive `max-width: 100%; max-height: 100vh; height: auto` for proper scaling.

**buildMermaidSrcdoc:** Mermaid 10 CDN with full `themeVariables` configuration: indigo palette (#6366f1 primary, #4f46e5 borders, #1e1b4b node/cluster backgrounds), dark mode enabled, system-ui font.

**buildRechartsSrcdoc:** React 18 + Recharts 2 UMD. Destructures 24 Recharts components as globals (LineChart, BarChart, PieChart, AreaChart, ScatterChart, ComposedChart, RadialBarChart, Treemap, Funnel, FunnelChart, and all axis/grid/tooltip components). Auto-mounts App, Main, Chart, or Dashboard.

### Shared Infrastructure

**BASE_STYLES:** Enhanced with `box-sizing: border-box`, `padding: 16px`, `line-height: 1.5`, custom webkit scrollbar styling (6px thin, semi-transparent thumb with hover state).

**ERROR_BOUNDARY_SCRIPT:** Enhanced to propagate stack traces via `err.stack` in both `window.onerror` and `window.onunhandledrejection`. Returns `true` from onerror to suppress default browser error logging.

### Type Auto-Detection (detectArtifactType)

New exported function that infers artifact type from content with priority ordering:
1. **SVG:** Content starts with `<svg` or `<?xml...<svg`
2. **Mermaid:** Content starts with diagram keywords (graph, flowchart, sequenceDiagram, classDiagram, erDiagram, gantt, pie, mindmap, timeline, gitGraph, C4Context, sankey, etc.)
3. **HTML:** Content starts with DOCTYPE/html or contains both `<head>` and `<body>` tags
4. **Recharts:** Content references Recharts-specific components (LineChart, BarChart, PieChart, ResponsiveContainer, etc.)
5. **React:** Default fallback (most common for AI-generated components)

CanvasIframe `type` prop made optional -- auto-detection kicks in when type is omitted.

### Enhanced Tool Description (daemon.ts)

`canvas_render` tool description expanded from 1-line summary to comprehensive multi-line documentation with:
- Per-type format specification (what to provide, what's available)
- Inline code examples for all 5 types
- Available libraries and component names per type
- Usage guidance for when to invoke the tool

`content` parameter description updated with explicit per-type format guidance and "Do NOT wrap in markdown code blocks" warning.

## Decisions Made

1. **Per-type builder functions:** Extracted 5 dedicated functions instead of keeping inline switch cases. Each function is independently readable and testable.
2. **Type detection priority:** SVG checked first (most specific: starts with `<svg`), Mermaid second (keyword prefix), HTML third (structural markers), Recharts fourth (component name presence), React as default. This ordering minimizes false positives.
3. **Mermaid indigo palette:** Theme variables use the indigo color family (#6366f1, #4f46e5, #1e1b4b) to match the LivOS design language rather than Mermaid's default dark theme colors.
4. **HTML full-doc injection:** When AI generates a complete HTML document, the error boundary is injected into the existing `<head>` tag rather than wrapping the entire content in another document. This preserves the AI's intended structure.
5. **Optional type prop:** Making type optional on CanvasIframe enables graceful handling of artifacts that arrive without explicit type metadata.

## Deviations from Plan

None -- plan executed exactly as written.

## Commits

| Hash | Description |
|------|-------------|
| 3af6cdd | feat(v2.0-05-03): enhance srcdoc templates and add type auto-detection |
| 2d5af6c | feat(v2.0-05-03): enhance canvas_render tool description with per-type examples |

## Next Phase Readiness

Plan 04 (LivHub) is already complete per STATE.md. All 4 plans in Phase 5 are now done. The canvas rendering pipeline is complete: CanvasManager stores artifacts (Plan 01), UI renders them in a split-pane (Plan 02), all 5 artifact types have production-quality templates with auto-detection (Plan 03), and LivHub skill registry is ready (Plan 04).
