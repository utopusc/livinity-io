---
phase: v2.0-p01-stability-security
plan: 04
subsystem: infra, ui
tags: [redis, usage-tracking, tokens, cost-estimation, ttfb, dashboard, commands]

# Dependency graph
requires:
  - phase: v2.0-01-01
    provides: "Redis circuit breaker, daemon stability"
  - phase: v2.0-01-03
    provides: "Command handler framework, slash commands infrastructure"
provides:
  - "UsageTracker class with Redis-backed session/daily/cumulative counters"
  - "/usage command with off/tokens/full/cost display modes"
  - "Usage API endpoints (summary, daily, overview)"
  - "Settings usage dashboard with daily charts"
  - "TTFB instrumentation in SdkAgentRunner"
affects: [v2.0-p03-session-compaction, v2.0-p06-polish]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Redis pipeline for atomic multi-counter increments"
    - "Cost stored as integer cents to avoid float precision"
    - "Daily rollup with 90-day TTL auto-cleanup"

key-files:
  created:
    - "nexus/packages/core/src/usage-tracker.ts"
    - "livos/packages/ui/src/routes/settings/usage-dashboard.tsx"
  modified:
    - "nexus/packages/core/src/sdk-agent-runner.ts"
    - "nexus/packages/core/src/daemon.ts"
    - "nexus/packages/core/src/index.ts"
    - "nexus/packages/core/src/commands.ts"
    - "nexus/packages/core/src/api.ts"
    - "nexus/packages/core/src/agent.ts"
    - "livos/packages/ui/src/routes/settings/_components/settings-content.tsx"
    - "livos/packages/livinityd/source/modules/ai/routes.ts"

key-decisions:
  - "Cost stored as integer cents in Redis to avoid float precision issues"
  - "Daily usage keys have 90-day TTL for automatic cleanup"
  - "Session snapshots stored with 24h TTL, last 100 tracked per user"
  - "Overview endpoint uses SCAN to aggregate across all users (not precached)"
  - "tRPC proxy routes added for dashboard instead of direct Nexus API fetch"

patterns-established:
  - "Usage tracking via UsageTracker.recordSession() after each agent run"
  - "Redis key pattern: nexus:usage:{scope}:{identifier} for usage data"

# Metrics
duration: 9min
completed: 2026-02-20
---

# Phase 1 Plan 4: Usage Tracking Summary

**Redis-backed token usage tracking with /usage command, TTFB instrumentation, usage API, and Settings dashboard with daily bar charts**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-20T21:37:24Z
- **Completed:** 2026-02-20T21:46:05Z
- **Tasks:** 2
- **Files modified:** 10

## Accomplishments
- UsageTracker class with session, daily, and cumulative Redis counters
- TTFB (time-to-first-byte) measurement in SdkAgentRunner
- /usage command with 4 display modes (off/tokens/full/cost)
- Usage API endpoints: summary, daily range, and overview
- Settings dashboard with overview cards, 30-day bar chart, activity table, and pricing reference
- tRPC proxy routes for seamless dashboard integration

## Task Commits

Each task was committed atomically:

1. **Task 1: UsageTracker class, TTFB instrumentation, and daemon wiring** - `281bb1c` (feat)
2. **Task 2: /usage command, API endpoints, and Settings dashboard** - `1f569b0` (feat)

## Files Created/Modified
- `nexus/packages/core/src/usage-tracker.ts` - UsageTracker class with all Redis operations and cost estimation
- `nexus/packages/core/src/sdk-agent-runner.ts` - Added TTFB measurement and tool call counting
- `nexus/packages/core/src/agent.ts` - Extended AgentResult with ttfbMs, toolCallCount, durationMs
- `nexus/packages/core/src/daemon.ts` - Wired UsageTracker recording after agent runs
- `nexus/packages/core/src/index.ts` - Initialize UsageTracker, pass to daemon and API
- `nexus/packages/core/src/commands.ts` - /usage command handler with display modes
- `nexus/packages/core/src/api.ts` - Usage API endpoints (summary, daily, overview)
- `livos/packages/livinityd/source/modules/ai/routes.ts` - tRPC proxy routes for usage API
- `livos/packages/ui/src/routes/settings/usage-dashboard.tsx` - Dashboard with charts and tables
- `livos/packages/ui/src/routes/settings/_components/settings-content.tsx` - Wired usage section into settings nav

## Decisions Made
- Cost is stored as integer cents in Redis (hincrby) to avoid float precision issues when accumulating
- Daily usage keys have a 90-day TTL so old data is automatically cleaned up
- Session snapshots use 24h TTL with a sorted set tracking last 100 sessions per user
- The overview endpoint uses Redis SCAN to aggregate across all user cumulative keys (acceptable for small user counts, could be pre-cached for scale)
- Added tRPC proxy routes in livinityd rather than direct Nexus API fetch for consistency with existing patterns

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added tRPC proxy routes for dashboard**
- **Found during:** Task 2 (Settings dashboard)
- **Issue:** Plan specified direct fetch to Nexus API, but the LivOS UI uses tRPC exclusively through livinityd proxying
- **Fix:** Added getUsageOverview, getUsageDaily, getUsageSummary tRPC routes in ai/routes.ts
- **Files modified:** livos/packages/livinityd/source/modules/ai/routes.ts
- **Verification:** TypeScript compiles, follows existing DM pairing proxy pattern
- **Committed in:** 1f569b0 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Necessary for correct UI integration. The dashboard would not have been able to fetch data without the tRPC proxy layer.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Usage tracking is fully wired and ready for production deployment
- Phase 1 (Stability & Security) is now complete with all 4 plans executed
- SDK token visibility in subscription mode should be verified during deployment (noted in STATE.md)

---
*Phase: v2.0-p01-stability-security*
*Completed: 2026-02-20*
