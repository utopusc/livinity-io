---
phase: v2.0-01-stability-security
plan: 01
subsystem: infra
tags: [circuit-breaker, bullmq, pm2, error-handling, redis, telegram, agent-turns]

# Dependency graph
requires: []
provides:
  - "CircuitBreaker class for Redis cascade failure prevention"
  - "Expanded global error handlers (12 recoverable patterns)"
  - "BullMQ cron queue replacing setTimeout-based scheduling"
  - "Telegram polling offset persistence to Redis"
  - "SdkAgentRunner turn cap (default 15, max 25)"
  - "PM2 ecosystem config with exponential backoff and kill timeout"
affects:
  - v2.0-01-02 (JWT auth hardening builds on stable process)
  - v2.0-01-03 (Telegram DM pairing requires stable Telegram polling)
  - v2.0-01-04 (Discord integration requires stable process)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "CircuitBreaker pattern (CLOSED/OPEN/HALF_OPEN) for external service resilience"
    - "BullMQ delayed jobs for cron scheduling instead of setTimeout"
    - "Redis-persisted polling offset for Telegram restart recovery"

key-files:
  created:
    - "nexus/packages/core/src/infra/circuit-breaker.ts"
  modified:
    - "nexus/packages/core/src/index.ts"
    - "nexus/packages/core/src/daemon.ts"
    - "nexus/packages/core/src/channels/telegram.ts"
    - "nexus/packages/core/src/sdk-agent-runner.ts"
    - "nexus/packages/core/src/infra/index.ts"
    - "nexus/deploy/ecosystem.config.cjs"

key-decisions:
  - "CircuitBreaker wraps error handling, not Redis connection itself (non-invasive)"
  - "BullMQ cron with setTimeout fallback for safety"
  - "Agent turn cap: default 15, hard max 25 (down from uncapped 30)"
  - "Used existing 'max_turns' stoppedReason instead of adding new 'turn_limit' type"

patterns-established:
  - "CircuitBreaker: CLOSED/OPEN/HALF_OPEN state machine for external service resilience"
  - "BullMQ delayed jobs for any future scheduled work (not setTimeout)"
  - "Redis-persisted state for restart recovery (polling offsets, etc.)"

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 1 Plan 1: Process Stability Hardening Summary

**CircuitBreaker for Redis, BullMQ cron replacement, 12-pattern exception recovery, Telegram offset persistence, and agent turn cap (15/25)**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T21:17:06Z
- **Completed:** 2026-02-20T21:21:40Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- nexus-core global error handlers now catch 12 recoverable exception patterns (up from 4), preventing unnecessary PM2 restarts
- Redis CircuitBreaker (CLOSED/OPEN/HALF_OPEN) prevents cascade crashes when Redis goes down temporarily
- Cron scheduling replaced from setTimeout (leaks on restart) to BullMQ delayed jobs (survive restarts)
- Telegram polling offset persisted to Redis and restored on restart for message continuity
- SdkAgentRunner capped at 15 turns default / 25 hard max, preventing runaway agent loops
- PM2 ecosystem config hardened with exponential backoff (100ms base), 5s kill timeout, 10s listen timeout

## Task Commits

Each task was committed atomically:

1. **Task 1: Global error handlers, Redis circuit breaker, and PM2 config** - `89bfa0f` (feat)
2. **Task 2: BullMQ cron replacement, grammy offset persistence, and agent turn cap** - `f02bb71` (feat)

## Files Created/Modified
- `nexus/packages/core/src/infra/circuit-breaker.ts` - CircuitBreaker class with CLOSED/OPEN/HALF_OPEN state machine
- `nexus/packages/core/src/infra/index.ts` - Added circuit-breaker export to barrel file
- `nexus/packages/core/src/index.ts` - Expanded recoverable patterns, integrated CircuitBreaker with Redis, added BullMQ cron queue/worker
- `nexus/packages/core/src/daemon.ts` - Replaced setTimeout cron handler with BullMQ delayed job, added cronQueue to DaemonConfig
- `nexus/packages/core/src/channels/telegram.ts` - Persist polling offset to Redis, restore on restart
- `nexus/packages/core/src/sdk-agent-runner.ts` - Turn cap (min of config/15, max 25), break loop on limit
- `nexus/deploy/ecosystem.config.cjs` - Added exp_backoff_restart_delay, kill_timeout, listen_timeout, autorestart

## Decisions Made
- CircuitBreaker wraps Redis error handling events rather than individual command calls -- non-invasive, no changes to existing Redis usage patterns
- BullMQ cron handler includes setTimeout fallback in case cronQueue is undefined (safety net for testing/development)
- Reused existing `max_turns` stoppedReason enum value rather than adding a new `turn_limit` type to avoid changing the AgentResult interface contract
- Agent turn cap set to 15 (not 10) to allow complex multi-tool tasks while preventing runaway loops

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required. Changes take effect on next deployment.

## Next Phase Readiness
- Process stability foundation is in place for all subsequent Phase 1 plans
- Ready for v2.0-01-02 (JWT auth hardening) -- stable process won't crash during auth setup
- Ready for v2.0-01-03 (Telegram DM pairing) -- Telegram polling offset now persisted
- Deployment note: PM2 ecosystem config changes require `pm2 delete nexus-core && pm2 start ecosystem.config.cjs --only nexus-core` to pick up new config fields

---
*Phase: v2.0-01-stability-security*
*Completed: 2026-02-20*
