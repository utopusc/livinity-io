---
phase: v2.0-p01-stability-security
plan: 02
subsystem: security
tags: [dm-pairing, activation-code, redis-allowlist, telegram, discord, express-api, trpc, settings-ui]

# Dependency graph
requires:
  - phase: v2.0-01-01
    provides: Process stability hardening (circuit breaker, BullMQ cron, error handlers)
provides:
  - DmPairingManager class with 4 DM policy modes
  - Activation code flow (6-digit, 1-hour TTL, max 3 pending per channel)
  - Redis-persisted allowlist for approved DM users
  - Admin approval/deny API endpoints (7 REST routes)
  - Settings UI for DM pairing management (pending/allowlist/policy tabs)
  - tRPC proxy routes for UI communication
affects:
  - v2.0-01-03 (rate limiting may interact with DM checks)
  - v2.0-01-04 (deployment needs new files)
  - Phase 3 (channel system enhancements)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "DM pairing check pattern: guard before message handler in channel providers"
    - "Redis SET for persistent allowlist, HASH for pending requests with TTL eviction"
    - "Policy-per-channel via Redis STRING (pairing/allowlist/open/disabled)"

key-files:
  created:
    - nexus/packages/core/src/dm-pairing.ts
    - livos/packages/ui/src/routes/settings/dm-pairing.tsx
  modified:
    - nexus/packages/core/src/channels/telegram.ts
    - nexus/packages/core/src/channels/discord.ts
    - nexus/packages/core/src/index.ts
    - nexus/packages/core/src/api.ts
    - livos/packages/ui/src/routes/settings/index.tsx
    - livos/packages/ui/src/routes/settings/_components/settings-content.tsx
    - livos/packages/livinityd/source/modules/ai/routes.ts

key-decisions:
  - "Default DM policy is 'pairing' (activation code flow) for maximum security"
  - "Max 3 pending activation codes per channel to prevent spam"
  - "Codes expire after 1 hour (automatic eviction on query)"
  - "DM pairing check runs AFTER dedup/stale filters but BEFORE AI handler"
  - "Group messages bypass DM pairing entirely (isGroup/isGuild guard)"

patterns-established:
  - "Channel provider DM guard: check policy before forwarding to message handler"
  - "setDmPairing() injection pattern for channel providers"
  - "tRPC proxy to Nexus REST API pattern for DM pairing endpoints"

# Metrics
duration: 10min
completed: 2026-02-20
---

# Phase 1 Plan 2: DM Pairing Security Summary

**DM pairing activation code flow with Redis allowlist, admin approval API, and Settings UI for Telegram/Discord DM access control**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-20T21:24:20Z
- **Completed:** 2026-02-20T21:34:00Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- DmPairingManager with 4 policy modes (pairing, allowlist, open, disabled) and Redis-backed persistence
- Unknown Telegram/Discord DM users get 6-digit activation code; message NOT forwarded to AI
- Admin approval API (7 REST endpoints) with tRPC proxy for UI
- Settings UI with 3 tabs: Pending requests (approve/deny), Allowlist (view/remove), Policy (per-channel config)
- Group messages bypass DM pairing entirely

## Task Commits

Each task was committed atomically:

1. **Task 1: DmPairingManager and channel integration** - `5efb2c5` (feat)
2. **Task 2: Admin approval API and Settings UI** - `9ff252c` (feat)

## Files Created/Modified
- `nexus/packages/core/src/dm-pairing.ts` - DmPairingManager class with activation code generation, Redis allowlist, policy management
- `nexus/packages/core/src/channels/telegram.ts` - DM pairing check before message handler
- `nexus/packages/core/src/channels/discord.ts` - DM pairing check before message handler
- `nexus/packages/core/src/index.ts` - Wire DmPairingManager, inject into providers and API server
- `nexus/packages/core/src/api.ts` - 7 REST endpoints for DM pairing CRUD operations
- `livos/packages/ui/src/routes/settings/dm-pairing.tsx` - Full DM pairing settings page with 3 tabs
- `livos/packages/ui/src/routes/settings/index.tsx` - Route registration for DM pairing page
- `livos/packages/ui/src/routes/settings/_components/settings-content.tsx` - DM Security menu item and section
- `livos/packages/livinityd/source/modules/ai/routes.ts` - 8 tRPC proxy routes for DM pairing

## Decisions Made
- Default DM policy is "pairing" (activation code flow) to maximize security out of the box
- Max 3 pending per channel prevents DM spam flooding the approval queue
- 1-hour TTL on activation codes with automatic eviction on query (lazy cleanup)
- DM check runs after dedup/stale filters (no wasted pairing checks on duplicates)
- Used `setDmPairing()` injection rather than constructor parameter to avoid breaking ChannelProvider interface

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added ApiDeps.dmPairingManager to api.ts early**
- **Found during:** Task 1 (wiring in index.ts)
- **Issue:** Passing dmPairingManager to createApiServer failed because ApiDeps interface didn't have it yet
- **Fix:** Added dmPairingManager to ApiDeps interface and createApiServer destructuring (planned for Task 2)
- **Files modified:** nexus/packages/core/src/api.ts
- **Verification:** `npx tsc --noEmit` passes
- **Committed in:** 5efb2c5 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor ordering change - ApiDeps update pulled from Task 2 into Task 1 for compilation. No scope creep.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required. DM pairing activates automatically when Telegram/Discord channels are connected.

## Next Phase Readiness
- DM pairing security active for all DM channels
- Ready for v2.0-01-03 (rate limiting / input validation)
- Ready for v2.0-01-04 (deployment)

---
*Phase: v2.0-p01-stability-security*
*Completed: 2026-02-20*
