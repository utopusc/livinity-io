---
phase: v2.0-p01-stability-security
verified: 2026-02-20T21:50:01Z
status: gaps_found
score: 22/25 must-haves verified
gaps:
  - truth: "/usage command shows current session and cumulative token counts (via Telegram/Discord)"
    status: failed
    reason: "processInboxItem() handles all Telegram/Discord messages. Its handleCommand() call at daemon.ts line 489 omits usageTracker. Users get: Usage tracking is not available."
    artifacts:
      - path: "nexus/packages/core/src/daemon.ts"
        issue: "handleCommand() at line 489 in processInboxItem() omits usageTracker from CommandContext. The cycle() path at line 292 passes it but handles mcp/cron/webhook, not Telegram/Discord."
    missing:
      - "Add usageTracker: this.config.usageTracker to handleCommand() CommandContext in processInboxItem() daemon.ts lines 489-498"

  - truth: "/usage cost shows estimated cost breakdown by model tier"
    status: partial
    reason: "/usage cost sets display mode and returns confirmation. It does not show a cost breakdown by tier. Main /usage calls estimateCost with hardcoded sonnet -- no haiku/sonnet/opus breakdown."
    artifacts:
      - path: "nexus/packages/core/src/commands.ts"
        issue: "handleUsage subcommand=cost only calls setDisplayMode. Main /usage calls estimateCost(sonnet,...) for total -- no per-model breakdown."
    missing:
      - "Show cost breakdown by tier: haiku / sonnet / opus estimates from cumulative token counts"
      - "estimateCost() already supports different model strings -- call it 3 times and display results"
---
# Phase 1: Stability and Security Verification Report

**Phase Goal:** The server runs reliably for days without crashing, unknown users cannot interact with the bot without activation, and every user has visibility into their token consumption and session control via chat commands
**Verified:** 2026-02-20T21:50:01Z
**Status:** gaps_found
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | nexus-core survives unhandled promise rejections without crashing | VERIFIED | process.on(unhandledRejection) at index.ts:38 logs and keeps process alive |
| 2 | nexus-core survives uncaught exceptions from known-recoverable errors | VERIFIED | 12 patterns: AbortError EPIPE ECONNREFUSED ERR_STREAM write-after-end Cannot-read-null ETIMEDOUT ENOTFOUND |
| 3 | setTimeout-based cron handler replaced with BullMQ repeatable job | VERIFIED | daemon.ts:662 uses cronQueue.add() with delay. cronWorker in index.ts processes jobs. |
| 4 | Redis connection failures do not crash the process | VERIFIED | CircuitBreaker at index.ts:78-92 hooks redis error/connect events. 153-line circuit-breaker.ts CLOSED/OPEN/HALF_OPEN |
| 5 | grammy Telegram polling offset is persisted to Redis and restored on restart | VERIFIED | Set at telegram.ts:103. Loaded at lines 189-196 into pollingOffset. |
| 6 | SdkAgentRunner stops after max 15 turns even if the SDK keeps running | VERIFIED | sdk-agent-runner.ts:155 Math.min(config ?? 15, 25). Lines 254-258: turns > maxTurns breaks loop. |
| 7 | PM2 config includes max_memory_restart and exponential backoff restart delay | VERIFIED | ecosystem.config.cjs: max_memory_restart 500M, exp_backoff_restart_delay 100, kill_timeout 5000 |
| 8 | Unknown Telegram DM user receives 6-digit code and message NOT processed by AI | VERIFIED | telegram.ts:140-157: !isGroup guard, replies and returns without calling messageHandler |
| 9 | Unknown Discord DM user receives 6-digit code and message NOT processed by AI | VERIFIED | discord.ts:120-137: same pattern with !isGuild guard |
| 10 | Activation codes expire after 1 hour | VERIFIED | dm-pairing.ts:24: CODE_TTL_SECONDS = 3600. Lazy eviction at multiple call sites. |
| 11 | Maximum 3 pending activation codes exist per channel at any time | VERIFIED | dm-pairing.ts:25: MAX_PENDING_PER_CHANNEL = 3. hlen check + evictExpiredPending. |
| 12 | Server owner can approve or deny pairing requests via Settings UI | VERIFIED | dm-pairing.tsx (414 lines) 3 tabs. 7 REST endpoints in api.ts. tRPC proxy confirmed. |
| 13 | Approved users stored in Redis allowlist that persists across restarts | VERIFIED | redis.sadd(allowlistKey, userId) at dm-pairing.ts:194. isAllowed() uses sismember. |
| 14 | DM policy configurable per channel: pairing allowlist open disabled | VERIFIED | DmPolicy type, getPolicy/setPolicy in Redis, Settings UI policy selector. |
| 15 | Group messages bypass the DM pairing check entirely | VERIFIED | telegram.ts:140: if (!isGroup). discord.ts:120: if (!isGuild). Guard is always negation of group flag. |
| 16 | /new resets current session and optionally switches model tier | VERIFIED | commands.ts:288-330: resetSession() + userSession.reset() + optional setModelTier() |
| 17 | /new responds with confirmation including the new model tier | VERIFIED | commands.ts:323-329 returns formatted confirmation with model tier. |
| 18 | /compact responds with stub message explaining future availability | VERIFIED | commands.ts:332-337: context compaction future update message |
| 19 | /activation toggles group trigger mode between mention and always | VERIFIED | commands.ts:341-391: writes Redis key. telegram.ts:126 and discord.ts:101 read it. |
| 20 | All new commands work identically via Telegram and Discord | VERIFIED | Both providers route through daemon.addToInbox() then handleCommand(). Channel-agnostic. |
| 21 | Commands are parsed before reaching the AI agent (zero token cost) | VERIFIED | daemon.ts:290-311 and 486-507: isCommand check before any agent call. On handled=true, exits. |
| 22 | Unrecognized commands still pass through to the AI agent | VERIFIED | commands.ts:124-127: default case returns null. Execution continues to agent. |
| 23 | Every agent session records input tokens, output tokens, turn count, and tool call count | VERIFIED | daemon.ts:1084-1098: usageTracker.recordSession() with all 4 fields |
| 24 | Per-user cumulative usage tracked in Redis with daily rollup | VERIFIED | usage-tracker.ts:148-171: daily HASH (90-day TTL) and cumulative HASH both incremented |
| 25 | /usage command shows current session and cumulative token counts | FAILED | processInboxItem() at daemon.ts:489 omits usageTracker. All Telegram/Discord users get not-available message. |
| 26 | /usage cost shows estimated cost breakdown by model tier | PARTIAL | /usage cost sets display mode only. /usage shows total via estimateCost(sonnet,...). No haiku/sonnet/opus breakdown. |
| 27 | /usage off hides display, /usage tokens shows minimal, /usage full shows everything | VERIFIED | commands.ts:460-472 mode validation. usage-tracker.ts:401-429 formatSummary respects displayMode. |
| 28 | Web UI Settings page shows usage dashboard with daily token consumption data | VERIFIED | usage-dashboard.tsx (309 lines): stat cards, 30-day bar chart, activity table. Wired in settings-content.tsx. |
| 29 | TTFB latency is tracked per agent request | VERIFIED | sdk-agent-runner.ts:229-270: ttfbMs from runStartTime to first text block. Recorded by usageTracker. |

**Score:** 22/25 truths fully verified (1 failed, 1 partial)

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| nexus/packages/core/src/infra/circuit-breaker.ts | CircuitBreaker class | VERIFIED | 153 lines, CLOSED/OPEN/HALF_OPEN, exported from infra/index.ts |
| nexus/packages/core/src/index.ts | Error handlers + CircuitBreaker wiring | VERIFIED | 12-pattern uncaughtException, CircuitBreaker on redis events |
| nexus/deploy/ecosystem.config.cjs | PM2 config | VERIFIED | exp_backoff_restart_delay: 100, max_memory_restart: 500M, kill_timeout: 5000 |
| nexus/packages/core/src/daemon.ts | BullMQ cron + UsageTracker | PARTIAL | cronQueue.add() verified. recordSession verified. usageTracker missing from processInboxItem handleCommand (gap). |
| nexus/packages/core/src/channels/telegram.ts | Offset persistence + DM guard | VERIFIED | Offset set at line 103, loaded at line 190. DM guard at lines 140-157. |
| nexus/packages/core/src/channels/discord.ts | DM pairing guard | VERIFIED | DM guard at lines 120-137 |
| nexus/packages/core/src/sdk-agent-runner.ts | Turn cap + TTFB | VERIFIED | Math.min(??15,25) at line 155. TTFB at lines 229-270. toolCallCount counted. |
| nexus/packages/core/src/dm-pairing.ts | DmPairingManager | VERIFIED | 260 lines, 4 policies, 6-digit codes, 1h TTL, max 3 pending |
| nexus/packages/core/src/commands.ts | /new /compact /activation /usage | VERIFIED | All 4 handlers present. /usage broken on Telegram/Discord path. |
| nexus/packages/core/src/usage-tracker.ts | UsageTracker class | VERIFIED | 430 lines, recordSession, daily rollup, cumulative, cost estimation, display mode |
| nexus/packages/core/src/api.ts | Usage API + DM pairing API | VERIFIED | /api/usage/* at 1049-1090. /api/dm-pairing/* 7 endpoints at 926-1045. |
| livos/packages/ui/src/routes/settings/dm-pairing.tsx | DM pairing Settings UI | VERIFIED | 414 lines, 3 tabs, approve/deny, policy selector |
| livos/packages/ui/src/routes/settings/usage-dashboard.tsx | Usage dashboard | VERIFIED | 309 lines, stat cards, bar chart, activity table, pricing reference |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| circuit-breaker.ts | index.ts Redis | error/connect events | WIRED | recordFailure() on error, recordSuccess() on connect |
| daemon.ts | usage-tracker.ts | recordSession after agent run | WIRED | line 1086: recordSession() with all metrics |
| sdk-agent-runner.ts | AgentResult | ttfbMs + toolCallCount + durationMs | WIRED | lines 329-335: all three fields in return value |
| daemon.ts cycle() | commands.ts /usage | usageTracker in CommandContext | WIRED | line 301 passes usageTracker to handleCommand |
| daemon.ts processInboxItem() | commands.ts /usage | usageTracker in CommandContext | NOT_WIRED | lines 489-498: usageTracker absent -- Telegram/Discord /usage broken |
| usage-dashboard.tsx | api.ts /api/usage | tRPC proxy ai/routes.ts | WIRED | getUsageOverview (line 1065) and getUsageDaily (line 1084) confirmed |
| dm-pairing.tsx | api.ts /api/dm-pairing | tRPC proxy ai/routes.ts | WIRED | DM pairing proxy routes confirmed in ai/routes.ts |
| daemon.ts cron handler | BullMQ cronQueue | cronQueue.add() with delay | WIRED | line 663, cronWorker in index.ts processes and calls daemon.addToInbox() |
| telegram.ts | dm-pairing.ts | !isGroup DM check | WIRED | lines 140-157 |
| discord.ts | dm-pairing.ts | !isGuild DM check | WIRED | lines 120-137 |

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| STAB-01 (unhandledRejection) | SATISFIED | -- |
| STAB-02 (uncaughtException recovery) | SATISFIED | -- |
| STAB-03 (BullMQ cron) | SATISFIED | -- |
| STAB-04 (Redis circuit breaker) | SATISFIED | -- |
| STAB-05 (grammy offset persistence) | SATISFIED | -- |
| STAB-06 (agent turn cap 15) | SATISFIED | -- |
| STAB-07 (PM2 config) | SATISFIED | -- |
| DM-01 (Telegram unknown user gets code) | SATISFIED | -- |
| DM-02 (Discord unknown user gets code) | SATISFIED | -- |
| DM-03 (1h code expiry) | SATISFIED | -- |
| DM-04 (max 3 pending) | SATISFIED | -- |
| DM-05 (admin approval via UI) | SATISFIED | -- |
| DM-06 (Redis allowlist persistence) | SATISFIED | -- |
| CMD-01 (/new with model) | SATISFIED | -- |
| CMD-02 (/compact stub) | SATISFIED | -- |
| CMD-03 (/activation) | SATISFIED | -- |
| CMD-04 (Telegram + Discord identical) | SATISFIED | -- |
| CMD-05 (zero token cost) | SATISFIED | -- |
| CMD-06 (unrecognized pass-through) | SATISFIED | -- |
| USAGE-01 (session recording) | SATISFIED | -- |
| USAGE-02 (daily rollup + cumulative) | SATISFIED | -- |
| USAGE-03 (/usage command) | BLOCKED | usageTracker missing from processInboxItem handleCommand call at daemon.ts:489 |
| USAGE-04 (/usage cost breakdown by tier) | PARTIAL | Total cost shown; no haiku/sonnet/opus tier breakdown |
| USAGE-05 (display modes off/tokens/full) | SATISFIED | -- |
| USAGE-06 (web dashboard) | SATISFIED | -- |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| nexus/packages/core/src/daemon.ts | 489-498 | usageTracker absent from processInboxItem handleCommand call | Blocker | /usage returns not-available for all Telegram/Discord users |
| nexus/packages/core/src/daemon.ts | 670-674 | setTimeout fallback in cron handler | Warning | Dead code path in production where cronQueue is always initialized |

### Human Verification Required

None required. All gaps are definitively confirmed by reading the source code directly.

### Gaps Summary

**Gap 1 -- BLOCKER: /usage command unavailable for all Telegram/Discord users**

Telegram and Discord messages go through processInboxItem() (daemon.ts line 456), selected by the realtimeSources check at line 437. Inside processInboxItem(), the handleCommand() call at line 489 does not include usageTracker in CommandContext. Every Telegram/Discord user typing /usage receives: Usage tracking is not available.

The cycle() path at line 292 does pass usageTracker but handles mcp, cron, webhook, and daemon sources only -- not Telegram or Discord.

Fix: add one field to the handleCommand CommandContext in processInboxItem (daemon.ts around line 494):
    usageTracker: this.config.usageTracker,

This is the only call site missing it. The fix is trivial and low-risk.

**Gap 2 -- MINOR: /usage cost does not show per-model-tier breakdown**

The plan specified /usage cost shows estimated cost breakdown by model tier. Current behavior:
- /usage cost: sets display mode to cost, returns mode-change confirmation
- /usage: shows cumulative total via estimateCost(sonnet,...) hardcoded to sonnet pricing

A model-tier breakdown would show: Haiku: 0.01 USD | Sonnet: 0.12 USD | Opus: 0.60 USD from the same cumulative token counts at each tier pricing. The estimateCost() function already accepts different model strings -- it needs to be called 3 times in handleUsage and the results displayed.

---

_Verified: 2026-02-20T21:50:01Z_
_Verifier: Claude (gsd-verifier)_
