---
phase: v2.0-01-stability-security
plan: 03
subsystem: api
tags: [commands, telegram, discord, redis, session-management, chat-commands]

# Dependency graph
requires:
  - phase: v2.0-01-01
    provides: "Stable daemon with session manager, Redis, and error handling"
provides:
  - "/new command for session reset with optional model switching"
  - "/compact stub command for future context compaction"
  - "/activation command for group trigger mode (mention/always)"
  - "Cross-channel activation mode support in Telegram and Discord providers"
affects: [v2.0-01-04, v2.0-p02-multi-model, v2.0-p03-context-memory]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Redis key pattern nexus:activation:{channelId} for per-channel activation mode"
    - "Command handlers receive sessionManager + redis for stateful operations"

key-files:
  created: []
  modified:
    - "nexus/packages/core/src/commands.ts"
    - "nexus/packages/core/src/daemon.ts"
    - "nexus/packages/core/src/channels/telegram.ts"
    - "nexus/packages/core/src/channels/discord.ts"

key-decisions:
  - "Activation mode stored as Redis key nexus:activation:{channelId} (not in channel config)"
  - "Default activation mode is 'mention' -- key is deleted when switching back to default"
  - "/new resets both conversation session (SessionManager) and user preferences (UserSessionManager)"

patterns-established:
  - "Redis key pattern: nexus:activation:{channelId} for per-channel settings"
  - "CommandContext extended with optional sessionManager, channelId, redis for cross-cutting commands"

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 1 Plan 3: Chat Commands Summary

**/new, /compact (stub), /activation commands with cross-channel activation mode in Telegram and Discord**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T21:25:19Z
- **Completed:** 2026-02-20T21:29:24Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Added /new command that resets conversation session + user preferences, optionally switches model tier
- Added /compact stub command pointing users to /new until context compaction ships
- Added /activation command to toggle group trigger mode between mention (default) and always
- Wired activation mode into TelegramProvider and DiscordProvider group message handlers
- Extended CommandContext with sessionManager, channelId, redis for stateful command operations
- Updated help text and listCommands() with all new commands

## Task Commits

Each task was committed atomically:

1. **Task 1: Add /new, /compact (stub), and /activation commands** - `ac83408` (feat)
2. **Task 2: Wire activation mode into channel message handlers** - `d67e2ce` (feat)

## Files Created/Modified
- `nexus/packages/core/src/commands.ts` - Added handleNew, handleCompact, handleActivation; extended CommandContext
- `nexus/packages/core/src/daemon.ts` - Pass sessionManager, redis, channelId to handleCommand in cycle() and processInboxItem()
- `nexus/packages/core/src/channels/telegram.ts` - Read activation mode from Redis before group mention check
- `nexus/packages/core/src/channels/discord.ts` - Read activation mode from Redis before guild mention check

## Decisions Made
- Activation mode stored in Redis (not channel config) because it's per-chat/channel, not per-provider instance
- Default mode is 'mention' -- when user sets 'mention', the Redis key is deleted (saves storage)
- /new resets both SessionManager (conversation context) and UserSessionManager (preferences), then optionally sets a new model tier
- /compact is a stub that guides users to /new until session compaction is implemented in Phase 3

## Deviations from Plan

None - plan executed exactly as written. The session-manager.ts already had `resetSession()` so no modification was needed (plan listed it as a modified file but the method was already present).

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All command infrastructure in place for Phase 1 completion
- Activation mode ready to be used by future multi-channel features
- /compact stub ready to be upgraded when session compaction ships in Phase 3

---
*Phase: v2.0-01-stability-security*
*Completed: 2026-02-20*
