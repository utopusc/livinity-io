---
phase: v1.5-04-websocket-gateway-hitl
plan: 02
type: execute
wave: 2
depends_on: ["v1.5-04-01"]
files_modified:
  - nexus/packages/core/src/ws-gateway.ts
  - nexus/packages/core/src/index.ts
autonomous: true

must_haves:
  truths:
    - "When an event is published to the nexus:notifications Redis pub/sub channel, all connected WebSocket clients receive it as a JSON-RPC notification"
    - "Server pushes agent lifecycle events (session started, completed, error) to all connected clients, not just the session owner"
    - "Notification push works for approval_request events (published by HITL system in Plan 03)"
    - "Clients can subscribe/unsubscribe to specific notification channels via JSON-RPC methods"
  artifacts:
    - path: "nexus/packages/core/src/ws-gateway.ts"
      provides: "Redis pub/sub subscription, notification fanout to connected clients, subscribe/unsubscribe methods"
      contains: "subscribe"
    - path: "nexus/packages/core/src/index.ts"
      provides: "Redis subscriber connection passed to WsGateway"
      contains: "redisSub"
  key_links:
    - from: "nexus/packages/core/src/ws-gateway.ts"
      to: "Redis pub/sub"
      via: "ioredis subscriber connection"
      pattern: "subscribe|psubscribe"
    - from: "nexus/packages/core/src/ws-gateway.ts"
      to: "Connected WebSocket clients"
      via: "JSON-RPC notification broadcast"
      pattern: "method.*notify|broadcast"
---

<objective>
Add server-initiated notification push to the WebSocket gateway. The gateway subscribes to Redis pub/sub channels and forwards events to all connected WebSocket clients as JSON-RPC notifications. This is the transport layer for real-time events like agent completions, system alerts, and (in Plan 03/04) tool approval requests.

Purpose: Clients need to receive events they did not explicitly request — approval prompts, system notifications, and status updates from background tasks. Redis pub/sub is already the event bus; this plan bridges it to WebSocket clients.

Output: Updated `ws-gateway.ts` with pub/sub subscription and notification broadcast. Updated `index.ts` to provide a Redis subscriber connection.
</objective>

<execution_context>
@C:\Users\hello\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\hello\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v1.5-04-websocket-gateway-hitl/v1.5-04-01-SUMMARY.md

Key source files:
@nexus/packages/core/src/ws-gateway.ts (from Plan 01 — WsGateway class to extend)
@nexus/packages/core/src/index.ts (needs Redis subscriber connection)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Redis pub/sub subscription and notification broadcast to WsGateway</name>
  <files>nexus/packages/core/src/ws-gateway.ts</files>
  <action>
**Extend WsGateway to accept a Redis subscriber connection:**

Add to the WsGatewayDeps interface:
```typescript
redisSub: Redis; // Dedicated Redis connection for blocking subscribe
```

**Notification channels:**
Define the pub/sub channels the gateway subscribes to:
- `nexus:notify:global` — broadcast to ALL connected clients
- `nexus:notify:agent:<sessionId>` — targeted to session owner
- `nexus:notify:approval` — tool approval requests (consumed by Plan 03/04)

Use Redis `psubscribe('nexus:notify:*')` pattern subscription so the gateway catches all notification channels with one subscription.

**Notification format:**
Messages published to Redis should be JSON strings with this structure:
```typescript
interface NotificationPayload {
  channel: string;       // "global", "agent:<sessionId>", "approval"
  event: string;         // "agent.started", "agent.completed", "approval_request", etc.
  data: unknown;         // Event-specific payload
  timestamp: number;
}
```

**Broadcast logic:**
On receiving a pub/sub message:
1. Parse the Redis channel name to extract the notification type
2. For `nexus:notify:global` — send to ALL connected clients
3. For `nexus:notify:agent:<sessionId>` — find the client that owns that session, send only to them
4. For `nexus:notify:approval` — send to ALL connected clients (any can approve)

Send as JSON-RPC notification (no id field):
```json
{ "jsonrpc": "2.0", "method": "notify", "params": { "channel": "...", "event": "...", "data": {...}, "timestamp": ... } }
```

**Client subscription control (optional methods):**
Add two new JSON-RPC methods:
- `notify.subscribe` params: `{ channels: string[] }` — client registers interest in specific channels (e.g., ["approval"]). Default: subscribed to everything.
- `notify.unsubscribe` params: `{ channels: string[] }` — client stops receiving specific channels.

Store per-client subscription filter as a `Set<string>` on the client connection. If the set is empty, receive all. If non-empty, only receive matching channels.

**Cleanup:**
On gateway stop/shutdown, unsubscribe from Redis pub/sub and close the subscriber connection.

**Also: publish agent lifecycle events from existing agent.run handler:**
When an agent session starts, publish to `nexus:notify:global`:
```json
{ "channel": "global", "event": "agent.started", "data": { "sessionId": "...", "task": "..." }, "timestamp": ... }
```
When complete:
```json
{ "channel": "global", "event": "agent.completed", "data": { "sessionId": "...", "success": true }, "timestamp": ... }
```
Use the `deps.redis` (non-subscriber) connection for publishing.
  </action>
  <verify>
Run `npx tsc --noEmit` in nexus/packages/core — zero TypeScript errors.
Grep for `psubscribe` in ws-gateway.ts — should exist.
Grep for `nexus:notify` in ws-gateway.ts — should appear in subscribe and publish calls.
  </verify>
  <done>
WsGateway subscribes to `nexus:notify:*` via Redis pub/sub. Notifications are broadcast to connected clients as JSON-RPC notifications. Agent lifecycle events (started, completed) are published. Per-client channel filtering is supported via notify.subscribe/unsubscribe methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Redis subscriber connection into WsGateway in index.ts</name>
  <files>nexus/packages/core/src/index.ts</files>
  <action>
**In index.ts:**

1. Create a dedicated Redis subscriber connection (Redis connections used for subscribe cannot be used for other commands):
```typescript
const redisSub = redis.duplicate();
```

2. Pass it to the WsGateway setup:
```typescript
const wsGateway = setupWsGateway(httpServer, { brain, toolRegistry, daemon, redis, redisSub });
```

3. Update the shutdown handler to clean up:
```typescript
// In shutdown():
wsGateway.stop(); // This should unsubscribe and close
await redisSub.quit().catch(() => {});
```

4. If `setupWsGateway` in api.ts needs the redisSub parameter, update its signature accordingly. The WsGatewayDeps interface was updated in Task 1, so the api.ts `setupWsGateway` function just needs to pass it through.

NOTE: The existing `inboxRedis` connection is already a `redis.duplicate()` for BLPOP. This is the same pattern — a dedicated connection for blocking Redis operations.
  </action>
  <verify>
Run `npx tsc --noEmit` in nexus/packages/core — zero TypeScript errors.
Grep for `redisSub` in index.ts — should appear in duplicate(), setupWsGateway call, and shutdown.
  </verify>
  <done>
Redis subscriber connection created and passed to WsGateway. Shutdown handler cleans up subscriber. Gateway can now receive pub/sub notifications and forward to WebSocket clients.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. WsGateway subscribes to `nexus:notify:*` pattern
3. NotificationPayload interface is defined
4. Per-client channel filtering works (subscribe/unsubscribe methods)
5. Agent lifecycle events are published to `nexus:notify:global`
6. Redis subscriber connection is properly created and cleaned up in index.ts
</verification>

<success_criteria>
- Server can push real-time notifications to connected WebSocket clients
- Notifications use JSON-RPC 2.0 format (no id field)
- Redis pub/sub is the event bus — any part of the system can publish to `nexus:notify:*`
- Clients can filter which notification channels they receive
- Gateway shutdown properly cleans up Redis subscriptions
</success_criteria>

<output>
After completion, create `.planning/phases/v1.5-04-websocket-gateway-hitl/v1.5-04-02-SUMMARY.md`
</output>
