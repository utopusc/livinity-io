---
phase: v1.5-04
plan: 02
subsystem: nexus-core
tags: [websocket, redis-pubsub, notifications, json-rpc, real-time]

dependency_graph:
  requires:
    - phase: v1.5-04-01
      provides: WsGateway class with JSON-RPC 2.0 protocol, auth, and session management
  provides:
    - redis-pubsub-notification-push
    - notification-channel-filtering
    - agent-lifecycle-events
    - publishNotification-api
  affects: [v1.5-04-03, v1.5-04-04]

tech_stack:
  added: []
  patterns: [redis-psubscribe-pattern-routing, per-client-notification-filtering, pub-sub-event-bus]

key_files:
  created: []
  modified:
    - nexus/packages/core/src/ws-gateway.ts
    - nexus/packages/core/src/index.ts
    - nexus/packages/core/src/api.ts

key_decisions:
  - "Redis psubscribe('nexus:notify:*') pattern subscription catches all notification channels with one subscription"
  - "Three channel routing patterns: global (all clients), approval (all clients), agent:<sessionId> (targeted)"
  - "Empty per-client notifyFilter Set means receive everything (opt-in filtering, not opt-out)"

patterns_established:
  - "Notification bus: any system component publishes to nexus:notify:<channel> and WsGateway routes to clients"
  - "publishNotification(channel, event, data) as the public API for emitting real-time events"

duration: ~4min
completed: 2026-02-15
---

# Phase 4 Plan 02: Notification Push via Redis Pub/Sub Summary

**Redis pub/sub notification fanout to WebSocket clients with pattern routing (global/approval/targeted) and per-client channel filtering**

## Performance

- **Duration:** ~4 min
- **Started:** 2026-02-15T11:03:23Z
- **Completed:** 2026-02-15T11:07:00Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- WsGateway subscribes to `nexus:notify:*` via Redis psubscribe and forwards messages as JSON-RPC notifications
- Three routing patterns: `nexus:notify:global` broadcasts to all, `nexus:notify:approval` broadcasts to all (any can approve), `nexus:notify:agent:<sessionId>` targets session owner
- Per-client notification filtering via `notify.subscribe` and `notify.unsubscribe` JSON-RPC methods (empty filter = receive all)
- Agent lifecycle events (`agent.started`, `agent.completed`, `agent.error`) published to `nexus:notify:global` on every agent session
- `publishNotification()` public method on WsGateway for any component to emit real-time events

## Task Commits

1. **Task 1: Add Redis pub/sub subscription and notification broadcast to WsGateway** - `ae78e15` (feat)
2. **Task 2: Wire Redis subscriber connection into WsGateway in index.ts** - `ac4cee1` (feat)

## Files Created/Modified

- `nexus/packages/core/src/ws-gateway.ts` - Added redisSub dep, NotificationPayload interface, psubscribe setup, broadcast/targeted routing, per-client filtering, notify.subscribe/unsubscribe methods, agent lifecycle publishing, cleanup on stop
- `nexus/packages/core/src/index.ts` - Created redisSub via redis.duplicate(), passed to WsGateway, added cleanup in shutdown
- `nexus/packages/core/src/api.ts` - Added approvalManager to ApiDeps interface (blocking TS fix from Plan 03)

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| NOTIFY-01 | psubscribe pattern `nexus:notify:*` | Single subscription catches all notification channels; avoids maintaining explicit channel list |
| NOTIFY-02 | Three routing patterns (global, approval, agent:sessionId) | Global for broadcast, approval for HITL (Plan 03/04), targeted for session-specific events |
| NOTIFY-03 | Empty notifyFilter = receive all | Clients get everything by default; opt-in filtering via subscribe/unsubscribe avoids missing events |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed ApiDeps interface missing approvalManager**
- **Found during:** Task 2 (TypeScript compilation)
- **Issue:** Plan 03 added `approvalManager` to the `createApiServer()` call in index.ts but didn't update the `ApiDeps` interface in api.ts, causing TS2353
- **Fix:** Added `approvalManager?: ApprovalManager` to ApiDeps interface and imported the type
- **Files modified:** nexus/packages/core/src/api.ts
- **Verification:** `npx tsc --noEmit` passes with zero errors
- **Committed in:** ac4cee1 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Pre-existing TypeScript error from Plan 03 that blocked compilation. No scope creep.

## Issues Encountered

None beyond the pre-existing ApiDeps type error.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Plan 03 (HITL approval protocol) can now publish `approval_request` events to `nexus:notify:approval` and they will be delivered to all connected WebSocket clients. The `publishNotification()` method on WsGateway provides the emit API, and the `approval.respond` method (added in Plan 03) can be routed through the existing method switch.

Plan 04 (frontend integration) has the JSON-RPC notification format to consume: `{ jsonrpc: "2.0", method: "notify", params: { channel, event, data, timestamp } }`.

No blockers.

---
*Phase: v1.5-04-websocket-gateway-hitl*
*Completed: 2026-02-15*
