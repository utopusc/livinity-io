---
phase: v1.5-04-websocket-gateway-hitl
plan: 04
subsystem: agent-hitl
tags: [hitl, approval, api, audit-trail, config, wiring]

dependency_graph:
  requires: [v1.5-04-01, v1.5-04-03]
  provides: [approval-api-endpoints, approval-audit-trail, approval-config, hitl-wiring]
  affects: []

tech_stack:
  added: []
  patterns: [redis-sorted-set-audit, approval-policy-config, multi-channel-approval-resolve]

key_files:
  created: []
  modified:
    - nexus/packages/core/src/config/schema.ts
    - nexus/packages/core/src/api.ts
    - nexus/packages/core/src/daemon.ts
    - nexus/packages/core/src/index.ts
    - nexus/packages/core/src/ws-gateway.ts
    - nexus/packages/core/src/approval-manager.ts

decisions:
  - id: HITL-AUDIT-STORE
    description: "Redis sorted set (ZADD scored by timestamp) for audit trail, trimmed to 1000 entries"
  - id: HITL-API-ORDER
    description: "Express route /api/approvals/audit defined before /api/approvals/:id to avoid param collision"
  - id: HITL-DESTRUCTIVE-TOOLS
    description: "Only shell tool marked requiresApproval (shell can run arbitrary commands including rm, kill, etc.)"
  - id: HITL-SSE-APPROVAL
    description: "SSE streaming AgentLoop also gets approvalManager wiring for consistent approval behavior"

metrics:
  duration: ~6min
  completed: 2026-02-15
---

# Phase 4 Plan 04: HITL Wiring -- API Endpoints, Audit Trail, Config, and Tool Marking

**Approval HTTP/WS API endpoints, Redis sorted-set audit trail, NexusConfig approval policy schema, and full ApprovalManager wiring across all agent entry points.**

## Performance

- **Duration:** ~6 min
- **Started:** 2026-02-15T11:04:22Z
- **Completed:** 2026-02-15T11:10:11Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments

- NexusConfig now has user-configurable approval policy (always/destructive/never) with timeout and audit toggle
- Four HTTP API endpoints for listing, viewing, resolving, and auditing approval requests
- WebSocket gateway supports `approval.resolve` JSON-RPC method for real-time approval from WS clients
- ApprovalManager wired into all three agent entry points (daemon inbox, SSE stream, WebSocket gateway)
- Shell tool marked with `requiresApproval: true` for destructive command gating
- Redis sorted-set audit trail with reverse-chronological query and 1000-entry cap

## Task Commits

Each task was committed atomically:

1. **Task 1: Add approval policy to NexusConfig, wire ApprovalManager, mark destructive tools** - `296dc9c` (feat)
2. **Task 2: Add approval HTTP API endpoints and audit trail** - `04eab7a` (feat)

## Files Created/Modified

- `nexus/packages/core/src/config/schema.ts` - Added ApprovalPolicySchema, ApprovalConfigSchema, ApprovalConfig type, and default values
- `nexus/packages/core/src/daemon.ts` - Added ApprovalManager to DaemonConfig, getter, approval wiring in both AgentLoop constructors, shell tool marking
- `nexus/packages/core/src/index.ts` - ApprovalManager instantiation, passed to Daemon and createApiServer (applied via external sync)
- `nexus/packages/core/src/api.ts` - Four approval API endpoints, approvalManager destructured and wired into SSE AgentLoop
- `nexus/packages/core/src/ws-gateway.ts` - approval.resolve method handler, approval wiring in WS AgentLoop
- `nexus/packages/core/src/approval-manager.ts` - logAudit(), getAuditTrail() methods, AUDIT_KEY constant, updateRequestStatus calls logAudit

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| HITL-AUDIT-STORE | Redis sorted set (ZADD) for audit trail, scored by timestamp | Natural chronological ordering, efficient range queries with ZREVRANGE, auto-cleanup via ZREMRANGEBYRANK |
| HITL-API-ORDER | /api/approvals/audit before /api/approvals/:id | Express treats "audit" as an :id param if the parameterized route is registered first |
| HITL-DESTRUCTIVE-TOOLS | Only shell tool marked requiresApproval | Shell is the primary destructive tool (runs arbitrary commands); Docker/MCP tools are handled separately |
| HITL-SSE-APPROVAL | SSE streaming endpoint also gets approval wiring | Ensures consistent approval behavior regardless of how agent is invoked (inbox, SSE, or WebSocket) |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added approval wiring to SSE agent endpoint in api.ts**
- **Found during:** Task 1
- **Issue:** Plan only specified wiring for daemon.ts and ws-gateway.ts AgentLoop instances, but api.ts also creates AgentLoop for SSE streaming
- **Fix:** Added approvalManager, approvalPolicy, and sessionId to the SSE agent in api.ts
- **Files modified:** nexus/packages/core/src/api.ts
- **Verification:** TypeScript compilation passes, all agent entry points now have approval support
- **Committed in:** 296dc9c (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Essential for consistent approval behavior across all agent invocation methods. No scope creep.

## Issues Encountered

None -- index.ts changes had been partially applied by an external sync process, but all changes were correctly present and committed.

## Next Phase Readiness

Phase 4 (WebSocket Gateway + HITL) is now complete. All four plans delivered:
- Plan 01: WebSocket gateway with JSON-RPC 2.0, JWT auth, multiplexed sessions
- Plan 02: Pub/sub notification broadcasting, notify.subscribe/unsubscribe
- Plan 03: ApprovalManager, tool approval metadata, agent loop gate
- Plan 04: API endpoints, audit trail, config schema, full wiring

The full HITL pipeline is operational:
1. Agent calls destructive tool (e.g., shell)
2. Approval request created in Redis, published to nexus:notify:approval
3. WebSocket clients receive approval_request notification
4. User resolves via HTTP API (POST /api/approvals/:id/resolve) or WebSocket (approval.resolve)
5. Agent receives decision via BLPOP, proceeds or adapts
6. Audit trail entry logged to Redis sorted set

No blockers for Phase 5.

---
*Phase: v1.5-04-websocket-gateway-hitl*
*Completed: 2026-02-15*
