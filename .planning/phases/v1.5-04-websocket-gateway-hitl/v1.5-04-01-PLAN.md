---
phase: v1.5-04-websocket-gateway-hitl
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/core/src/ws-gateway.ts
  - nexus/packages/core/src/api.ts
  - nexus/packages/core/src/auth.ts
autonomous: true

must_haves:
  truths:
    - "A WebSocket client can connect to /ws/agent with a valid API key or JWT and receive a connection acknowledgement"
    - "Client sends a JSON-RPC 2.0 request with method 'agent.run' and receives streaming results tagged with a session ID"
    - "Client can send 'tools.list' and receive all registered tool names and descriptions"
    - "Client can run multiple agent tasks concurrently over a single WebSocket connection, each tagged by session ID"
    - "Client can cancel a running agent task by session ID"
    - "Invalid auth on upgrade returns 401 and closes the connection"
  artifacts:
    - path: "nexus/packages/core/src/ws-gateway.ts"
      provides: "JSON-RPC 2.0 WebSocket gateway with auth, method routing, and multiplexed sessions"
      min_lines: 200
    - path: "nexus/packages/core/src/api.ts"
      provides: "Updated to use new WsGateway instead of old setupWebSocket"
      contains: "WsGateway"
    - path: "nexus/packages/core/src/auth.ts"
      provides: "JWT verification for WebSocket upgrade"
      contains: "verifyJwt"
  key_links:
    - from: "nexus/packages/core/src/ws-gateway.ts"
      to: "nexus/packages/core/src/agent.ts"
      via: "AgentLoop instantiation for agent.run method"
      pattern: "new AgentLoop"
    - from: "nexus/packages/core/src/ws-gateway.ts"
      to: "nexus/packages/core/src/auth.ts"
      via: "Auth check on WebSocket upgrade"
      pattern: "verifyAuth|verifyJwt|requireApiKey"
    - from: "nexus/packages/core/src/api.ts"
      to: "nexus/packages/core/src/ws-gateway.ts"
      via: "Gateway creation and attachment to HTTP server"
      pattern: "WsGateway"
---

<objective>
Build a JSON-RPC 2.0 WebSocket gateway that replaces the existing bare `setupWebSocket` function. The gateway authenticates clients on connection upgrade (API key header or JWT), routes JSON-RPC methods to handlers, and supports multiplexed concurrent agent sessions over a single connection.

Purpose: External clients (frontends, CLIs, other services) need a standardized protocol to interact with the Nexus AI agent. JSON-RPC 2.0 gives us request/response correlation, error codes, and server-initiated notifications — all over a single WebSocket connection.

Output: `ws-gateway.ts` module, updated `api.ts` wiring, and JWT verification in `auth.ts`.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@nexus/packages/core/src/api.ts (existing setupWebSocket to replace, createApiServer for wiring)
@nexus/packages/core/src/auth.ts (existing requireApiKey middleware — add JWT verification)
@nexus/packages/core/src/agent.ts (AgentLoop + AgentEvent + AgentConfig + AgentResult)
@nexus/packages/core/src/tool-registry.ts (ToolRegistry — tools.list needs this)
@nexus/packages/core/src/types.ts (Tool interface)
@nexus/packages/core/src/providers/types.ts (ClaudeToolDefinition)
@nexus/packages/core/src/config/schema.ts (NexusConfig for agent defaults)
@nexus/packages/core/src/index.ts (where setupWebSocket is called — needs update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ws-gateway.ts with JSON-RPC 2.0 framing, auth, and session management</name>
  <files>nexus/packages/core/src/ws-gateway.ts, nexus/packages/core/src/auth.ts</files>
  <action>
Create `nexus/packages/core/src/ws-gateway.ts`:

**JSON-RPC 2.0 Protocol:**
```typescript
// Request: { jsonrpc: "2.0", method: string, params?: object, id: string | number }
// Response: { jsonrpc: "2.0", result?: any, error?: { code: number, message: string, data?: any }, id: string | number }
// Notification (server->client): { jsonrpc: "2.0", method: string, params?: object } (no id)
```

Standard error codes:
- -32700: Parse error
- -32600: Invalid Request
- -32601: Method not found
- -32602: Invalid params
- -32603: Internal error

Custom error codes:
- -32000: Auth error
- -32001: Session not found
- -32002: Session limit exceeded

**WsGateway class:**

```typescript
interface WsGatewayDeps {
  brain: Brain;
  toolRegistry: ToolRegistry;
  daemon: Daemon;
  redis: Redis;
}

interface WsSession {
  id: string;
  agent: AgentLoop;
  status: 'running' | 'complete' | 'cancelled' | 'error';
  startedAt: number;
  task: string;
}

class WsGateway {
  private wss: WebSocketServer;
  private sessions: Map<string, Map<string, WsSession>>; // clientId -> sessionId -> WsSession
  private maxSessionsPerClient = 5;

  constructor(server: Server, deps: WsGatewayDeps) { ... }
  // On 'upgrade': verify auth (API key from header OR JWT from query ?token=xxx or Sec-WebSocket-Protocol)
  // On 'connection': send { jsonrpc: "2.0", method: "connected", params: { clientId } }
  // On 'message': parse JSON-RPC, route to handler
  // On 'close': cleanup sessions for that client
}
```

**Authentication on upgrade:**
Before accepting the WebSocket connection, check:
1. `X-API-Key` header (same logic as existing `requireApiKey`)
2. OR `?token=<jwt>` query parameter (decode JWT, verify signature with `/data/secrets/jwt`, check `{loggedIn: true}`)
3. If neither valid, reject with 401

In `auth.ts`, add a `verifyJwt(token: string): Promise<boolean>` function:
- Read JWT secret from `/data/secrets/jwt` file (cache it in memory on first read)
- Verify using `jsonwebtoken` library (already a dependency via jose/jsonwebtoken check — if not available, use Node's `crypto.createHmac` with HS256 manually)
- Check payload has `{loggedIn: true}`
- Return boolean
- NOTE: First check if `jsonwebtoken` is already installed. If not, use a simple manual HS256 JWT verify (split token, verify HMAC-SHA256 signature, decode payload). This avoids adding dependencies.

Also add `verifyApiKey(key: string): boolean` function that extracts the timing-safe comparison logic from the existing middleware into a reusable function. The middleware should call this function internally.

**Method routing:**
Route incoming JSON-RPC methods to handler functions:
- `agent.run` -> start a new agent session
- `agent.cancel` -> cancel a running session
- `tools.list` -> return registered tools
- `system.ping` -> return pong (keepalive)

**Session management (multiplexed):**
Each `agent.run` request creates a session with a unique ID (use `crypto.randomUUID()`). The client provides an optional `sessionId` in params, or one is auto-generated. All events for that session include the sessionId in the response.

`agent.run` params: `{ task: string, sessionId?: string, maxTurns?: number, tier?: string }`
- Creates AgentLoop with NexusConfig from daemon
- Attaches event listener that forwards AgentEvent as JSON-RPC notifications:
  `{ jsonrpc: "2.0", method: "agent.event", params: { sessionId, event: AgentEvent } }`
- On completion, sends JSON-RPC result:
  `{ jsonrpc: "2.0", result: { sessionId, ...AgentResult }, id: <original request id> }`

`agent.cancel` params: `{ sessionId: string }`
- Sets a `cancelled` flag on the session
- The AgentLoop doesn't have native cancellation, so set `session.status = 'cancelled'` and the event listener stops forwarding events. The agent run promise is allowed to complete naturally but results are discarded.

`tools.list` params: none
- Returns `{ tools: Array<{ name, description, parameters }> }` from ToolRegistry

`system.ping` params: none
- Returns `{ pong: true, timestamp: Date.now() }`

**Connection lifecycle:**
- On disconnect, mark all client sessions as cancelled and clean up
- Emit heartbeat pings every 30s using WebSocket ping frames (ws library handles this)

**Error handling:**
All errors wrapped in JSON-RPC error responses with appropriate codes.
  </action>
  <verify>
Run `npx tsc --noEmit` in nexus/packages/core — zero TypeScript errors.
Manually verify the file exists and contains the WsGateway class, JSON-RPC types, and method handlers.
  </verify>
  <done>
ws-gateway.ts exports WsGateway class. auth.ts exports verifyJwt and verifyApiKey. JSON-RPC 2.0 message types are defined. Method routing covers agent.run, agent.cancel, tools.list, system.ping. Session management supports multiple concurrent sessions per client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WsGateway into api.ts and index.ts, remove old setupWebSocket</name>
  <files>nexus/packages/core/src/api.ts, nexus/packages/core/src/index.ts</files>
  <action>
**In api.ts:**
1. Remove the `setupWebSocket` function entirely (lines ~667-723)
2. Import `WsGateway` from `./ws-gateway.js`
3. Export a new `setupWsGateway` function that creates and returns a WsGateway:
```typescript
export function setupWsGateway(server: Server, deps: { brain: Brain; toolRegistry: ToolRegistry; daemon: Daemon; redis: Redis }): WsGateway {
  return new WsGateway(server, deps);
}
```
4. Update the `ApiDeps` interface to include `daemon: Daemon` (already has it)

**In index.ts:**
1. Replace the `setupWebSocket(httpServer, brain, toolRegistry)` call with:
```typescript
const wsGateway = setupWsGateway(httpServer, { brain, toolRegistry, daemon, redis });
```
2. Import `setupWsGateway` instead of `setupWebSocket` from `./api.js`
3. Add `wsGateway.stop()` or cleanup in the shutdown handler if needed

Keep backward compatibility: The new gateway listens on the same `/ws/agent` path. Existing clients that send `{ type: "agent", task: "..." }` will NOT work with the new JSON-RPC format — this is an intentional breaking change documented in the gateway (the old protocol had no auth, no multiplexing, no error handling).
  </action>
  <verify>
Run `npx tsc --noEmit` in nexus/packages/core — zero TypeScript errors.
Grep for `setupWebSocket` in api.ts and index.ts — should only appear in comments (if any), not as active code. Grep for `WsGateway` or `setupWsGateway` — should appear in both files.
  </verify>
  <done>
Old setupWebSocket removed. New WsGateway wired into api.ts and index.ts. The gateway is created with full deps (brain, toolRegistry, daemon, redis) and attached to the HTTP server on /ws/agent path.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `ws-gateway.ts` exists and exports WsGateway class
3. `auth.ts` exports verifyJwt and verifyApiKey functions
4. `api.ts` no longer contains the old `setupWebSocket` function
5. `index.ts` creates WsGateway with all required deps
6. JSON-RPC 2.0 types (JsonRpcRequest, JsonRpcResponse, JsonRpcError) are defined
7. Method routing covers: agent.run, agent.cancel, tools.list, system.ping
</verification>

<success_criteria>
- WebSocket gateway module compiles and is wired into the application
- JSON-RPC 2.0 message format is enforced (requests validated, errors use standard codes)
- Authentication on upgrade checks API key or JWT
- Multiplexed sessions allow concurrent agent tasks per connection
- Old bare WebSocket handler is removed
</success_criteria>

<output>
After completion, create `.planning/phases/v1.5-04-websocket-gateway-hitl/v1.5-04-01-SUMMARY.md`
</output>
