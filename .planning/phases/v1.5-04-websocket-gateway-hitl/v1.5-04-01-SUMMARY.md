---
phase: v1.5-04
plan: 01
subsystem: nexus-core
tags: [websocket, json-rpc, gateway, auth, jwt, multiplexing]

dependency_graph:
  requires: [v1.5-01, v1.5-02, v1.5-03]
  provides: [json-rpc-ws-gateway, jwt-auth, ws-session-management]
  affects: [v1.5-04-02, v1.5-04-03, v1.5-04-04]

tech_stack:
  added: []
  patterns: [json-rpc-2.0, manual-hs256-jwt, multiplexed-websocket-sessions]

key_files:
  created:
    - nexus/packages/core/src/ws-gateway.ts
  modified:
    - nexus/packages/core/src/auth.ts
    - nexus/packages/core/src/api.ts
    - nexus/packages/core/src/index.ts

decisions:
  - id: WS-01
    description: "Manual HS256 JWT verification using Node crypto (no jsonwebtoken dependency)"
    rationale: "Avoids adding a new dependency; the HS256 algorithm is simple enough to implement with createHmac"
  - id: WS-02
    description: "noServer mode for WebSocket upgrade with custom auth check"
    rationale: "Allows auth verification before connection acceptance; rejected clients get proper 401 HTTP response"
  - id: WS-03
    description: "Max 5 concurrent sessions per client"
    rationale: "Prevents resource exhaustion while allowing parallel agent tasks"
  - id: WS-04
    description: "Cancellation via status flag (not native AgentLoop abort)"
    rationale: "AgentLoop has no native cancellation; setting cancelled flag stops event forwarding while agent completes naturally"

metrics:
  duration: ~3min
  completed: 2026-02-15
---

# Phase 4 Plan 01: WebSocket Gateway Foundation Summary

**One-liner:** JSON-RPC 2.0 WebSocket gateway with JWT/API-key auth, multiplexed agent sessions, and method routing over /ws/agent

## What Was Built

A standards-compliant JSON-RPC 2.0 WebSocket gateway (`ws-gateway.ts`) that replaces the old bare `setupWebSocket` handler. The new gateway provides:

1. **Authentication on upgrade** - Validates connections via X-API-Key header, JWT query parameter (?token=), or Sec-WebSocket-Protocol. Rejected connections receive HTTP 401.

2. **JSON-RPC 2.0 protocol** - Full request/response/notification framing with standard error codes (-32700 through -32603) plus custom codes for auth (-32000), session not found (-32001), and session limit exceeded (-32002).

3. **Method routing** - Four RPC methods:
   - `agent.run` - Start a new agent session with optional sessionId, maxTurns, tier
   - `agent.cancel` - Cancel a running session by sessionId
   - `tools.list` - Return all registered tools with name/description/parameters
   - `system.ping` - Health check returning pong+timestamp

4. **Multiplexed sessions** - Each client can run up to 5 concurrent agent sessions over a single WebSocket connection. Each session has a unique ID and all events are tagged with that sessionId.

5. **Auth module refactoring** - Extracted `verifyApiKey()` from the middleware for reuse, added `verifyJwt()` with manual HS256 verification using Node's crypto module.

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| WS-01 | Manual HS256 JWT via Node crypto | No external dependency needed; the algorithm is straightforward with createHmac |
| WS-02 | noServer mode with custom upgrade | Auth check before connection acceptance; proper HTTP 401 for rejected clients |
| WS-03 | Max 5 concurrent sessions/client | Resource exhaustion prevention while supporting parallel agent workflows |
| WS-04 | Cancellation via status flag | AgentLoop lacks native abort; flag stops event forwarding, agent completes naturally |

## Deviations from Plan

None - plan executed exactly as written.

## Task Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 902efb5 | JSON-RPC 2.0 WebSocket gateway with auth and session management |
| 2 | 3b8ba45 | Wire WsGateway into api.ts and index.ts, remove old setupWebSocket |

## Key Files

| File | Role |
|------|------|
| `nexus/packages/core/src/ws-gateway.ts` | WsGateway class, JSON-RPC types, method handlers, session management (538 lines) |
| `nexus/packages/core/src/auth.ts` | verifyJwt (manual HS256), verifyApiKey (extracted), requireApiKey (refactored) |
| `nexus/packages/core/src/api.ts` | setupWsGateway wrapper, old setupWebSocket removed |
| `nexus/packages/core/src/index.ts` | WsGateway creation with full deps, stop() in shutdown handler |

## Verification Results

- TypeScript compilation: zero errors (`npx tsc --noEmit`)
- `setupWebSocket` removed from active code (only in comments)
- `WsGateway` wired into both api.ts and index.ts
- All JSON-RPC 2.0 types exported
- All 4 methods routed

## Next Phase Readiness

Plan 02 (HITL approval protocol) can build on this gateway to add:
- `approval.respond` method for human-in-the-loop tool authorization
- Server-to-client `approval.request` notifications
- Session-scoped approval state

No blockers. The gateway's method routing switch makes adding new methods straightforward.
