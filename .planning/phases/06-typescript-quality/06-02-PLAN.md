---
phase: 06-typescript-quality
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - nexus/packages/core/src/daemon.ts
  - nexus/packages/core/src/api.ts
  - nexus/packages/core/src/router.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "catch (err: any) patterns replaced with proper typing in daemon.ts"
    - "catch (err: any) patterns replaced with proper typing in api.ts"
    - "formatErrorMessage utility used consistently for error logging"
  artifacts:
    - path: "nexus/packages/core/src/daemon.ts"
      provides: "Typed catch blocks using formatErrorMessage"
      contains: "formatErrorMessage(err)"
    - path: "nexus/packages/core/src/api.ts"
      provides: "Typed catch blocks using formatErrorMessage"
      contains: "formatErrorMessage(err)"
    - path: "nexus/packages/core/src/router.ts"
      provides: "Generic RouteContext with typed params"
      contains: "Record<string, unknown>"
  key_links:
    - from: "nexus/packages/core/src/daemon.ts"
      to: "nexus/packages/core/src/infra/errors.ts"
      via: "import formatErrorMessage"
      pattern: "import.*formatErrorMessage.*from.*errors"
---

<objective>
Improve TypeScript type safety in Nexus daemon and API modules by replacing `catch (err: any)` with properly typed patterns.

Purpose: Reduce `any` type usage in high-traffic Nexus modules (QUAL-04), improve error handling consistency.
Output: daemon.ts and api.ts with typed catch blocks, router.ts with generic params.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-typescript-quality/06-RESEARCH.md
@.planning/phases/06-typescript-quality/06-01-SUMMARY.md
@nexus/packages/core/src/infra/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace catch (err: any) in daemon.ts</name>
  <files>nexus/packages/core/src/daemon.ts</files>
  <action>
Replace all `catch (err: any)` patterns with typed patterns using formatErrorMessage.

1. Ensure formatErrorMessage is imported at the top of the file:
```typescript
import { formatErrorMessage } from './infra/errors.js';
```
If already importing from errors.js, add formatErrorMessage to the import.

2. Use find-and-replace to change the pattern. For each catch block:

BEFORE:
```typescript
} catch (err: any) {
  logger.error('Some message', { error: err.message });
}
```

AFTER:
```typescript
} catch (err) {
  logger.error('Some message', { error: formatErrorMessage(err) });
}
```

The key changes:
- Remove `: any` type annotation from catch parameter
- Replace `err.message` with `formatErrorMessage(err)`
- Replace `err.stack` with `formatErrorMessage(err)` (stack is included when relevant)
- Replace `String(err)` with `formatErrorMessage(err)`

Common patterns to find and replace:
- `catch (err: any)` -> `catch (err)`
- `err.message` in logger calls -> `formatErrorMessage(err)`
- `err?.message` -> `formatErrorMessage(err)`
- `(err as Error).message` -> `formatErrorMessage(err)`

Do NOT change:
- `err.code` checks - these use extractErrorCode() which handles unknown
- `err instanceof Error` checks - these are valid type guards
- Rethrows like `throw err` - these are fine

Expected count: ~33 catch blocks need updating based on research.
  </action>
  <verify>
Count remaining `catch (err: any)`:
```bash
grep -c "catch (err: any)" nexus/packages/core/src/daemon.ts || echo "0"
```
Should return 0.

Verify formatErrorMessage usage:
```bash
grep -c "formatErrorMessage(err)" nexus/packages/core/src/daemon.ts
```
Should be > 20.

TypeScript compiles:
```bash
cd nexus/packages/core && npx tsc --noEmit
```
  </verify>
  <done>
daemon.ts has 0 instances of `catch (err: any)`. formatErrorMessage is used for all error logging. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace catch (err: any) in api.ts</name>
  <files>nexus/packages/core/src/api.ts</files>
  <action>
Apply the same pattern as Task 1 to api.ts.

1. Ensure formatErrorMessage is imported:
```typescript
import { formatErrorMessage } from './infra/errors.js';
```

2. Replace all `catch (err: any)` blocks:

BEFORE:
```typescript
} catch (err: any) {
  return { success: false, error: err.message };
}
```

AFTER:
```typescript
} catch (err) {
  return { success: false, error: formatErrorMessage(err) };
}
```

Common API patterns:
- Response objects with `error: err.message` -> `error: formatErrorMessage(err)`
- Logger calls with error context -> use formatErrorMessage
- Error rethrows are fine as-is

Expected count: ~30 catch blocks need updating.

Note: api.ts likely has many similar catch patterns due to route handlers. This is normal - each route needs its own error handling.
  </action>
  <verify>
Count remaining `catch (err: any)`:
```bash
grep -c "catch (err: any)" nexus/packages/core/src/api.ts || echo "0"
```
Should return 0.

Verify formatErrorMessage usage:
```bash
grep -c "formatErrorMessage(err)" nexus/packages/core/src/api.ts
```
Should be > 20.

TypeScript compiles:
```bash
cd nexus/packages/core && npx tsc --noEmit
```
  </verify>
  <done>
api.ts has 0 instances of `catch (err: any)`. formatErrorMessage is used consistently. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Type router.ts params</name>
  <files>nexus/packages/core/src/router.ts</files>
  <action>
Improve type safety in router.ts by replacing `any` with `unknown`.

Find and update the RouteContext interface or similar type definitions:

BEFORE:
```typescript
interface RouteContext {
  params: Record<string, any>;
}
```

AFTER:
```typescript
interface RouteContext<T extends Record<string, unknown> = Record<string, unknown>> {
  params: T;
}
```

Or if simpler:
```typescript
interface RouteContext {
  params: Record<string, unknown>;
}
```

Also update any `data?: any` patterns:

BEFORE:
```typescript
data?: any
```

AFTER:
```typescript
data?: unknown
```

This is a safe change because:
- `unknown` requires type narrowing before use (safer than `any`)
- Existing code that accesses params will need to validate, which is correct
- Generic version allows specific route handlers to specify their params type
  </action>
  <verify>
Check for remaining `any` in router.ts:
```bash
grep -n ": any" nexus/packages/core/src/router.ts || echo "No any types found"
```
Should show no remaining `any` types.

TypeScript compiles:
```bash
cd nexus/packages/core && npx tsc --noEmit
```
  </verify>
  <done>
router.ts uses `Record<string, unknown>` instead of `Record<string, any>`. All `data?: any` replaced with `data?: unknown`. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. No `catch (err: any)` in target files:
   ```bash
   grep -c "catch (err: any)" nexus/packages/core/src/daemon.ts nexus/packages/core/src/api.ts || echo "0"
   ```
2. formatErrorMessage import and usage present in both files
3. TypeScript compiles: `cd nexus/packages/core && npx tsc --noEmit`
4. No runtime errors introduced (functional verification if tests exist)
</verification>

<success_criteria>
- daemon.ts: 0 instances of `catch (err: any)`, uses formatErrorMessage throughout
- api.ts: 0 instances of `catch (err: any)`, uses formatErrorMessage throughout
- router.ts: Uses `unknown` instead of `any` for dynamic params
- All files compile with TypeScript
- Existing functionality preserved (error messages still logged properly)
</success_criteria>

<output>
After completion, create `.planning/phases/06-typescript-quality/06-02-SUMMARY.md`
</output>
