---
phase: 06-typescript-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/core/src/infra/errors.ts
  - livos/packages/livinityd/source/modules/files/network-storage.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Error aggregation hooks exist for monitoring integration"
    - "No silent error swallowing in the codebase"
    - "Error handlers can be registered and receive error reports"
  artifacts:
    - path: "nexus/packages/core/src/infra/errors.ts"
      provides: "Error aggregation hooks (registerErrorHandler, reportError)"
      exports: ["ErrorContext", "ErrorHandler", "registerErrorHandler", "reportError"]
    - path: "livos/packages/livinityd/source/modules/files/network-storage.ts"
      provides: "Proper error logging instead of silent catch"
      contains: "logger.verbose"
  key_links:
    - from: "nexus/packages/core/src/infra/errors.ts"
      to: "external monitoring"
      via: "registerErrorHandler callback"
      pattern: "registerErrorHandler\\("
---

<objective>
Add error aggregation hooks to Nexus error infrastructure and fix the one silent error catch in network-storage.ts.

Purpose: Establish foundation for error monitoring and eliminate silent failures that make debugging difficult.
Output: Extended errors.ts with aggregation API, fixed network-storage.ts catch block.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-typescript-quality/06-RESEARCH.md
@nexus/packages/core/src/infra/errors.ts
@livos/packages/livinityd/source/modules/files/network-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error aggregation hooks to errors.ts</name>
  <files>nexus/packages/core/src/infra/errors.ts</files>
  <action>
Add error aggregation infrastructure to the existing errors.ts file:

1. Add ErrorContext interface after ERROR_CATEGORIES:
```typescript
export interface ErrorContext {
  module: string;
  operation: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  metadata?: Record<string, unknown>;
}

export type ErrorHandler = (error: unknown, context: ErrorContext) => void;
```

2. Add private handler registry after the interface:
```typescript
const errorHandlers: Set<ErrorHandler> = new Set();
```

3. Add registerErrorHandler function before default export:
```typescript
/**
 * Register an error handler for monitoring/aggregation.
 * Returns an unsubscribe function.
 */
export function registerErrorHandler(handler: ErrorHandler): () => void {
  errorHandlers.add(handler);
  return () => errorHandlers.delete(handler);
}
```

4. Add reportError function after registerErrorHandler:
```typescript
/**
 * Report an error to all registered handlers.
 * Safe to call - handler errors are silently caught.
 */
export function reportError(error: unknown, context: ErrorContext): void {
  for (const handler of errorHandlers) {
    try {
      handler(error, context);
    } catch {
      // Don't let error handlers break the application
    }
  }
}
```

5. Update the default export to include the new functions:
```typescript
export default {
  // ... existing exports
  registerErrorHandler,
  reportError,
  ERROR_CATEGORIES,
};
```

Keep all existing functions unchanged. Place new code in logical order as described.
  </action>
  <verify>
Run TypeScript compilation:
```bash
cd nexus/packages/core && npx tsc --noEmit
```
Verify exports exist:
```bash
grep -E "export (interface ErrorContext|type ErrorHandler|function registerErrorHandler|function reportError)" nexus/packages/core/src/infra/errors.ts
```
  </verify>
  <done>
errors.ts exports ErrorContext, ErrorHandler, registerErrorHandler, and reportError. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix silent catch block in network-storage.ts</name>
  <files>livos/packages/livinityd/source/modules/files/network-storage.ts</files>
  <action>
Fix the silent error swallowing at line 106 in the #watchAndMountShares method.

Find this code (around line 98-107):
```typescript
shares.map(async (share) => {
  try {
    if (await this.#isMounted(share)) {
      this.mountedShares.add(share.mountPath)
    } else {
      this.mountedShares.delete(share.mountPath)
      await this.#mountShare(share)
    }
  } catch (error) {}
}),
```

Replace the empty catch block with proper logging:
```typescript
shares.map(async (share) => {
  try {
    if (await this.#isMounted(share)) {
      this.mountedShares.add(share.mountPath)
    } else {
      this.mountedShares.delete(share.mountPath)
      await this.#mountShare(share)
    }
  } catch (error) {
    this.logger.verbose(`Share check failed for ${share.mountPath}: ${error instanceof Error ? error.message : String(error)}`)
  }
}),
```

Use logger.verbose (not logger.error) because:
- This runs frequently (every minute)
- Transient network failures are expected
- Errors will be logged in #mountShare when it fails
- verbose level keeps logs clean while still capturing the issue

WHY verbose and not error: The #mountShare method already logs errors at error level when mounting fails. This catch block handles the outer try/catch which includes both isMounted check and the mount attempt. Using error level here would create duplicate error logs.
  </action>
  <verify>
Search for empty catch blocks:
```bash
grep -n "catch.*{}" livos/packages/livinityd/source/modules/files/network-storage.ts
```
Should return no results.

Verify the new logging exists:
```bash
grep -n "Share check failed" livos/packages/livinityd/source/modules/files/network-storage.ts
```
Should show the new verbose log line.
  </verify>
  <done>
The empty catch block is replaced with proper error logging. No silent error swallowing remains in network-storage.ts.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. TypeScript compiles: `cd nexus/packages/core && npx tsc --noEmit`
2. No empty catch blocks: `grep -rn "catch.*{}" nexus/packages/core/src/infra/ livos/packages/livinityd/source/modules/files/`
3. Exports are correct: Check errors.ts has registerErrorHandler and reportError exported
</verification>

<success_criteria>
- ErrorContext interface and ErrorHandler type are exported from errors.ts
- registerErrorHandler function is exported and allows callback registration
- reportError function is exported and dispatches to all registered handlers
- network-storage.ts has no empty catch blocks
- network-storage.ts logs share check failures at verbose level
- TypeScript compiles without errors in both packages
</success_criteria>

<output>
After completion, create `.planning/phases/06-typescript-quality/06-01-SUMMARY.md`
</output>
