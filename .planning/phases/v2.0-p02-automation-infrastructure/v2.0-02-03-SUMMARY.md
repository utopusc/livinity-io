---
phase: v2.0-p02-automation-infrastructure
plan: 03
subsystem: channels
tags: [gmail, oauth2, googleapis, polling, email, channels]

# Dependency graph
requires:
  - phase: v2.0-p01-stability-security
    provides: "CircuitBreaker, BullMQ scheduling, channel infrastructure"
provides:
  - "GmailProvider class with polling-based email channel"
  - "OAuth 2.0 flow (start, callback, status, disconnect) endpoints"
  - "Gmail Settings UI page with connect/disconnect"
  - "tRPC proxy routes for Gmail OAuth"
affects: ["v2.0-p02-automation-infrastructure plan 04 (webhook channels)"]

# Tech tracking
tech-stack:
  added: [googleapis]
  patterns: ["OAuth 2.0 browser redirect for channel auth", "Polling-based email ingestion"]

key-files:
  created:
    - nexus/packages/core/src/channels/gmail.ts
    - livos/packages/ui/src/routes/settings/gmail.tsx
  modified:
    - nexus/packages/core/src/channels/types.ts
    - nexus/packages/core/src/channels/index.ts
    - nexus/packages/core/src/api.ts
    - nexus/packages/core/src/index.ts
    - nexus/packages/core/src/router.ts
    - livos/packages/livinityd/source/modules/ai/routes.ts
    - livos/packages/ui/src/routes/settings/_components/settings-content.tsx

key-decisions:
  - "OAuth callback is public (before requireApiKey middleware) — Google redirects browser there"
  - "Polling default 60s interval, configurable via GMAIL_POLL_INTERVAL_SEC env var"
  - "Seen message IDs stored in Redis SET with 500-entry cap to prevent unbounded growth"
  - "Gmail provider registered in ChannelManager alongside Telegram/Discord/Slack/Matrix"

patterns-established:
  - "OAuth channel auth: public callback + authenticated start/status/disconnect"
  - "Gmail config stored in Redis nexus:gmail:* keys (config, tokens, profile, seen_message_ids)"

# Metrics
duration: 7min
completed: 2026-02-20
---

# Phase v2.0 Plan 03: Gmail Channel Provider Summary

**GmailProvider with OAuth 2.0 flow, 60s polling for unread emails, auto-token refresh, and Settings UI with connect/disconnect**

## Performance

- **Duration:** ~7 min
- **Started:** 2026-02-20T22:23:27Z
- **Completed:** 2026-02-20T22:31:15Z
- **Tasks:** 2/3 (checkpoint pending for human verification)
- **Files modified:** 11

## Accomplishments
- GmailProvider class (521 lines) implementing ChannelProvider with full OAuth 2.0 + polling
- Four OAuth API endpoints: start, callback (public), status, disconnect
- Gmail Settings page with status card, connect/disconnect flow, setup instructions
- tRPC proxy routes for Gmail operations in livinityd

## Task Commits

Each task was committed atomically:

1. **Task 1: GmailProvider class and Gmail OAuth API endpoints** - `ff43f8d` (feat)
2. **Task 2: Gmail Settings UI with OAuth connect/disconnect** - `5073c7d` (feat)
3. **Task 3: Human verification checkpoint** - awaiting user

## Files Created/Modified
- `nexus/packages/core/src/channels/gmail.ts` - GmailProvider: OAuth 2.0, polling, token refresh, body extraction
- `nexus/packages/core/src/channels/types.ts` - Added 'gmail' to ChannelId, Gmail fields to ChannelConfig, CHANNEL_META
- `nexus/packages/core/src/channels/index.ts` - Import and register GmailProvider
- `nexus/packages/core/src/api.ts` - OAuth endpoints (callback public, start/status/disconnect authenticated)
- `nexus/packages/core/src/index.ts` - Gmail env var config on startup
- `nexus/packages/core/src/router.ts` - Added 'gmail' to Intent source type
- `livos/packages/ui/src/routes/settings/gmail.tsx` - Gmail settings page with tRPC hooks
- `livos/packages/ui/src/routes/settings/_components/settings-content.tsx` - Gmail menu item and section
- `livos/packages/livinityd/source/modules/ai/routes.ts` - tRPC proxy: getGmailStatus, startGmailOauth, disconnectGmail

## Decisions Made
- OAuth callback endpoint placed before requireApiKey middleware (Google redirects browser directly)
- Polling interval defaults to 60 seconds, configurable via env var
- Redis SET used for seen message IDs with 500 max cap (prevents unbounded growth)
- Direct Gmail API via googleapis (not Pub/Sub) for simplicity in self-hosted deployments
- Email body extracted with text/plain preference, HTML fallback with tag stripping

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added 'gmail' to Intent source type in router.ts**
- **Found during:** Task 1 (TypeScript compilation)
- **Issue:** Adding 'gmail' to ChannelId caused type error since Intent.source didn't include 'gmail'
- **Fix:** Added 'gmail' to the source union type in router.ts
- **Files modified:** nexus/packages/core/src/router.ts
- **Verification:** `npx tsc --noEmit` passes cleanly
- **Committed in:** ff43f8d (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary type union expansion. No scope creep.

## Issues Encountered
None - plan executed cleanly after the type fix.

## User Setup Required

**External services require manual configuration:**
- `GMAIL_CLIENT_ID` — from Google Cloud Console > APIs & Services > Credentials > OAuth 2.0 Client IDs
- `GMAIL_CLIENT_SECRET` — same location
- `NEXUS_PUBLIC_URL` — public URL for OAuth callback redirect (e.g., `https://your-server.com:3200`)
- `LIVOS_UI_URL` — LivOS UI base URL for post-OAuth redirect (default: `http://localhost:2017`)
- Optional: `GMAIL_POLL_INTERVAL_SEC` — polling interval (default: 60)

In Google Cloud Console, add `{NEXUS_PUBLIC_URL}/api/gmail/oauth/callback` as an authorized redirect URI.

## Next Phase Readiness
- GmailProvider ready for testing after OAuth credentials are configured
- Sending emails (sendMessage) deferred to future plan
- Polling worker runs automatically once connected

---
*Phase: v2.0-p02-automation-infrastructure*
*Completed: 2026-02-20 (partial — checkpoint pending)*
