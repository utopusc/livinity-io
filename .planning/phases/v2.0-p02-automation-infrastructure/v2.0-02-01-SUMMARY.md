---
phase: v2.0-p02-automation-infrastructure
plan: 01
subsystem: api
tags: [webhook, hmac, bullmq, express, redis, dedup, security]

# Dependency graph
requires:
  - phase: v2.0-p01-stability-security
    provides: BullMQ queue patterns, CircuitBreaker, error handling infrastructure
provides:
  - WebhookManager class with HMAC-SHA256 verification, BullMQ queue, and Redis dedup
  - POST /api/webhook/:id receiver route with raw body parsing
  - Webhook CRUD (create, get, list, delete) via Redis
  - Duplicate delivery detection with 24h TTL
affects:
  - v2.0-p02-automation-infrastructure (plans 02-04 build on webhook infrastructure)
  - v2.0-p03-external-integrations (GitHub/n8n will use webhook endpoints)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "HMAC-SHA256 webhook signature verification with timing-safe comparison"
    - "express.raw() route-level middleware before global json parser for raw body access"
    - "Redis SET NX for atomic deduplication with TTL"
    - "BullMQ queue+worker pattern for async webhook processing into daemon inbox"

key-files:
  created:
    - nexus/packages/core/src/webhook-manager.ts
  modified:
    - nexus/packages/core/src/api.ts
    - nexus/packages/core/src/index.ts

key-decisions:
  - "Webhook route registered before express.json() middleware to preserve raw Buffer for HMAC"
  - "UUID-format validation on webhook IDs to avoid intercepting /api/webhook/git"
  - "Webhook route bypasses API key auth (uses own HMAC-SHA256 auth mechanism)"
  - "Duplicate deliveries return HTTP 200 to prevent external service retries"

patterns-established:
  - "Webhook HMAC pattern: sha256=<hex> header format, timingSafeEqual comparison"
  - "Redis dedup pattern: SET NX with TTL for idempotent processing"
  - "Raw body route pattern: express.raw() before express.json() in middleware chain"

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 2 Plan 01: Webhook Receiver Infrastructure Summary

**HMAC-SHA256 webhook receiver with BullMQ job queue, Redis deduplication, and 1MB payload limit**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T22:22:55Z
- **Completed:** 2026-02-20T22:26:47Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- WebhookManager class with full CRUD, HMAC-SHA256 verification (timing-safe), BullMQ queue/worker, and Redis dedup
- POST /api/webhook/:id route with express.raw() middleware for raw body access, bypassing global JSON parser and API key auth
- Duplicate delivery detection via Redis SET NX with 24-hour TTL
- Automatic payload truncation to 2000 chars for agent inbox messages

## Task Commits

Each task was committed atomically:

1. **Task 1: WebhookManager class with HMAC verification, BullMQ queue, and dedup** - `3395eeb` (feat)
2. **Task 2: Webhook receiver Express route with size limit and signature verification** - `aefa9da` (feat)

## Files Created/Modified
- `nexus/packages/core/src/webhook-manager.ts` - WebhookManager class: CRUD, HMAC verification, BullMQ queue/worker, Redis dedup
- `nexus/packages/core/src/api.ts` - POST /api/webhook/:id route with express.raw(), HMAC auth, dedup, size limit
- `nexus/packages/core/src/index.ts` - WebhookManager initialization, shutdown cleanup, ApiDeps wiring

## Decisions Made
- **Webhook route position:** Registered before `express.json()` and `requireApiKey` middleware -- webhooks use their own HMAC-SHA256 authentication and need raw Buffer bodies for signature verification
- **UUID validation on route:** `/api/webhook/:id` only handles UUID-format IDs to avoid intercepting the existing `/api/webhook/git` endpoint
- **Duplicate handling returns 200:** Returning HTTP 200 for duplicate deliveries prevents external services (GitHub, n8n) from retrying
- **BullMQ concurrency 2:** Webhook worker processes 2 jobs concurrently, matching the memory extraction worker pattern

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing TypeScript errors in `channels/types.ts` (gmail channel not fully wired) -- unrelated to webhook code, did not block compilation of new files

## User Setup Required

None - no external service configuration required. Webhook endpoints are ready to receive requests once the server is deployed.

## Next Phase Readiness
- Webhook receiver infrastructure complete and ready for webhook management API (plan 02)
- BullMQ webhook queue established for plan 03 (event rule engine) to consume
- HMAC verification pattern ready for GitHub, n8n, and custom webhook sources

---
*Phase: v2.0-p02-automation-infrastructure*
*Completed: 2026-02-20*
