---
phase: v2.0-p02-automation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["v2.0-02-01"]
files_modified:
  - nexus/packages/core/src/daemon.ts
  - nexus/packages/core/src/api.ts
  - livos/packages/livinityd/source/modules/ai/routes.ts
  - livos/packages/ui/src/routes/settings/webhooks.tsx
  - livos/packages/ui/src/routes/settings/_components/settings-content.tsx
autonomous: true

must_haves:
  truths:
    - "AI agent can call webhook_create tool to generate a new webhook endpoint with a unique URL and secret"
    - "AI agent can call webhook_list to see all registered webhooks"
    - "AI agent can call webhook_delete to remove a webhook by ID"
    - "User can see webhooks in Settings UI with name, URL, delivery count, and last used time"
    - "User can create and delete webhooks from the Settings UI"
    - "Webhook endpoints enforce rate limiting of 30 requests per minute per source"
  artifacts:
    - path: "nexus/packages/core/src/daemon.ts"
      provides: "webhook_create, webhook_list, webhook_delete MCP tools"
      contains: "webhook_create"
    - path: "nexus/packages/core/src/api.ts"
      provides: "Rate limiting middleware on webhook receiver, CRUD REST endpoints for webhooks"
      contains: "rateLimiter"
    - path: "livos/packages/ui/src/routes/settings/webhooks.tsx"
      provides: "Webhooks settings page with list, create dialog, and delete"
      min_lines: 80
    - path: "livos/packages/livinityd/source/modules/ai/routes.ts"
      provides: "tRPC proxy routes for webhook CRUD"
      contains: "getWebhooks"
  key_links:
    - from: "nexus/packages/core/src/daemon.ts"
      to: "nexus/packages/core/src/webhook-manager.ts"
      via: "toolRegistry.register calls webhookManager methods"
      pattern: "webhook_create|webhook_list|webhook_delete"
    - from: "livos/packages/ui/src/routes/settings/webhooks.tsx"
      to: "livos/packages/livinityd/source/modules/ai/routes.ts"
      via: "trpc.ai.getWebhooks.useQuery / createWebhook.useMutation"
      pattern: "getWebhooks|createWebhook|deleteWebhook"
---

<objective>
Add webhook management: MCP tools for the AI agent (create/list/delete webhooks), per-source rate limiting on the receiver endpoint, REST API endpoints for CRUD, tRPC proxy routes, and a Settings UI panel for managing webhooks.

Purpose: Users need to manage their webhook endpoints through both AI commands and the web UI. Rate limiting prevents abuse of webhook endpoints.

Output: 3 MCP tools, rate-limited receiver, REST CRUD endpoints, tRPC proxies, Settings webhooks page.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v2.0-p02-automation-infrastructure/v2.0-02-01-SUMMARY.md

Key codebase references:
@nexus/packages/core/src/daemon.ts (registerTools method at line 1135 — follow this exact pattern for new tools)
@nexus/packages/core/src/api.ts (ApiDeps interface, existing CRUD patterns like DM pairing endpoints)
@livos/packages/livinityd/source/modules/ai/routes.ts (tRPC proxy pattern — follow existing DM pairing/usage proxy routes)
@livos/packages/ui/src/routes/settings/dm-pairing.tsx (Settings page pattern — tabs, cards, status badges)
@livos/packages/ui/src/routes/settings/_components/settings-content.tsx (menu item registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP tools (webhook_create, webhook_list, webhook_delete) and rate limiting</name>
  <files>
    nexus/packages/core/src/daemon.ts
    nexus/packages/core/src/api.ts
  </files>
  <action>
**In daemon.ts — registerTools() method:**

Add `webhookManager` to DaemonConfig interface:
```typescript
webhookManager?: WebhookManager;
```

Import WebhookManager type at top of file:
```typescript
import type { WebhookManager } from './webhook-manager.js';
```

Register 3 tools in registerTools() (follow existing tool registration pattern exactly):

1. **webhook_create** — `name: string` (required), `secret: string` (optional). Calls `webhookManager.createWebhook(name, secret)`. Returns the generated webhook URL, ID, and secret. If webhookManager is not available, return error "Webhook system not initialized".

2. **webhook_list** — No parameters. Calls `webhookManager.listWebhooks()`. Returns formatted list with name, ID, delivery count, last used. If none exist, return "No webhooks configured."

3. **webhook_delete** — `id: string` (required). Calls `webhookManager.deleteWebhook(id)`. Returns success/failure message.

**In index.ts — Pass webhookManager to daemon config:**
Add `webhookManager` to the DaemonConfig object passed to `new Daemon(...)`.

**In api.ts — Rate limiting and CRUD endpoints:**

1. Add simple Redis-based rate limiter for webhook receiver. Before the `/api/webhook/:id` route handler, add rate checking logic:
   - Redis key: `nexus:webhook:rate:{id}` with INCR + EXPIRE pattern
   - Check: if count > 30, return 429 Too Many Requests with `Retry-After: 60` header
   - Window: 60 seconds (use EXPIRE on first INCR)

2. Add CRUD REST endpoints (behind requireApiKey):
   ```
   GET  /api/webhooks          → webhookManager.listWebhooks()
   POST /api/webhooks          → webhookManager.createWebhook(name, secret?)
   GET  /api/webhooks/:id      → webhookManager.getWebhook(id)
   DELETE /api/webhooks/:id    → webhookManager.deleteWebhook(id)
   ```
   Follow the exact pattern of existing CRUD endpoints (like DM pairing endpoints).
  </action>
  <verify>
Run `npx tsc --noEmit` in nexus/packages/core. Search for `webhook_create` in daemon.ts to confirm tool registration. Search for `GET /api/webhooks` pattern in api.ts.
  </verify>
  <done>
Three MCP tools registered (webhook_create, webhook_list, webhook_delete). Redis-based rate limiting (30/min per webhook) on receiver endpoint. REST CRUD endpoints for webhook management behind API key auth.
  </done>
</task>

<task type="auto">
  <name>Task 2: tRPC proxy routes and Settings UI for webhook management</name>
  <files>
    livos/packages/livinityd/source/modules/ai/routes.ts
    livos/packages/ui/src/routes/settings/webhooks.tsx
    livos/packages/ui/src/routes/settings/_components/settings-content.tsx
  </files>
  <action>
**In livos/packages/livinityd/source/modules/ai/routes.ts:**

Add tRPC proxy routes for webhook CRUD (follow the exact pattern of existing DM pairing proxy routes):

```typescript
getWebhooks: privateProcedure.query(async ({ctx}) => {
  const res = await fetch(`${nexusApiUrl}/api/webhooks`, {
    headers: { 'X-Api-Key': apiKey },
  });
  return res.json();
}),

createWebhook: privateProcedure
  .input(z.object({ name: z.string().min(1).max(100), secret: z.string().optional() }))
  .mutation(async ({input}) => {
    const res = await fetch(`${nexusApiUrl}/api/webhooks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Api-Key': apiKey },
      body: JSON.stringify(input),
    });
    return res.json();
  }),

deleteWebhook: privateProcedure
  .input(z.object({ id: z.string() }))
  .mutation(async ({input}) => {
    const res = await fetch(`${nexusApiUrl}/api/webhooks/${input.id}`, {
      method: 'DELETE',
      headers: { 'X-Api-Key': apiKey },
    });
    return res.json();
  }),
```

Determine `nexusApiUrl` and `apiKey` from the same pattern used by existing proxy routes (check how DM pairing routes get the Nexus API URL — likely from environment or context).

**In livos/packages/ui/src/routes/settings/webhooks.tsx:**

Create a new settings page component following the dm-pairing.tsx pattern:

- **Header:** "Webhooks" with subtitle "Manage webhook endpoints for external service integrations"
- **Create section:** Button to open a create dialog. Dialog has: name input (required), optional custom secret input. On submit, calls `trpc.ai.createWebhook.useMutation()`. Shows the generated URL and secret in a copyable format ONCE after creation (secret is shown only at creation time).
- **List section:** Table/cards showing all webhooks. Each row: name, URL (copyable), delivery count, last used timestamp (relative like "2 hours ago"), delete button (with confirmation).
- Use the same UI components as dm-pairing.tsx: Card, Button, Input, shadcn Dialog, etc.
- Loading state with skeleton/spinner while fetching.
- Empty state: "No webhooks configured. Create one to start receiving events from external services."

**In settings-content.tsx:**

Add a "Webhooks" menu item in the settings navigation, in the appropriate section (near Channels/Integrations). Use `TbWebhook` icon from `react-icons/tb` (or `TbPlug` if TbWebhook doesn't exist — check available icons). Add import for the webhooks page component with lazy loading:

```typescript
const WebhooksSettings = React.lazy(() => import('../webhooks'))
```

Wire it into the settings sections and content rendering (follow the exact pattern of how DM Security / Usage Dashboard are wired).
  </action>
  <verify>
Run `npx tsc --noEmit` in both nexus/packages/core and check that livos builds: `cd livos && pnpm --filter @livos/config build && pnpm --filter ui build` (or just verify TypeScript with tsc). Verify webhooks.tsx exists and exports a default component. Verify settings-content.tsx has a Webhooks menu item.
  </verify>
  <done>
tRPC proxy routes for webhook CRUD are registered. Settings UI shows webhook list with create/delete functionality. Webhook secret is shown only once at creation time. Menu item appears in settings navigation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in nexus/packages/core
2. Three MCP tools registered: webhook_create, webhook_list, webhook_delete
3. Rate limiting returns 429 after 30 requests per minute per webhook
4. REST CRUD endpoints exist behind API key auth
5. tRPC proxy routes work for webhook management
6. Settings UI shows webhook list, create dialog, and delete with confirmation
7. Settings navigation includes Webhooks menu item
</verification>

<success_criteria>
- AI agent can create, list, and delete webhooks via MCP tools
- Rate limiting enforced at 30 req/min per webhook source
- Settings UI renders webhook management page
- Webhook secret displayed only once at creation time
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/v2.0-p02-automation-infrastructure/v2.0-02-02-SUMMARY.md`
</output>
