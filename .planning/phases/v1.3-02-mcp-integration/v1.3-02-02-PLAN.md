---
phase: v1.3-02-mcp-integration
plan: 02
type: execute
wave: 2
depends_on: ["v1.3-02-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "AI agent can navigate to a URL via Playwright MCP browser_navigate tool"
    - "AI agent can click elements on a page via Playwright MCP browser_click tool"
    - "AI agent can type text into inputs via Playwright MCP browser_type tool"
    - "AI agent can take screenshots via Playwright MCP browser_snapshot tool"
    - "Playwright MCP tools appear as mcp_browser_* in Nexus ToolRegistry after registration"
  artifacts: []
  key_links:
    - from: "hooks/post-start"
      to: "McpClientManager.reconcile()"
      via: "Redis PUBLISH nexus:config:updated triggers reconcile"
      pattern: "config change detected.*reconciling"
    - from: "McpClientManager"
      to: "Playwright MCP (docker exec)"
      via: "StdioClientTransport spawns docker exec process"
      pattern: "connecting to.*browser.*stdio"
    - from: "Playwright MCP"
      to: "Chromium CDP (localhost:9222 inside container)"
      via: "Chrome DevTools Protocol WebSocket"
      pattern: "cdp-endpoint.*localhost:9222"
---

<objective>
Verify the complete Playwright MCP integration chain: hooks register MCP config in Redis, McpClientManager picks it up via pub/sub, connects via stdio transport (docker exec), discovers Playwright tools, and AI agent can execute browser automation commands.

Purpose: This is the end-to-end validation that the entire MCP integration works. Plan 01 created the hooks; this plan verifies the full chain actually functions when deployed.

Output: Verified integration with documented tool names and capabilities, confirmation that MCP-03 and MCP-04 requirements are satisfied.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/STACK.md

# Prior plan summary (hooks must be done first)
@.planning/phases/v1.3-02-mcp-integration/v1.3-02-01-SUMMARY.md

# Nexus MCP system (reference)
@nexus\packages\core\src\mcp-client-manager.ts
@nexus\packages\core\src\mcp-config-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify MCP registration chain and Playwright tool discovery</name>
  <files></files>
  <action>
This task verifies the MCP integration works end-to-end WITHOUT modifying any files. It is a verification/testing task.

**Prerequisites:**
- Phase 1 (Container and App Store) must be complete (browser app installed and running)
- Plan 01 (hooks) must be complete (hooks updated in gallery repo)
- The chromium app must be installed and started in LivOS

**Verification steps:**

1. **Check Redis MCP config:**
   Connect to Redis and verify the MCP config contains the "browser" entry:
   ```bash
   redis-cli -a <password> GET nexus:mcp:config | jq '.mcpServers.browser'
   ```
   Expected: JSON object with transport: "stdio", command: "docker", args including "exec", "-i", "chromium_server_1", etc.

2. **Check McpClientManager connected to browser MCP:**
   Look at Nexus logs for connection messages:
   ```bash
   # Check Nexus logs for MCP connection
   journalctl -u nexus --since "5 minutes ago" | grep -i "mcp.*browser"
   ```
   Expected: `McpClientManager: connected to "browser", N tools registered`

3. **Verify Playwright MCP tools are registered:**
   Check Nexus logs or the MCP status endpoint for the list of discovered tools.
   Expected tools (based on @playwright/mcp latest):
   - `mcp_browser_browser_navigate` -- navigate to URL
   - `mcp_browser_browser_click` -- click elements
   - `mcp_browser_browser_type` -- type text
   - `mcp_browser_browser_snapshot` -- take accessibility snapshot
   - `mcp_browser_browser_screenshot` -- take screenshot
   - And others (hover, select, drag, etc.)

4. **Verify CDP connection works:**
   Test that the docker exec approach can reach CDP:
   ```bash
   docker exec chromium_server_1 curl -s http://localhost:9222/json/version
   ```
   Expected: JSON response with Browser, Protocol-Version, etc.

5. **Test a basic Playwright MCP tool call:**
   If possible, trigger a tool call through the Nexus API or AI chat:
   - Ask the AI to "navigate to https://example.com"
   - Or directly call the mcp_browser_browser_navigate tool via the API
   Expected: The browser navigates to example.com (visible in KasmVNC viewer)

**If the chromium app is NOT yet running (Phase 1 not executed):**
Document all verification steps as a checklist for post-deployment testing. Create a verification script that can be run once the app is deployed.
  </action>
  <verify>
1. Redis nexus:mcp:config contains .mcpServers.browser with correct config
2. Nexus logs show successful connection to "browser" MCP server
3. Playwright tools are discoverable (mcp_browser_* tools exist in registry)
4. CDP responds inside container (docker exec curl to localhost:9222)
5. At least one tool call succeeds (navigate, click, type, or screenshot)
  </verify>
  <done>
- MCP-03 verified: Playwright MCP connects via CDP to chromium container
- MCP-04 verified: AI agent can execute navigate, click, type, screenshot via MCP tools
- Tool discovery confirmed: Playwright tools registered as mcp_browser_* in ToolRegistry
- CDP connection verified: localhost:9222 inside container responds to Chrome DevTools Protocol
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Playwright MCP integration chain: hooks register/deregister MCP config in Redis, McpClientManager auto-connects via stdio transport (docker exec), Playwright tools are available to AI agent for browser automation.
  </what-built>
  <how-to-verify>
1. Open the LivOS AI chat interface
2. Send a message asking the AI to navigate to a website, e.g.: "Go to https://example.com in the browser"
3. Open the browser app (browser.domain.com) in another tab and verify it shows example.com
4. Ask the AI to "take a screenshot of the browser" and verify it returns an image
5. Ask the AI to "click the 'More information...' link on example.com" and verify navigation
6. Stop the chromium app from the App Store and verify:
   - Nexus logs show MCP server "browser" disconnected
   - AI no longer has browser tools available
7. Start the chromium app again and verify:
   - Nexus logs show MCP server "browser" reconnected
   - AI regains browser tools

If the browser app is not yet deployed (Phase 1 not done), this checkpoint should be deferred until after Phase 1 execution.
  </how-to-verify>
  <resume-signal>Type "approved" if AI can control the browser, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Full Phase 2 verification against requirements:

| Requirement | Verification | Status |
|-------------|-------------|--------|
| MCP-01 | post-start registers MCP in Redis | Check Redis key |
| MCP-02 | pre-stop deregisters MCP from Redis | Stop app, check Redis key |
| MCP-03 | Playwright connects via CDP | Check Nexus logs for connection |
| MCP-04 | AI can navigate/click/type/screenshot | Test via AI chat |
| MCP-05 | CDP port 9222 in CHROME_CLI | Check docker-compose env |
| SEC-03 | CDP port NOT exposed to host | Check docker-compose ports |
</verification>

<success_criteria>
1. Playwright MCP tools (navigate, click, type, screenshot) are discoverable in Nexus ToolRegistry
2. AI agent can successfully execute at least one browser automation command
3. MCP server auto-registers on app start and auto-deregisters on app stop
4. CDP is accessible only inside the container (not from host network)
5. Human verification confirms the full flow works
</success_criteria>

<output>
After completion, create `.planning/phases/v1.3-02-mcp-integration/v1.3-02-02-SUMMARY.md`
</output>
