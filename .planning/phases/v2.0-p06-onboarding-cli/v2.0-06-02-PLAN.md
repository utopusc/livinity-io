---
phase: v2.0-p06-onboarding-cli
plan: 02
type: execute
wave: 2
depends_on: ["v2.0-06-01"]
files_modified:
  - nexus/packages/cli/src/commands/onboard.ts
  - nexus/packages/cli/src/lib/secrets.ts
  - nexus/packages/cli/src/lib/env-writer.ts
  - nexus/packages/cli/src/lib/checks.ts
  - nexus/packages/cli/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Running `npx livinity onboard` launches an interactive wizard that prompts for domain, Claude auth, Telegram/Discord tokens"
    - "The wizard generates JWT_SECRET and LIV_API_KEY automatically using crypto.randomBytes"
    - "After the wizard completes, a .env file exists at the configured LIVOS_BASE_DIR with all required variables"
    - "Optional voice (Deepgram/Cartesia) and Gmail config are prompted only if user opts in"
    - "The wizard validates domain format and token presence before proceeding"
  artifacts:
    - path: "nexus/packages/cli/src/commands/onboard.ts"
      provides: "Interactive onboard command with multi-step wizard"
      contains: "onboard"
    - path: "nexus/packages/cli/src/lib/secrets.ts"
      provides: "Secure secret generation (JWT, API keys)"
      contains: "generateSecret"
    - path: "nexus/packages/cli/src/lib/env-writer.ts"
      provides: "Environment file writer with all v2.0 variables"
      contains: "writeEnvFile"
  key_links:
    - from: "nexus/packages/cli/src/commands/onboard.ts"
      to: "nexus/packages/cli/src/lib/secrets.ts"
      via: "import generateSecret"
      pattern: "generateSecret"
    - from: "nexus/packages/cli/src/commands/onboard.ts"
      to: "nexus/packages/cli/src/lib/env-writer.ts"
      via: "import writeEnvFile"
      pattern: "writeEnvFile"
    - from: "nexus/packages/cli/src/commands/onboard.ts"
      to: "nexus/packages/cli/src/lib/checks.ts"
      via: "import checkPrerequisites"
      pattern: "checkPrerequisites"
---

<objective>
Implement the interactive `livinity onboard` command that guides users through domain/SSL configuration, Claude Code authentication, channel bot tokens, optional voice/Gmail setup, secure secret generation, and .env file creation.

Purpose: This is the core wizard that turns a fresh Ubuntu server into a configured LivOS instance. It replaces the legacy `nexus/setup.ts` readline wizard with a modern @clack/prompts experience, and the bash `install.sh` wizard section with a Node.js alternative that knows about all v2.0 features (voice, canvas, webhooks, Gmail, multi-agent, etc.).

Output: A fully interactive `livinity onboard` command that collects all configuration, generates secrets, and writes a production-ready .env file.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v2.0-p06-onboarding-cli/v2.0-06-01-SUMMARY.md

Key codebase references:
@livos/.env.example — canonical env var template (all variables the .env must contain)
@nexus/setup.ts — legacy wizard for reference (NOT to copy, just for variable awareness)
@nexus/packages/core/src/config/ — runtime config pattern in nexus core
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create secret generation and env writer modules</name>
  <files>
    nexus/packages/cli/src/lib/secrets.ts
    nexus/packages/cli/src/lib/env-writer.ts
    nexus/packages/cli/package.json
  </files>
  <action>
    **Add @clack/prompts to package.json dependencies** (^0.10.0). Run npm install in cli package after.

    **src/lib/secrets.ts:**
    - Import `randomBytes` from 'node:crypto'
    - Export `generateSecret(bytes: number = 32): string` — returns hex string from randomBytes
    - Export `generateRedisPassword(): string` — 24-byte hex (48 chars), alphanumeric-safe for URLs
    - Export `generateApiKey(): string` — 32-byte hex (64 chars) for JWT_SECRET, LIV_API_KEY

    **src/lib/env-writer.ts:**
    - Export interface `EnvConfig` with all configuration fields:
      ```typescript
      interface EnvConfig {
        // Domain
        domain: string;
        useHttps: boolean;
        // Secrets (auto-generated)
        jwtSecret: string;
        apiKey: string;
        redisPassword: string;
        // Channels
        telegramBotToken?: string;
        telegramDmPolicy?: 'open' | 'pairing';
        discordBotToken?: string;
        discordApplicationId?: string;
        // Voice (optional)
        deepgramApiKey?: string;
        cartesiaApiKey?: string;
        // Gmail (optional)
        gmailClientId?: string;
        gmailClientSecret?: string;
        // Paths
        livosBaseDir: string;
        nexusBaseDir: string;
        // Ports
        apiPort: number;
        mcpPort: number;
        memoryPort: number;
      }
      ```
    - Export `writeEnvFile(filePath: string, config: EnvConfig): void`
      - Writes a well-commented .env file organized in sections:
        - Header with generation timestamp
        - AI Configuration: No GEMINI_API_KEY (v2.0 is Claude Code Auth only), no ANTHROPIC_API_KEY (subscription mode)
        - Security: JWT_SECRET, LIV_API_KEY
        - Database: REDIS_URL (with password embedded), DATABASE_URL (empty placeholder)
        - Domain: LIVOS_DOMAIN, LIVOS_USE_HTTPS
        - Server Ports: MCP_PORT, API_PORT, MEMORY_PORT
        - Service URLs: NEXUS_API_URL, MEMORY_SERVICE_URL
        - Paths: LIVOS_BASE_DIR, NEXUS_BASE_DIR
        - Channels: TELEGRAM_BOT_TOKEN, TELEGRAM_DM_POLICY, DISCORD_BOT_TOKEN, DISCORD_APPLICATION_ID
        - Voice (if configured): DEEPGRAM_API_KEY, CARTESIA_API_KEY
        - Gmail (if configured): GMAIL_CLIENT_ID, GMAIL_CLIENT_SECRET
        - Environment: NODE_ENV=production
      - Set file permissions to 600 (owner read/write only) via `chmodSync` or `writeFileSync` with mode
    - Export `backupEnvFile(filePath: string): string | null` — if file exists, copy to .env.backup.{timestamp}, return backup path

    IMPORTANT: v2.0 uses Claude Code Auth (subscription mode) — do NOT include GEMINI_API_KEY or ANTHROPIC_API_KEY. The AI runs via Claude Code SDK subscription, not API keys.
  </action>
  <verify>
    ```
    cd nexus/packages/cli && npx tsc --noEmit
    ```
    TypeScript compiles. Secret generation produces correct-length hex strings. Env writer produces well-formatted .env content.
  </verify>
  <done>Secret generation module produces cryptographically secure hex strings. Env writer creates complete v2.0 .env file with all required sections and 600 permissions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement interactive onboard wizard with @clack/prompts</name>
  <files>
    nexus/packages/cli/src/commands/onboard.ts
    nexus/packages/cli/src/index.ts
  </files>
  <action>
    **src/commands/onboard.ts:**

    Export `registerOnboardCommand(program: Command)` that registers the `onboard` command with description "Set up LivOS on this server".

    The onboard command flow:

    1. **Banner + Intro**
       - Print Livinity banner
       - Use `@clack/prompts.intro('LivOS Onboarding Wizard')` to start the wizard

    2. **Prerequisite Check**
       - Run `checkPrerequisites()` from lib/checks.ts
       - Display results with `printCheckResults()`
       - If any CRITICAL check fails (Node.js, Docker), use `@clack/prompts.cancel()` and exit
       - If non-critical checks fail (Redis, PM2), show warning but let user continue with `@clack/prompts.confirm()`

    3. **Domain Configuration** (step group)
       - `@clack/prompts.text({ message: 'What is your domain?', placeholder: 'example.com', defaultValue: 'localhost', validate: (v) => ... })`
       - Domain validation: must be valid hostname or 'localhost'
       - If domain is not 'localhost', ask: `@clack/prompts.confirm({ message: 'Enable HTTPS via Caddy/Let\'s Encrypt?' })`

    4. **Channel Configuration** (step group)
       - `@clack/prompts.confirm({ message: 'Configure Telegram bot?' })`
       - If yes: ask for TELEGRAM_BOT_TOKEN via `text()` with validation (format: digits:alphanumeric)
       - Ask for DM policy: `@clack/prompts.select({ message: 'Telegram DM policy', options: [{ value: 'pairing', label: 'Pairing (recommended)' }, { value: 'open', label: 'Open (anyone can DM)' }] })`
       - `@clack/prompts.confirm({ message: 'Configure Discord bot?' })`
       - If yes: ask for DISCORD_BOT_TOKEN and DISCORD_APPLICATION_ID

    5. **Optional Features** (step group)
       - `@clack/prompts.confirm({ message: 'Configure voice (Deepgram STT + Cartesia TTS)?' })`
       - If yes: ask for DEEPGRAM_API_KEY and CARTESIA_API_KEY via `text()`
       - `@clack/prompts.confirm({ message: 'Configure Gmail integration?' })`
       - If yes: ask for GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET with note about Google Cloud Console setup

    6. **Path Configuration** (step group)
       - `@clack/prompts.text({ message: 'LivOS base directory', defaultValue: '/opt/livos' })`
       - `@clack/prompts.text({ message: 'Nexus base directory', defaultValue: '/opt/nexus' })`
       - Port configuration with defaults (3100, 3200, 3300) — use `text()` with number validation

    7. **Secret Generation**
       - Use `@clack/prompts.spinner()` while generating secrets
       - Generate JWT_SECRET, LIV_API_KEY, Redis password via lib/secrets.ts
       - Show spinner with "Generating secure secrets..."

    8. **Summary + Confirm**
       - Display configuration summary using `@clack/prompts.note()`:
         - Domain, HTTPS, channels configured, voice enabled, Gmail enabled, paths
       - `@clack/prompts.confirm({ message: 'Write configuration and proceed?' })`

    9. **Write .env**
       - If .env exists at target, call backupEnvFile() first
       - Call writeEnvFile() with collected config
       - Show success with `@clack/prompts.log.success()`

    10. **Outro**
        - `@clack/prompts.outro('Configuration complete! Run `livinity setup` to install services.')` (setup is in Plan 03)
        - Note: Plan 03 will add the actual service setup. For now, the onboard command only writes .env.

    Handle `@clack/prompts.isCancel()` at every prompt step — if user cancels (Ctrl+C), call `cancel()` and exit cleanly.

    **Update src/index.ts:**
    - Replace the placeholder onboard command with `registerOnboardCommand(program)` import
  </action>
  <verify>
    ```
    cd nexus/packages/cli && npx tsc --noEmit
    ```
    TypeScript compiles. All prompt steps handle cancellation. The onboard command is properly registered in the CLI entrypoint.
  </verify>
  <done>Interactive `livinity onboard` wizard collects domain, channels, optional voice/Gmail, generates secrets, and writes .env. All prompts handle cancellation gracefully. Modern @clack/prompts UX with spinners, grouping, and validation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in nexus/packages/cli
2. Secret generation produces 64-char (32-byte) and 48-char (24-byte) hex strings
3. Env writer produces .env file with all v2.0 required sections
4. Onboard command handles all 9 requirements: CLI-01 (guided setup), CLI-03 (domain/auth/tokens), CLI-04 (voice/Gmail), CLI-05 (secrets + .env)
5. Every @clack/prompts call checks for isCancel()
6. No GEMINI_API_KEY or ANTHROPIC_API_KEY in generated .env (v2.0 is Claude Code Auth only)
</verification>

<success_criteria>
- `livinity onboard` launches interactive wizard with @clack/prompts
- Domain, channels, voice, Gmail configuration collected through modern prompts
- Secrets auto-generated via crypto.randomBytes
- .env file written with all v2.0 variables, 600 permissions
- Existing .env backed up before overwrite
- All prompts validate input and handle Ctrl+C cancellation
</success_criteria>

<output>
After completion, create `.planning/phases/v2.0-p06-onboarding-cli/v2.0-06-02-SUMMARY.md`
</output>
