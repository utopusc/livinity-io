---
phase: v2.0-p06-onboarding-cli
plan: 03
subsystem: cli
tags: [pm2, rollback, setup, non-interactive, health-check, ecosystem]

# Dependency graph
requires:
  - phase: v2.0-p06-onboarding-cli (plan 02)
    provides: interactive wizard, secrets generator, env-writer
provides:
  - PM2 ecosystem config generator for all 5 services
  - RollbackStack for partial failure cleanup
  - Service setup pipeline (install, build, symlink, PM2, health check)
  - Non-interactive mode via --config setup.json
  - Standalone `livinity setup` command
affects: [deployment, server-setup]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "RollbackStack LIFO pattern for transactional CLI operations"
    - "Non-interactive config file mode for automated deployments"
    - "TCP port health verification for service readiness"
    - "PM2 ecosystem generation from runtime config"

key-files:
  created:
    - nexus/packages/cli/src/lib/pm2.ts
    - nexus/packages/cli/src/lib/rollback.ts
    - nexus/packages/cli/src/commands/setup.ts
    - nexus/packages/cli/src/lib/config-file.ts
  modified:
    - nexus/packages/cli/src/commands/onboard.ts
    - nexus/packages/cli/src/index.ts

key-decisions:
  - "PM2 ecosystem generated as CJS with runtime venv detection for Python interpreter"
  - "RollbackStack continues on individual undo failure (logs warning, does not abort)"
  - "Config file mode auto-generates secrets (JWT, API key, Redis password)"
  - ".env rollback restores backup if one existed rather than deleting"

patterns-established:
  - "SetupJsonConfig interface for declarative server provisioning"
  - "runSetup() exported for both standalone command and onboard integration"
  - "printHealthResults() shared between setup and onboard completion"

# Metrics
duration: 5min
completed: 2026-02-21
---

# Phase 6 Plan 03: Setup Command + Resilience Summary

**PM2 ecosystem generator, rollback stack, service setup pipeline, and non-interactive onboard mode via --config**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-21T03:14:17Z
- **Completed:** 2026-02-21T03:19:17Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- PM2 ecosystem generator creates config for all 5 services (livos, nexus-core, nexus-worker, nexus-memory, nexus-mcp) with correct paths, memory limits, and backoff settings
- RollbackStack provides LIFO cleanup: if any step in setup fails, all prior state (files, services, venvs) is undone in reverse order
- Full setup pipeline: install deps -> build packages -> symlink -> generate ecosystem -> start PM2 -> verify health
- Non-interactive mode: `livinity onboard --config setup.json` does full install without prompts
- Interactive wizard now offers to run setup immediately after writing .env
- Standalone `livinity setup` command for re-running service setup independently

## Task Commits

Each task was committed atomically:

1. **Task 1: PM2 ecosystem generator, rollback stack, and setup command** - `6047b9d` (feat)
2. **Task 2: Non-interactive mode and wire setup into onboard command** - `3f96764` (feat)

## Files Created/Modified
- `nexus/packages/cli/src/lib/pm2.ts` - PM2 ecosystem generation, service start/stop, TCP health verification
- `nexus/packages/cli/src/lib/rollback.ts` - RollbackStack class with LIFO undo execution
- `nexus/packages/cli/src/commands/setup.ts` - 15-step setup pipeline with rollback integration
- `nexus/packages/cli/src/lib/config-file.ts` - SetupJsonConfig loader and EnvConfig converter
- `nexus/packages/cli/src/commands/onboard.ts` - Added --config option, setup integration, completion banner
- `nexus/packages/cli/src/index.ts` - Registered setup command

## Decisions Made
- PM2 ecosystem uses CJS format with runtime fs.existsSync check for Python venv path (handles both venv and system python3)
- RollbackStack logs warnings on individual undo failures but continues with remaining undos (fault-tolerant cleanup)
- Non-interactive config file auto-generates secrets rather than requiring them in the JSON (security by default)
- .env rollback strategy: restore backup if one existed, rather than deleting (preserves user's previous config)
- Setup steps 8 and 9 (worker, MCP build) are optional â€” caught errors don't abort the pipeline

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- v2.0 Phase 6 (Onboarding CLI) is now COMPLETE: all 3 plans executed
- Full CLI: `livinity status`, `livinity onboard`, `livinity onboard --config setup.json`, `livinity setup`
- v2.0 milestone is complete (all 6 phases, 23 plans)

---
*Phase: v2.0-p06-onboarding-cli*
*Completed: 2026-02-21*
