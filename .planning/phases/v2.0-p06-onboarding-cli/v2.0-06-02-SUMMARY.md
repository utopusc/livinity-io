---
phase: v2.0-p06-onboarding-cli
plan: 02
subsystem: cli
tags: [clack-prompts, onboarding, wizard, env-writer, crypto, secrets]

# Dependency graph
requires:
  - phase: v2.0-06-01
    provides: CLI scaffold with commander, checks.ts, ui.ts
provides:
  - Interactive `livinity onboard` wizard with @clack/prompts
  - Cryptographic secret generation (JWT, API key, Redis password)
  - .env file writer with all v2.0 sections and 600 permissions
  - Env file backup before overwrite
affects: [v2.0-06-03]

# Tech tracking
tech-stack:
  added: ["@clack/prompts ^0.10.0"]
  patterns: ["guard() cancel pattern for @clack/prompts type narrowing", "EnvConfig interface for typed env generation"]

key-files:
  created:
    - nexus/packages/cli/src/commands/onboard.ts
    - nexus/packages/cli/src/lib/secrets.ts
    - nexus/packages/cli/src/lib/env-writer.ts
  modified:
    - nexus/packages/cli/src/index.ts
    - nexus/packages/cli/package.json

key-decisions:
  - "guard<T>() pattern for @clack/prompts cancel handling — wraps every prompt, exits on cancel, returns typed value"
  - "No GEMINI_API_KEY or ANTHROPIC_API_KEY in .env — v2.0 is Claude Code Auth (subscription mode) only"
  - "Redis password embedded in REDIS_URL (hex-only chars, no URL-encoding needed)"
  - "500ms spinner delay for secret generation UX (crypto is instant but spinner gives visual feedback)"

patterns-established:
  - "guard() pattern: generic cancel guard for @clack/prompts that narrows symbol|T to T"
  - "EnvConfig interface: typed configuration passed to writeEnvFile() for all v2.0 variables"
  - "Sectioned .env output: AI, Security, Database, Domain, Ports, URLs, Paths, Channels, Voice, Gmail, Environment"

# Metrics
duration: 4min
completed: 2026-02-21
---

# Phase 6 Plan 02: Onboard Wizard Summary

**Interactive @clack/prompts onboarding wizard with crypto secret generation, domain/channel/voice/Gmail configuration, and .env writer with 600 permissions**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-21T03:06:57Z
- **Completed:** 2026-02-21T03:11:22Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Interactive multi-step wizard collecting domain, channels, voice, Gmail, paths, and ports
- Cryptographic secret generation: 32-byte JWT/API keys, 24-byte Redis password (hex-safe)
- Well-commented .env writer with all v2.0 sections, 600 permissions, backup before overwrite
- Every prompt handles Ctrl+C cancellation via generic guard() pattern
- No API keys in generated .env (v2.0 is Claude Code Auth subscription mode)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create secret generation and env writer modules** - `096c0fd` (feat)
2. **Task 2: Implement interactive onboard wizard with @clack/prompts** - `661e3bd` (feat)

## Files Created/Modified
- `nexus/packages/cli/src/lib/secrets.ts` - Crypto-secure secret generation (generateSecret, generateApiKey, generateRedisPassword)
- `nexus/packages/cli/src/lib/env-writer.ts` - EnvConfig interface + writeEnvFile() + backupEnvFile()
- `nexus/packages/cli/src/commands/onboard.ts` - Full interactive wizard (10 steps: banner, prereqs, domain, channels, voice/Gmail, paths, secrets, summary, write, outro)
- `nexus/packages/cli/src/index.ts` - Replace placeholder onboard with registerOnboardCommand()
- `nexus/packages/cli/package.json` - Added @clack/prompts dependency

## Decisions Made
- Used `guard<T>()` generic function pattern instead of assertion-style `guardCancel()` — @clack/prompts returns `T | symbol`, and TypeScript assertion functions don't narrow union types well. The generic approach returns the unwrapped value directly.
- Redis password uses hex-only characters (generateRedisPassword → 24-byte hex) so it can be safely embedded in REDIS_URL without URL-encoding.
- Service URLs in .env use localhost (not domain) since services are co-located on the same server.
- Brief 500ms spinner delay added during secret generation for UX feedback (crypto.randomBytes is synchronous and instant).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- TypeScript type narrowing issue with @clack/prompts: assertion-style `guardCancel()` didn't properly narrow `string | symbol` to `string` in subsequent code. Resolved by switching to a generic `guard<T>()` function that returns the unwrapped value, eliminating all 23 type errors.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Onboard wizard complete, ready for Plan 03 (setup command: service installation, PM2 ecosystem, systemd units)
- The `livinity onboard` outro already references `livinity setup` (Plan 03)
- All v2.0 env variables covered in EnvConfig interface

---
*Phase: v2.0-p06-onboarding-cli*
*Completed: 2026-02-21*
