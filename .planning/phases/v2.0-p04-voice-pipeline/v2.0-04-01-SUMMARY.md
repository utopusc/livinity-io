# Phase 4 Plan 01: Voice WebSocket Gateway Summary

**One-liner:** Binary /ws/voice WebSocket gateway with VoiceSession state machine, JWT/API key auth, and Deepgram/Cartesia config schema

## What Was Done

### Task 1: Voice config schema + VoiceSession state machine
- Added `VoiceConfigSchema` to `nexus/packages/core/src/config/schema.ts` with fields: `enabled`, `deepgramApiKey`, `cartesiaApiKey`, `cartesiaVoiceId`, `cartesiaModelId`, `sttLanguage`, `sttModel`
- Added `voice` field to `NexusConfigSchema` and `DEFAULT_NEXUS_CONFIG`
- Exported `VoiceConfig` type
- Created `nexus/packages/core/src/voice/voice-session.ts` (245 lines):
  - `VoiceState` type: `idle | listening | processing | speaking`
  - `VoiceSession` class extending EventEmitter with state machine
  - Valid transitions enforced: idle->listening, listening->processing, processing->speaking, speaking->idle, any->idle (reset)
  - Binary audio routing via `handleBinaryMessage()` (only in listening state)
  - JSON control messages: `start-listening`, `stop-listening`, `cancel`
  - `sendAudio()` for outbound binary frames, `sendControl()` for JSON text frames
  - Keep-alive ping interval (25s default)
  - Clean `close()` lifecycle with event emission

### Task 2: VoiceGateway + wire into nexus-core startup
- Created `nexus/packages/core/src/voice/index.ts` (195 lines):
  - `VoiceGateway` class with `noServer: true` WebSocket upgrade handling
  - Listens on `/ws/voice` path (coexists with WsGateway `/ws/agent`)
  - Authentication: X-API-Key header, JWT query param, Sec-WebSocket-Protocol JWT fallback
  - Creates `VoiceSession` per connection, stores in Map, sends initial `{ type: 'connected', sessionId }` control message
  - Routes binary vs text messages to session handlers
  - Graceful shutdown via `stop()` method
  - Re-exports VoiceSession types
- Wired into `nexus/packages/core/src/index.ts`:
  - Import `VoiceGateway` from `./voice/index.js`
  - Instantiate after WsGateway: `new VoiceGateway(httpServer, { redis, daemon })`
  - Added `voiceGateway.stop()` to shutdown sequence (before wsGateway.stop())

## Commits

| # | Hash | Message |
|---|------|---------|
| 1 | b90bec0 | feat(v2.0-04-01): voice config schema + VoiceSession state machine |
| 2 | 51cb23c | feat(v2.0-04-01): VoiceGateway + wire into nexus-core startup |

## Verification Results

1. TypeScript compiles: `npx tsc --noEmit` passes with zero errors
2. VoiceConfigSchema in NexusConfigSchema: `voice: VoiceConfigSchema` present
3. VoiceGateway handles /ws/voice: path check on line 45
4. VoiceSession has all 4 states: `idle | listening | processing | speaking`
5. Startup wiring: VoiceGateway instantiation and shutdown in index.ts

## Deviations from Plan

None -- plan executed exactly as written.

## Files

### Created
- `nexus/packages/core/src/voice/voice-session.ts` (245 lines)
- `nexus/packages/core/src/voice/index.ts` (195 lines)

### Modified
- `nexus/packages/core/src/config/schema.ts` (+21 lines: VoiceConfigSchema, voice field, default, type export)
- `nexus/packages/core/src/index.ts` (+4 lines: import, instantiation, shutdown, log)

## Decisions Made

| Decision | Context | Choice |
|----------|---------|--------|
| Auth strategy | How to authenticate /ws/voice | Same as WsGateway: X-API-Key, JWT query, Sec-WebSocket-Protocol |
| Keep-alive interval | Proxy timeout prevention | 25s (under typical 30s proxy timeout) |
| State reset | How to handle cancel/error | Any state can transition to idle (graceful reset) |
| Audio routing | When to process binary data | Only in 'listening' state; other states ignore binary frames |

## Duration

~3 minutes (2026-02-20T23:49:06Z to 2026-02-20T23:52:06Z)

## Next Phase Readiness

Plan 02 (STT integration) can proceed immediately:
- VoiceSession emits `'audio-in'` events that DeepgramRelay will consume
- VoiceSession has `sendControl()` for transcript delivery
- Config schema has `deepgramApiKey`, `sttLanguage`, `sttModel` fields ready
- State machine transitions listening->processing ready for transcript-complete signal

Plan 03 (TTS integration) can proceed immediately:
- VoiceSession has `sendAudio()` for binary TTS output to browser
- VoiceSession transitions processing->speaking->idle for TTS lifecycle
- Config schema has `cartesiaApiKey`, `cartesiaVoiceId`, `cartesiaModelId` fields ready
