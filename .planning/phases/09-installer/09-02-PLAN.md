---
phase: 09-installer
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - livos/install.sh
autonomous: true

must_haves:
  truths:
    - "User can configure domain interactively via whiptail"
    - "User can optionally enter Gemini API key during install"
    - "User can enable/disable optional features (WhatsApp, HTTPS)"
    - "Non-interactive mode uses sensible defaults without prompts"
  artifacts:
    - path: "livos/install.sh"
      provides: "Interactive configuration wizard"
      contains: "whiptail"
      contains: "wizard_"
  key_links:
    - from: "livos/install.sh wizard_input()"
      to: "whiptail --inputbox"
      via: "TUI dialog"
      pattern: "whiptail.*--inputbox"
    - from: "livos/install.sh wizard_yesno()"
      to: "whiptail --yesno"
      via: "TUI confirmation"
      pattern: "whiptail.*--yesno"
---

<objective>
Add an interactive configuration wizard using whiptail with fallback for non-TTY environments.

Purpose: Allow users to customize their installation (domain, API keys, features) through a friendly TUI interface, while supporting non-interactive installation with defaults for automation.

Output: install.sh enhanced with wizard functions and configuration flow that collects: domain, HTTPS preference, Gemini API key, and optional feature toggles.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-installer/09-RESEARCH.md
@.planning/phases/09-installer/09-01-SUMMARY.md
@livos/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TTY detection and wizard helper functions</name>
  <files>livos/install.sh</files>
  <action>
Add wizard helper functions inside main(), after the helper functions but before installation steps.

```bash
# ── Wizard Helpers ────────────────────────────────────────

# Detect if running interactively
detect_tty() {
    if [[ -t 0 ]] && [[ -t 1 ]]; then
        HAS_TTY=true
    else
        HAS_TTY=false
        info "Non-interactive mode detected - using defaults"
    fi
}

# Check if whiptail is available
check_whiptail() {
    if command -v whiptail &>/dev/null; then
        HAS_WHIPTAIL=true
    else
        HAS_WHIPTAIL=false
        if $HAS_TTY; then
            info "whiptail not found - using text prompts"
        fi
    fi
}

# Input dialog - returns user input or default
wizard_input() {
    local title="$1"
    local prompt="$2"
    local default="$3"

    if $HAS_TTY && $HAS_WHIPTAIL; then
        local result
        result=$(whiptail --title "$title" --inputbox "$prompt" 10 60 "$default" 3>&1 1>&2 2>&3) || true
        echo "${result:-$default}"
    elif $HAS_TTY; then
        local value
        read -rp "$prompt [$default]: " value
        echo "${value:-$default}"
    else
        echo "$default"
    fi
}

# Password input - hidden characters
wizard_password() {
    local title="$1"
    local prompt="$2"

    if $HAS_TTY && $HAS_WHIPTAIL; then
        local result
        result=$(whiptail --title "$title" --passwordbox "$prompt" 10 60 3>&1 1>&2 2>&3) || true
        echo "$result"
    elif $HAS_TTY; then
        local value
        read -rsp "$prompt: " value
        echo ""  # newline after hidden input
        echo "$value"
    else
        echo ""  # empty in non-interactive
    fi
}

# Yes/No dialog - returns 0 for yes, 1 for no
wizard_yesno() {
    local title="$1"
    local prompt="$2"
    local default="${3:-no}"  # default to no

    if $HAS_TTY && $HAS_WHIPTAIL; then
        if [[ "$default" == "yes" ]]; then
            whiptail --title "$title" --yesno "$prompt" 10 60 --defaultno
            return $?
        else
            whiptail --title "$title" --yesno "$prompt" 10 60
            return $?
        fi
    elif $HAS_TTY; then
        local answer
        if [[ "$default" == "yes" ]]; then
            read -rp "$prompt [Y/n]: " answer
            [[ ! "$answer" =~ ^[Nn] ]]
        else
            read -rp "$prompt [y/N]: " answer
            [[ "$answer" =~ ^[Yy] ]]
        fi
    else
        [[ "$default" == "yes" ]]
    fi
}

# Info message box
wizard_msgbox() {
    local title="$1"
    local message="$2"

    if $HAS_TTY && $HAS_WHIPTAIL; then
        whiptail --title "$title" --msgbox "$message" 12 60
    elif $HAS_TTY; then
        echo -e "\n$title\n$message\n"
        read -rp "Press Enter to continue..."
    fi
}
```

Call detect_tty and check_whiptail after pre-flight checks:
```bash
detect_tty
check_whiptail
```
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has wizard_input, wizard_password, wizard_yesno, wizard_msgbox functions with TTY and whiptail detection</done>
</task>

<task type="auto">
  <name>Task 2: Implement configuration wizard flow</name>
  <files>livos/install.sh</files>
  <action>
Add the main configuration wizard function that collects all user settings.

Add this function inside main():

```bash
# ── Configuration Wizard ──────────────────────────────────

run_configuration_wizard() {
    step "Configuration Wizard"

    # Initialize defaults
    CONFIG_DOMAIN="localhost"
    CONFIG_USE_HTTPS="false"
    CONFIG_GEMINI_KEY=""
    CONFIG_WHATSAPP="false"

    if ! $HAS_TTY; then
        info "Using default configuration (non-interactive)"
        return 0
    fi

    # Welcome message
    wizard_msgbox "LivOS Installer" \
        "Welcome to LivOS!\n\nThis wizard will help you configure your installation.\n\nYou can change these settings later in the Settings panel."

    # Domain configuration
    CONFIG_DOMAIN=$(wizard_input "Domain Setup" \
        "Enter your domain name:\n\n(Use 'localhost' for local-only access)" \
        "localhost")

    # HTTPS configuration (only if not localhost)
    if [[ "$CONFIG_DOMAIN" != "localhost" ]]; then
        if wizard_yesno "HTTPS Setup" \
            "Enable automatic HTTPS via Let's Encrypt?\n\nRequires:\n- Domain DNS pointing to this server\n- Ports 80/443 open"; then
            CONFIG_USE_HTTPS="true"
        fi
    fi

    # AI API Key
    if wizard_yesno "AI Configuration" \
        "Configure a Gemini API key now?\n\n(You can also add this later in Settings > AI Configuration)\n\nGet a key at: https://aistudio.google.com/app/apikey"; then
        CONFIG_GEMINI_KEY=$(wizard_input "Gemini API Key" \
            "Enter your Gemini API key:" \
            "")
    fi

    # Optional features
    if wizard_yesno "WhatsApp Integration" \
        "Enable WhatsApp integration?\n\n(Requires WhatsApp Business API setup)\n\nMost users skip this initially." \
        "no"; then
        CONFIG_WHATSAPP="true"
    fi

    # Summary
    local summary="Configuration Summary:\n\n"
    summary+="Domain: $CONFIG_DOMAIN\n"
    summary+="HTTPS: $CONFIG_USE_HTTPS\n"
    summary+="Gemini API Key: $([ -n "$CONFIG_GEMINI_KEY" ] && echo "Configured" || echo "Not set")\n"
    summary+="WhatsApp: $CONFIG_WHATSAPP"

    wizard_msgbox "Configuration Complete" "$summary"

    ok "Configuration collected"
}
```

Call run_configuration_wizard() after dependency installation but before repository setup:

```bash
# After dependencies are installed
run_configuration_wizard
```

The CONFIG_* variables will be used in the next plan to generate the .env file.
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has run_configuration_wizard() that collects CONFIG_DOMAIN, CONFIG_USE_HTTPS, CONFIG_GEMINI_KEY, CONFIG_WHATSAPP</done>
</task>

<task type="auto">
  <name>Task 3: Add secret generation and .env file creation</name>
  <files>livos/install.sh</files>
  <action>
Add secret generation and .env file writing functions.

```bash
# ── Secret Generation ─────────────────────────────────────

generate_secrets() {
    info "Generating secure secrets..."

    # 256-bit secrets (64 hex chars)
    SECRET_JWT=$(openssl rand -hex 32)
    SECRET_API_KEY=$(openssl rand -hex 32)
    SECRET_REDIS=$(openssl rand -hex 24)

    # Verify generation
    if [[ ${#SECRET_JWT} -ne 64 ]] || [[ ${#SECRET_API_KEY} -ne 64 ]]; then
        fail "Failed to generate secure secrets - openssl error"
    fi

    ok "Secrets generated"
}

# ── Environment File ──────────────────────────────────────

write_env_file() {
    local env_file="$LIVOS_DIR/.env"

    if [[ -f "$env_file" ]]; then
        if $HAS_TTY; then
            if wizard_yesno "Existing Configuration" \
                "An existing .env file was found.\n\nOverwrite with new configuration?\n\n(Backup will be created as .env.backup)"; then
                cp "$env_file" "${env_file}.backup"
                info "Backup created: .env.backup"
            else
                ok "Preserving existing .env"
                return 0
            fi
        else
            ok "Preserving existing .env (non-interactive)"
            return 0
        fi
    fi

    info "Writing .env configuration..."

    cat > "$env_file" << ENVFILE
# ==============================================================================
# LIVINITY ENVIRONMENT CONFIGURATION
# ==============================================================================
# Generated by install.sh on $(date -Iseconds)
# ==============================================================================

# === AI API Keys ===
GEMINI_API_KEY=${CONFIG_GEMINI_KEY:-}
ANTHROPIC_API_KEY=

# === Security ===
JWT_SECRET=${SECRET_JWT}
LIV_API_KEY=${SECRET_API_KEY}

# === Database ===
REDIS_URL=redis://:${SECRET_REDIS}@localhost:6379
DATABASE_URL=

# === Domain ===
LIVOS_DOMAIN=${CONFIG_DOMAIN:-localhost}
LIVOS_USE_HTTPS=${CONFIG_USE_HTTPS:-false}

# === Server Ports ===
MCP_PORT=3100
API_PORT=3200
MEMORY_PORT=3300

# === Daemon Configuration ===
DAEMON_INTERVAL_MS=30000
DEFAULT_MODEL=gemini-2.0-flash

# === Service URLs ===
NEXUS_API_URL=http://localhost:3200
MEMORY_SERVICE_URL=http://localhost:3300

# === Integrations ===
WHATSAPP_ENABLED=${CONFIG_WHATSAPP:-false}

# === Environment ===
NODE_ENV=production
ENVFILE

    chmod 600 "$env_file"
    ok ".env created with secure permissions (600)"
}
```

Call these after run_configuration_wizard():
```bash
generate_secrets
```

And call write_env_file() after repository setup (needs LIVOS_DIR to exist).
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has generate_secrets() and write_env_file() that create .env with wizard inputs and auto-generated secrets</done>
</task>

</tasks>

<verification>
1. `bash -n livos/install.sh` returns 0 (no syntax errors)
2. Script contains detect_tty() and HAS_TTY variable
3. Script contains wizard_input(), wizard_password(), wizard_yesno(), wizard_msgbox()
4. Script contains run_configuration_wizard() that sets CONFIG_* variables
5. Script contains generate_secrets() that uses openssl rand -hex
6. Script contains write_env_file() that creates .env from wizard inputs
7. Non-interactive mode skips wizard and uses defaults
</verification>

<success_criteria>
- Wizard functions work with whiptail when available
- Wizard functions fall back to read prompts when whiptail unavailable
- Non-interactive (piped) execution uses sensible defaults without hanging
- Configuration collects: domain, HTTPS preference, Gemini key, WhatsApp toggle
- Secrets are generated with openssl rand -hex 32
- .env file is written with correct permissions (600)
- Existing .env can be preserved or backed up
</success_criteria>

<output>
After completion, create `.planning/phases/09-installer/09-02-SUMMARY.md`
</output>
