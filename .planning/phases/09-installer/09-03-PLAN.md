---
phase: 09-installer
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - livos/install.sh
autonomous: false

must_haves:
  truths:
    - "systemd service file exists for LivOS daemon"
    - "systemd service starts LivOS on boot"
    - "Services can be managed via systemctl start/stop/status livos"
    - "Fresh install works end-to-end on Ubuntu 22.04"
  artifacts:
    - path: "livos/install.sh"
      provides: "Complete one-command installer"
      contains: "systemctl enable"
      min_lines: 400
  key_links:
    - from: "livos/install.sh create_systemd_service()"
      to: "/etc/systemd/system/livos.service"
      via: "cat heredoc"
      pattern: "/etc/systemd/system/livos.service"
    - from: "livos/install.sh"
      to: "systemctl daemon-reload"
      via: "reload systemd"
      pattern: "systemctl daemon-reload"
---

<objective>
Add systemd service unit generation, Redis configuration, repository setup, and final installation steps to complete the installer.

Purpose: Finish the installer with production-grade service management via systemd (with PM2 as fallback for development), proper Redis configuration, and complete the installation flow from start to running services.

Output: Complete install.sh that can be run with `curl | bash` to fully set up LivOS on Ubuntu 22.04.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-installer/09-RESEARCH.md
@.planning/phases/09-installer/09-01-SUMMARY.md
@.planning/phases/09-installer/09-02-SUMMARY.md
@livos/ecosystem.config.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add repository setup and build functions</name>
  <files>livos/install.sh</files>
  <action>
Add functions to clone/update the repository and build the project.

```bash
# ── Repository Setup ──────────────────────────────────────

setup_repository() {
    step "Setting up repository"

    if [[ -d "$LIVOS_DIR/.git" ]]; then
        info "Repository exists, pulling latest..."
        cd "$LIVOS_DIR"
        git pull --ff-only || warn "Git pull failed, continuing with existing code"
        ok "Repository updated"
    else
        info "Cloning repository..."
        if [[ -d "$LIVOS_DIR" ]]; then
            warn "Directory exists but no git repo - using existing files"
        else
            git clone "$REPO_URL" "$LIVOS_DIR" || fail "Failed to clone repository"
        fi
        ok "Repository ready"
    fi

    cd "$LIVOS_DIR"
}

# ── Build Project ─────────────────────────────────────────

build_project() {
    step "Building project"

    cd "$LIVOS_DIR"

    # Install LivOS dependencies (pnpm workspaces)
    info "Installing LivOS dependencies..."
    pnpm install --frozen-lockfile 2>/dev/null || pnpm install
    ok "LivOS dependencies installed"

    # Install Liv dependencies (npm workspaces)
    local liv_dir="$LIVOS_DIR/packages/liv"
    if [[ -d "$liv_dir" ]]; then
        info "Installing Liv dependencies..."
        cd "$liv_dir"
        npm install --production=false
        cd "$LIVOS_DIR"
        ok "Liv dependencies installed"
    fi

    # Python venv for memory service
    local memory_dir="$liv_dir/packages/memory"
    if [[ -f "$memory_dir/src/requirements.txt" ]]; then
        info "Setting up Python venv for memory service..."
        if [[ ! -d "$memory_dir/venv" ]]; then
            python3 -m venv "$memory_dir/venv"
        fi
        "$memory_dir/venv/bin/pip" install -q -r "$memory_dir/src/requirements.txt"
        ok "Python venv ready"
    fi

    # Build Liv TypeScript
    if [[ -d "$liv_dir" ]]; then
        info "Building Liv..."
        cd "$liv_dir"
        npm run build
        cd "$LIVOS_DIR"
        ok "Liv built"
    fi

    # Create directories
    mkdir -p "$LIVOS_DIR/logs"
    mkdir -p "$LIVOS_DIR/data"
    ok "Directories created"
}
```
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has setup_repository() and build_project() functions</done>
</task>

<task type="auto">
  <name>Task 2: Add systemd service creation and Redis configuration</name>
  <files>livos/install.sh</files>
  <action>
Add systemd service unit generation and Redis configuration functions.

```bash
# ── Redis Configuration ───────────────────────────────────

configure_redis() {
    step "Configuring Redis"

    local redis_conf="/etc/redis/redis.conf"

    if [[ ! -f "$redis_conf" ]]; then
        warn "Redis config not found at $redis_conf - skipping"
        return 0
    fi

    # Set password
    if grep -q '^requirepass' "$redis_conf"; then
        sed -i "s|^requirepass.*|requirepass $SECRET_REDIS|" "$redis_conf"
    else
        echo "requirepass $SECRET_REDIS" >> "$redis_conf"
    fi

    # Enable AOF persistence
    if grep -q '^appendonly' "$redis_conf"; then
        sed -i 's|^appendonly.*|appendonly yes|' "$redis_conf"
    else
        echo 'appendonly yes' >> "$redis_conf"
    fi

    systemctl restart redis-server
    ok "Redis configured with password + AOF"
}

# ── Systemd Services ──────────────────────────────────────

create_systemd_service() {
    step "Creating systemd service"

    # Create livos user if not exists
    if ! id -u livos &>/dev/null; then
        useradd --system --no-create-home --shell /bin/false livos
        ok "Created livos system user"
    fi

    # Set ownership
    chown -R livos:livos "$LIVOS_DIR"

    # Create main service unit
    cat > /etc/systemd/system/livos.service << 'UNIT'
[Unit]
Description=LivOS Server
Documentation=https://github.com/utopusc/livos
After=network-online.target redis.service
Wants=network-online.target
Requires=redis.service

[Service]
Type=simple
User=livos
Group=livos
WorkingDirectory=/opt/livos/packages/livinityd
ExecStart=/usr/bin/npx tsx source/cli.ts --data-directory /opt/livos/data --port 8080
Restart=on-failure
RestartSec=5
Environment=NODE_ENV=production
EnvironmentFile=/opt/livos/.env

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/livos/data /opt/livos/logs

[Install]
WantedBy=multi-user.target
UNIT

    # Create liv-core service
    cat > /etc/systemd/system/liv-core.service << 'UNIT'
[Unit]
Description=Liv AI Core
After=network-online.target redis.service livos.service
Wants=network-online.target
Requires=redis.service

[Service]
Type=simple
User=livos
Group=livos
WorkingDirectory=/opt/livos/packages/liv
ExecStart=/usr/bin/node packages/core/dist/index.js
Restart=on-failure
RestartSec=5
Environment=NODE_ENV=production
Environment=DAEMON_INTERVAL_MS=30000
EnvironmentFile=/opt/livos/.env

NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/livos/data /opt/livos/logs

[Install]
WantedBy=multi-user.target
UNIT

    # Create liv-memory service (Python)
    cat > /etc/systemd/system/liv-memory.service << 'UNIT'
[Unit]
Description=Liv Memory Service
After=network-online.target redis.service
Wants=network-online.target
Requires=redis.service

[Service]
Type=simple
User=livos
Group=livos
WorkingDirectory=/opt/livos/packages/liv
ExecStart=/opt/livos/packages/liv/packages/memory/venv/bin/python3 packages/memory/src/server.py
Restart=on-failure
RestartSec=5
Environment=MEMORY_PORT=3300
EnvironmentFile=/opt/livos/.env

NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/livos/data /opt/livos/logs

[Install]
WantedBy=multi-user.target
UNIT

    # Create liv-worker service
    cat > /etc/systemd/system/liv-worker.service << 'UNIT'
[Unit]
Description=Liv Worker
After=network-online.target redis.service liv-core.service
Wants=network-online.target
Requires=redis.service

[Service]
Type=simple
User=livos
Group=livos
WorkingDirectory=/opt/livos/packages/liv
ExecStart=/usr/bin/node packages/worker/dist/index.js
Restart=on-failure
RestartSec=5
Environment=NODE_ENV=production
EnvironmentFile=/opt/livos/.env

NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/livos/data /opt/livos/logs

[Install]
WantedBy=multi-user.target
UNIT

    # Reload and enable services
    systemctl daemon-reload
    systemctl enable livos.service liv-core.service liv-memory.service liv-worker.service

    ok "Systemd services created and enabled"
}

start_services() {
    step "Starting services"

    systemctl start liv-memory.service
    systemctl start livos.service
    systemctl start liv-core.service
    systemctl start liv-worker.service

    # Check if services started
    sleep 2
    if systemctl is-active --quiet livos.service; then
        ok "LivOS service running"
    else
        warn "LivOS service may not have started correctly - check: journalctl -u livos.service"
    fi

    ok "All services started"
}
```
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has configure_redis(), create_systemd_service(), start_services() functions</done>
</task>

<task type="auto">
  <name>Task 3: Complete installation flow and add banner</name>
  <files>livos/install.sh</files>
  <action>
Complete the main() function by orchestrating all steps in order, and add the final banner.

Update main() to call all functions in the correct order:

```bash
main() {
    set -euo pipefail

    # Constants
    LIVOS_DIR="/opt/livos"
    REPO_URL="https://github.com/utopusc/livos.git"

    # ... [colors and helper functions already added in 09-01] ...

    # ERR trap
    trap 'cleanup_on_error $LINENO' ERR

    # === Pre-flight ===
    step "Pre-flight checks"
    check_root
    detect_os
    detect_arch
    detect_tty
    check_whiptail

    # === Dependencies ===
    step "Installing system dependencies"
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -qq
    install_build_tools
    install_nodejs
    install_pnpm
    install_pm2
    install_redis
    install_docker
    install_python
    ok "All system dependencies ready"

    # === Configuration ===
    run_configuration_wizard
    generate_secrets

    # === Repository ===
    setup_repository

    # === Environment ===
    write_env_file

    # === Redis ===
    configure_redis

    # === Build ===
    build_project

    # === Symlink .env for Liv ===
    local liv_dir="$LIVOS_DIR/packages/liv"
    if [[ -d "$liv_dir" ]] && [[ ! -L "$liv_dir/.env" ]]; then
        ln -sf ../../.env "$liv_dir/.env"
        ok "Liv .env symlinked"
    fi

    # === Services ===
    create_systemd_service
    start_services

    # === Firewall ===
    configure_firewall

    # === Done ===
    show_banner
}
```

Add firewall configuration:

```bash
configure_firewall() {
    step "Configuring firewall"

    if command -v ufw &>/dev/null; then
        ufw --force enable 2>/dev/null || true
        ufw allow 22/tcp   2>/dev/null || true   # SSH
        ufw allow 8080/tcp 2>/dev/null || true   # LivOS UI
        ufw default deny incoming 2>/dev/null || true
        ufw reload 2>/dev/null || true
        ok "UFW: SSH(22) + LivOS(8080) allowed"
    else
        warn "UFW not found - configure your firewall manually"
    fi
}
```

Add the final banner:

```bash
show_banner() {
    local server_ip
    server_ip=$(hostname -I | awk '{print $1}')

    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  LivOS installed successfully!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "  Web UI:      ${CYAN}http://${server_ip}:8080${NC}"
    if [[ "${CONFIG_DOMAIN:-localhost}" != "localhost" ]]; then
        local protocol="http"
        [[ "${CONFIG_USE_HTTPS:-false}" == "true" ]] && protocol="https"
        echo -e "  Domain:      ${CYAN}${protocol}://${CONFIG_DOMAIN}${NC}"
    fi
    echo ""
    echo -e "  ${YELLOW}Service Management:${NC}"
    echo -e "    systemctl status livos        - check status"
    echo -e "    systemctl restart livos       - restart"
    echo -e "    journalctl -u livos -f        - view logs"
    echo ""
    if [[ -z "${CONFIG_GEMINI_KEY:-}" ]]; then
        echo -e "  ${YELLOW}Next step:${NC} Open Settings > AI Configuration"
        echo -e "  and add your Gemini API key."
        echo ""
    fi
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}
```

Ensure the script ends with:
```bash
# Prevent partial execution from curl | bash
main "$@"
```
  </action>
  <verify>bash -n livos/install.sh (syntax check)</verify>
  <done>install.sh has complete main() orchestration, configure_firewall(), show_banner(), and main "$@" at end</done>
</task>

</tasks>

<verification>
1. `bash -n livos/install.sh` returns 0 (no syntax errors)
2. Script creates systemd unit files in /etc/systemd/system/
3. Script calls systemctl daemon-reload and enable
4. Script has configure_redis() that sets password and AOF
5. Script has complete main() that orchestrates all steps
6. Script ends with `main "$@"` for curl | bash safety
7. Banner displays server IP and next steps
</verification>

<success_criteria>
- Complete install.sh can be run with `curl -sSL ... | bash`
- systemd services are created: livos.service, liv-core.service, liv-memory.service, liv-worker.service
- Services start automatically and are enabled for boot
- Redis is configured with generated password and AOF persistence
- UFW firewall configured (if available)
- Final banner shows access URL and next steps
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete one-command installer with wizard, systemd services, and secret generation</what-built>
  <how-to-verify>
    1. Review livos/install.sh for completeness
    2. Verify syntax: `bash -n livos/install.sh`
    3. Check all required functions exist:
       - main() wrapper
       - detect_os(), detect_arch(), check_root()
       - wizard_input(), wizard_yesno(), run_configuration_wizard()
       - generate_secrets(), write_env_file()
       - create_systemd_service(), start_services()
       - show_banner()
    4. (Optional) Test on fresh Ubuntu 22.04 VM:
       `curl -sSL https://raw.githubusercontent.com/.../install.sh | sudo bash`
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues for fixes</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/09-installer/09-03-SUMMARY.md`
</output>
