---
phase: v1.5-03-hybrid-memory-channel-expansion
plan: 04
subsystem: channels
tags: [matrix, matrix-js-sdk, channel-provider, messaging]

dependency-graph:
  requires:
    - v1.5-03-03 (ChannelId type and CHANNEL_META already extended with 'matrix')
  provides:
    - MatrixProvider implementation using matrix-js-sdk
    - Matrix channel registered in ChannelManager
    - All channel lists updated across daemon.ts and index.ts
  affects:
    - v1.5-03-05 (Settings UI for Matrix configuration panel)

tech-stack:
  added:
    - matrix-js-sdk v40.3.0-rc.0
  patterns:
    - Sync-based message listening (initialSyncLimit: 0 to skip history)
    - Room event filtering (m.room.message + m.text msgtype)
    - Redis-backed config/status persistence per channel

key-files:
  created:
    - nexus/packages/core/src/channels/matrix.ts
  modified:
    - nexus/packages/core/src/channels/index.ts
    - nexus/packages/core/src/index.ts
    - nexus/packages/core/package.json

decisions:
  - matrix-js-sdk v40 used (latest RC) — includes built-in TypeScript types, no @types package needed
  - Matrix rooms treated as always-group context (isGroup: true)
  - initialSyncLimit: 0 prevents processing old messages on connect
  - Bot user ID obtained via whoami() before starting sync
  - Room filtering via config.roomId (optional — if unset, listens to all joined rooms)

metrics:
  duration: ~5 minutes
  completed: 2026-02-15
---

# Phase 3 Plan 04: Matrix Channel Provider Summary

**One-liner:** MatrixProvider using matrix-js-sdk with sync-based room message listening, Redis config, and full ChannelManager integration

## What Was Done

### Task 1: Install matrix-js-sdk dependency
- Installed `matrix-js-sdk` v40.3.0-rc.0 via npm
- Package includes built-in TypeScript types (no separate @types needed)
- Commit: `8e9d1c4`

### Task 2: Create MatrixProvider and register in ChannelManager
- Created `nexus/packages/core/src/channels/matrix.ts` implementing `ChannelProvider` interface
- Key features:
  - `connect()`: Creates Matrix client with homeserver URL + access token, calls `whoami()` for bot user ID, starts sync with `initialSyncLimit: 0`
  - `RoomEvent.Timeline` listener filters for `m.room.message` type, `m.text` msgtype, skips own messages and historical events
  - Optional room filtering via `config.roomId` (listens to all rooms if unset)
  - `sendMessage()`: Uses `sendTextMessage()` with chunking for long messages (64KB limit)
  - `testConnection()`: Creates ephemeral client, calls `whoami()`, returns bot name
  - Full Redis config/status persistence following established pattern
- Registered `MatrixProvider` in `ChannelManager` constructor
- Updated `index.ts` heartbeat delivery and `last_chat_id` tracking to include 'matrix'
- Commit: `da905b6`

## Deviations from Plan

None — plan executed exactly as written. The types.ts and daemon.ts modifications were already completed by plan v1.5-03-03 which forward-added 'matrix' alongside 'slack' to avoid merge conflicts.

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| `import * as sdk from 'matrix-js-sdk'` | Standard namespace import works with the SDK's ESM exports |
| `initialSyncLimit: 0` | Prevents processing old messages on bot startup — only new messages trigger handlers |
| `isGroup: true` always | Matrix rooms are inherently group contexts, unlike Telegram 1:1 chats |
| Room filtering is optional | If `roomId` is unset in config, the bot responds in all joined rooms |
| `last_chat_id` saved on incoming messages | Enables heartbeat delivery to the most recently active Matrix room |

## Verification Results

1. `npx tsc --noEmit` — zero errors
2. `matrix-js-sdk` confirmed in package.json dependencies
3. `class MatrixProvider` exists in matrix.ts
4. `MatrixProvider` imported and registered in channels/index.ts
5. `'matrix'` present in all daemon.ts channel lists (sendChannelResponse, action routing, realtime sources, channel context, cron valid sources)
6. `'matrix'` present in all index.ts heartbeat delivery and last_chat_id tracking

## Next Phase Readiness

- Matrix SDK complexity concern from STATE.md is resolved — implementation followed the same pattern as Telegram/Discord/Slack with no issues
- Ready for v1.5-03-05 (Wave 2) which adds the Settings UI for configuring Matrix (homeserver URL, access token, room ID)
- Ready for v1.5-03-02 (Wave 2) context window optimization
