---
phase: v1.5-03-hybrid-memory-channel-expansion
plan: 01
subsystem: memory
tags: [memory, embeddings, dedup, bullmq, extraction, time-decay]

dependency-graph:
  requires:
    - v1.5-01 (provider abstraction for Brain.think)
    - v1.5-02 (agent loop for conversation pipeline)
  provides:
    - Automatic memory extraction after agent conversations
    - Embedding-based dedup for memory service
    - Time-decay scoring for memory search
    - Session-to-memory binding via memory_sessions table
  affects:
    - v1.5-03-02+ (channel expansion plans may use session binding)
    - v1.5-04+ (skill registry may reference memory patterns)

tech-stack:
  added: []
  patterns:
    - BullMQ fire-and-forget job pattern for memory extraction
    - Cosine similarity dedup with configurable threshold
    - Weighted scoring (70% relevance + 30% recency) for search

key-files:
  created: []
  modified:
    - nexus/packages/memory/src/index.ts
    - nexus/packages/core/src/daemon.ts
    - nexus/packages/core/src/index.ts

decisions:
  - "[Memory] Dedup threshold 0.92 cosine similarity - high enough to catch near-duplicates without merging distinct memories"
  - "[Memory] Time-decay 30-day half-life with 70/30 relevance/recency weighting"
  - "[Memory] Max 5 memories extracted per conversation to prevent noise"
  - "[Memory] Memory extraction uses flash tier for cost efficiency"
  - "[Memory] Fire-and-forget pattern - extraction does not block response delivery"

metrics:
  duration: "~5 minutes"
  completed: "2026-02-15"
---

# Phase v1.5-03 Plan 01: Memory Extraction Pipeline, Dedup, and Time-Decay Summary

Automatic memory extraction from conversations via BullMQ, embedding-based deduplication at 0.92 threshold, session-to-memory binding, and 70/30 relevance/recency time-decay search scoring.

## Tasks Completed

### Task 1: Enhanced memory service with sessions, dedup, and time-decay search
**Commit:** `44a24a9`
**Files:** `nexus/packages/memory/src/index.ts`

Added three capabilities to the memory service:

1. **memory_sessions table** - New SQLite table linking sessions to memories. The `/add` endpoint accepts optional `sessionId` field and creates binding rows. New `GET /sessions/:sessionId/memories` endpoint returns all memories for a session.

2. **Deduplication via embedding similarity** - Before inserting a new memory, the last 50 user memories with embeddings are checked. If any has cosine similarity >= 0.92 (`DEDUP_THRESHOLD`), the existing memory is updated with the newer content instead of creating a duplicate. Returns `{ deduplicated: true }`.

3. **Time-decay scoring in search** - Both semantic and text-fallback search paths now apply time-decay. Semantic search uses `finalScore = relevance * 0.7 + decayFactor * 0.3` where `decayFactor = 0.5^(age / 30 days)`. Text search uses `score = 0.5 * decayFactor`. Recent memories rank higher when relevance is similar.

Also cleaned up session links on memory delete/reset and added `totalSessions` to stats endpoint.

### Task 2: BullMQ memory extraction job after conversations
**Commit:** `3fa8a04`
**Files:** `nexus/packages/core/src/daemon.ts`, `nexus/packages/core/src/index.ts`

Added automatic memory extraction that runs as a BullMQ job after each successful agent conversation:

1. **Daemon side** - Added `memoryExtractionQueue?: Queue` to `DaemonConfig`. After the agent handler completes successfully, enqueues an `extract-memories` job with the conversation text, response, userId, sessionId, and source. Uses `.catch()` for fire-and-forget.

2. **Index side** - Created `nexus-memory-extraction` BullMQ queue and worker. The worker:
   - Sends conversation to Brain flash tier with extraction prompt
   - Parses JSON array of memory strings from AI response (handles markdown code fences)
   - Stores each memory (max 5) via `POST http://localhost:3300/add` with sessionId
   - Runs with concurrency 2

3. **Shutdown** - Worker and queue are properly closed in the graceful shutdown handler.

## Verification Results

| Check | Result |
|-------|--------|
| `npx tsc --noEmit` (memory) | Zero errors |
| `npx tsc --noEmit` (core) | Zero errors |
| `memory_sessions` in memory service | Present (table + indexes + endpoints) |
| `DEDUP_THRESHOLD` constant | Present (0.92) |
| `AGE_DECAY_HALF_LIFE_DAYS` constant | Present (30) |
| `nexus-memory-extraction` in index.ts | Present (queue + worker) |
| `memoryExtractionQueue` in daemon.ts | Present (config + enqueue) |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Session link cleanup on memory delete/reset**
- **Found during:** Task 1
- **Issue:** If a memory is deleted or user memories are reset, orphaned rows would remain in memory_sessions
- **Fix:** Added cascade deletion of memory_sessions rows when memories are deleted via DELETE `/memories/:id` or POST `/reset`
- **Files modified:** `nexus/packages/memory/src/index.ts`
- **Commit:** `44a24a9`

**2. [Rule 2 - Missing Critical] Stats endpoint missing session count**
- **Found during:** Task 1
- **Issue:** Stats endpoint didn't include session count, which is useful for monitoring the new session binding feature
- **Fix:** Added `totalSessions` (count of distinct session_ids) to the `/stats` response
- **Files modified:** `nexus/packages/memory/src/index.ts`
- **Commit:** `44a24a9`

## Decisions Made

1. **Dedup threshold 0.92** - Chosen to be high enough that only near-identical memories merge, while allowing slight rephrasing to update existing memories
2. **Time-decay half-life 30 days** - Balanced to keep recent memories relevant without completely discarding old ones
3. **70/30 relevance/recency split** - Relevance remains dominant but recency provides meaningful tiebreaking
4. **Max 5 memories per conversation** - Prevents noisy conversations from flooding memory with low-quality entries
5. **Flash tier for extraction** - Background task, cost efficiency matters more than quality

## Next Phase Readiness

**Ready for v1.5-03-02.** The memory service infrastructure (sessions, dedup, time-decay) is in place. Channel expansion plans can leverage the sessionId binding for per-channel memory tracking.
