---
phase: v1.5-03-hybrid-memory-channel-expansion
plan: 03
subsystem: channels
tags: [slack, bolt, socket-mode, channel-provider]

dependency-graph:
  requires:
    - v1.5-03-01 (if applicable, for channel infrastructure)
    - v1.5-03-02 (if applicable, for channel wiring)
  provides:
    - SlackProvider channel implementation
    - ChannelId type extended with 'slack' and 'matrix'
    - ChannelConfig extended with appToken, homeserverUrl, roomId
  affects:
    - v1.5-03-04 (MatrixProvider â€” types already prepared)

tech-stack:
  added:
    - "@slack/bolt ^4.0.0 (Socket Mode)"
  patterns:
    - "ChannelProvider interface pattern (same as Telegram/Discord)"
    - "Socket Mode for Slack (no public URL needed)"

file-tracking:
  key-files:
    created:
      - nexus/packages/core/src/channels/slack.ts
    modified:
      - nexus/packages/core/src/channels/types.ts
      - nexus/packages/core/src/channels/index.ts
      - nexus/packages/core/src/daemon.ts
      - nexus/packages/core/src/index.ts
      - nexus/packages/core/src/router.ts

decisions:
  - id: slack-socket-mode
    description: "Use @slack/bolt Socket Mode for Slack connection (no public URL required)"
  - id: channel-id-forward-extend
    description: "Extended ChannelId with both 'slack' and 'matrix' upfront to avoid a second type change in plan 04"

metrics:
  duration: "~4 minutes"
  completed: "2026-02-15"
---

# Phase v1.5-03 Plan 03: Slack Channel Provider Summary

**SlackProvider using @slack/bolt Socket Mode with full ChannelManager integration and hardcoded channel list updates across daemon.ts and index.ts**

## What Was Done

### Task 1: Update ChannelId type and metadata for Slack
- Extended `ChannelId` union type to include `'slack' | 'matrix'`
- Added `appToken`, `homeserverUrl`, `roomId` optional fields to `ChannelConfig` for Slack and Matrix
- Added Slack (`#4A154B`, 4000 char limit) and Matrix (`#0DBD8B`, 65536 char limit) to `CHANNEL_META`
- Added `'matrix'` to `Intent['source']` in router.ts for type compatibility

**Commit:** `33abc60`

### Task 2: Create SlackProvider and register in ChannelManager
- Created `nexus/packages/core/src/channels/slack.ts` (~190 lines)
  - Uses `@slack/bolt` App with `socketMode: true` (no public webhook URL needed)
  - Listens for messages, filters bot messages and subtypes
  - Sends responses via `chat.postMessage` with thread support (`thread_ts`)
  - Text chunking via `chunkText()` with 4000 char Slack limit
  - `testConnection()` validates both bot token and app-level token
  - Stores `nexus:slack:last_chat_id` for heartbeat delivery
- Registered `SlackProvider` in `ChannelManager` constructor
- Updated all hardcoded channel lists in `daemon.ts`:
  - `sendChannelResponse` (line ~2070)
  - Action routing callback (line ~2204)
  - Real-time sources for immediate processing (line ~400)
  - Channel context tracking for cron tool (lines ~243, ~418)
  - Cron valid sources for scheduled timer replay (line ~597)
- Updated all hardcoded channel lists in `index.ts`:
  - Heartbeat `onDeliver` target check (line ~121)
  - Heartbeat "deliver to all" loop (line ~137)
  - `last_chat_id` save on incoming message (line ~258)

**Commit:** `d60890f`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added 'matrix' to Intent source type in router.ts**
- **Found during:** Task 1
- **Issue:** Expanding `ChannelId` to include `'matrix'` caused a TS2345 error at index.ts line 264 where `msg.channel` (ChannelId) is passed to `addToInbox` which expects `Intent['source']`. The `Intent['source']` union did not include `'matrix'`.
- **Fix:** Added `'matrix'` to the `Intent['source']` union type in `router.ts`
- **Files modified:** `nexus/packages/core/src/router.ts`
- **Commit:** `33abc60` (included in Task 1 commit)

**2. [Rule 2 - Missing Critical] Added 'slack' to channel context tracking and cron valid sources**
- **Found during:** Task 2
- **Issue:** The plan only specified updating `sendChannelResponse` and action routing channel lists, but daemon.ts also had hardcoded `['telegram', 'discord', 'whatsapp']` lists for channel context tracking (2 places) and cron valid sources (1 place) that needed 'slack' for correct context propagation.
- **Fix:** Added 'slack' to all 3 additional hardcoded lists
- **Files modified:** `nexus/packages/core/src/daemon.ts`
- **Commit:** `d60890f` (included in Task 2 commit)

## Verification Results

| Check | Result |
|-------|--------|
| `npx tsc --noEmit` | Zero errors |
| `class SlackProvider` in slack.ts | Confirmed |
| `'slack'` in ChannelId type | Confirmed |
| `SlackProvider` in channels/index.ts | Import + registration confirmed |
| `'slack'` in daemon.ts sendChannelResponse | Confirmed |
| `'slack'` in index.ts heartbeat delivery | Confirmed |

## Architecture Notes

### SlackProvider Structure
Follows identical pattern to TelegramProvider:
- `init(redis)` -> `loadConfig()` from Redis
- `connect()` -> Create `App` with Socket Mode, register message listener, call `app.start()`
- `disconnect()` -> `app.stop()`
- `sendMessage()` -> `chat.postMessage` with chunking and optional `thread_ts`
- `testConnection()` -> Create temporary App, call `auth.test()`, stop
- Config stored at `nexus:slack:config`, status at `nexus:slack:status`

### Slack-specific Details
- **Dual tokens required:** Bot token (`xoxb-...`) for API calls + App-level token (`xapp-...`) for Socket Mode
- **Bot message filtering:** Skips messages with `subtype` or `bot_id` to prevent loops
- **Thread support:** `replyToMessageId` maps to `thread_ts` for Slack threaded conversations
- **User ID as userName:** Slack user ID is stored as `userName`; display name lookup would require an additional API call

## Next Phase Readiness

- MatrixProvider (plan 04) types are already prepared: `ChannelId` includes `'matrix'`, `ChannelConfig` has `homeserverUrl` and `roomId`, `CHANNEL_META` has Matrix entry, `Intent['source']` includes `'matrix'`
- No blockers for plan 04
