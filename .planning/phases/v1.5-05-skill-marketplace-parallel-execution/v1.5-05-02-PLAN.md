---
phase: v1.5-05-skill-marketplace-parallel-execution
plan: 02
type: execute
wave: 2
depends_on: ["v1.5-05-01"]
files_modified:
  - nexus/packages/core/src/skill-loader.ts
  - nexus/packages/core/src/skill-installer.ts
  - nexus/packages/core/src/api.ts
  - nexus/packages/core/src/index.ts
  - livos/packages/ui/src/routes/ai-chat/skills-panel.tsx
  - livos/packages/ui/src/routes/ai-chat/ai-chat.tsx
autonomous: false

must_haves:
  truths:
    - "User can browse available skills from the marketplace via an API endpoint"
    - "User can install a skill and it becomes immediately available to the AI agent without restart"
    - "Installed skills declare permissions upfront and the user reviews them before confirming installation"
    - "User can uninstall a marketplace skill and it is removed from the agent's tool set"
    - "User can see installed skills in the LivOS AI Chat settings panel"
  artifacts:
    - path: "nexus/packages/core/src/skill-installer.ts"
      provides: "Skill install/uninstall flow with permission review"
      exports: ["SkillInstaller"]
    - path: "nexus/packages/core/src/api.ts"
      provides: "REST API endpoints for skill marketplace (browse, install, uninstall, list installed)"
      contains: "/api/skills"
    - path: "nexus/packages/core/src/skill-loader.ts"
      provides: "Extended SkillLoader with marketplace skill loading and progressive lazy import"
      contains: "loadMarketplaceSkills"
    - path: "livos/packages/ui/src/routes/ai-chat/skills-panel.tsx"
      provides: "Skills marketplace panel in LivOS AI Chat"
      exports: ["SkillsPanel"]
  key_links:
    - from: "nexus/packages/core/src/skill-installer.ts"
      to: "nexus/packages/core/src/skill-registry-client.ts"
      via: "Downloads skills from registry"
      pattern: "downloadSkill"
    - from: "nexus/packages/core/src/skill-installer.ts"
      to: "nexus/packages/core/src/skill-loader.ts"
      via: "Reloads skills after install"
      pattern: "skillLoader.*load"
    - from: "nexus/packages/core/src/api.ts"
      to: "nexus/packages/core/src/skill-installer.ts"
      via: "REST endpoints call installer methods"
      pattern: "skillInstaller"
    - from: "livos/packages/ui/src/routes/ai-chat/skills-panel.tsx"
      to: "/api/skills"
      via: "Fetch calls to Nexus API"
      pattern: "fetch.*api/skills"
---

<objective>
Build the skill install/uninstall flow with permission review, wire it to REST API endpoints, extend SkillLoader for marketplace skills with progressive loading, and create the Skills Marketplace UI panel in LivOS.

Purpose: This plan makes the marketplace functional end-to-end: users can browse, review permissions, install, and uninstall skills, and the AI agent gains new capabilities without restart.

Output: SkillInstaller class, API endpoints for /api/skills/*, updated SkillLoader, and a SkillsPanel UI component.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v1.5-05-skill-marketplace-parallel-execution/v1.5-05-01-SUMMARY.md
@nexus/packages/core/src/skill-loader.ts
@nexus/packages/core/src/skill-types.ts
@nexus/packages/core/src/api.ts
@nexus/packages/core/src/index.ts
@livos/packages/ui/src/routes/ai-chat/mcp-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillInstaller and extend SkillLoader for marketplace skills</name>
  <files>nexus/packages/core/src/skill-installer.ts, nexus/packages/core/src/skill-loader.ts</files>
  <action>
**Create `nexus/packages/core/src/skill-installer.ts`:**

SkillInstaller manages the lifecycle of marketplace skills:

```typescript
export interface InstallResult {
  success: boolean;
  skillName: string;
  error?: string;
  permissions?: Array<{ name: string; reason: string; required: boolean }>;
}
```

Constructor: `constructor(opts: { skillLoader: SkillLoader; registryClient: SkillRegistryClient; installDir: string; redis: Redis })`
- `installDir` is where marketplace skills are stored (e.g. `/opt/nexus/skills/marketplace/`)

Methods:
- `async previewInstall(skillName: string): Promise<{ entry: RegistryCatalogEntry; permissions: SkillPermission[] } | null>` - Fetch catalog entry, return permissions for user review. Does NOT install. Returns null if skill not found.
- `async install(skillName: string, acceptedPermissions: string[]): Promise<InstallResult>` - Download skill files from registry to installDir, validate manifest, check that all required permissions are in acceptedPermissions array. If validation passes, trigger SkillLoader to load the new skill. Store install metadata in Redis key `nexus:skills:installed:{name}` as JSON (manifest, installedAt, source: 'marketplace'). Return success/failure.
- `async uninstall(skillName: string): Promise<{ success: boolean; error?: string }>` - Remove skill directory from installDir. Unregister skill's tools from ToolRegistry. Remove Redis metadata. Delete skill files (rmSync the directory).
- `async listInstalled(): Promise<Array<{ name: string; version: string; description: string; installedAt: number; permissions: SkillPermission[] }>>` - Scan Redis keys matching `nexus:skills:installed:*` and return metadata.
- `async isInstalled(skillName: string): Promise<boolean>` - Check Redis for install metadata.

Import `SkillRegistryClient`, `RegistryCatalogEntry` from `./skill-registry-client.js`. Import `SkillPermission`, `parseSkillManifest` from `./skill-manifest.js`. Import `SkillLoader` from `./skill-loader.js`. Import `logger` from `./logger.js`. Use `fs/promises` for file operations. Use `path` for path construction.

**Extend `nexus/packages/core/src/skill-loader.ts`:**

Add a new method to SkillLoader:
- `async loadMarketplaceSkills(marketplaceDir: string): Promise<void>` - Scan marketplaceDir for subdirectories. Each subdirectory should contain SKILL.md + index.ts. For each, use `scanSkillDirectory` from skill-manifest.ts to get manifest + entry point, then load the skill (reuse existing loadSkill logic but pass the directory entry point). Mark loaded skills with `source: 'marketplace'`.

Add progressive lazy loading:
- `async loadSkillLazy(skillName: string, dirPath: string): Promise<boolean>` - Load a single skill from a directory on demand (called after install). Returns true if loaded successfully.

Add unload capability:
- `unloadSkill(skillName: string): boolean` - Remove a skill from the internal map. Unregister its custom tools from toolRegistry. Return true if skill existed.

Ensure backward compatibility: existing skills loaded from the flat skills/ directory (server-health.ts, deploy.ts, etc.) continue to work exactly as before. The new marketplace loading is additive.
  </action>
  <verify>
Run: `cd nexus && npx tsc --noEmit --project packages/core/tsconfig.json 2>&1 | head -20`
Expect: No type errors. SkillInstaller and extended SkillLoader compile cleanly.
  </verify>
  <done>
SkillInstaller can preview install (returning permissions), install with permission acceptance, uninstall, and list installed skills. SkillLoader can load marketplace skills from subdirectories, lazy-load individual skills on demand, and unload skills cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add REST API endpoints and wire installer into Nexus startup</name>
  <files>nexus/packages/core/src/api.ts, nexus/packages/core/src/index.ts</files>
  <action>
**Update `nexus/packages/core/src/api.ts`:**

Add SkillInstaller to ApiDeps interface:
```typescript
skillInstaller?: SkillInstaller;
```

Add the following API routes after the existing app management routes (around line 78), all under `/api/skills` and protected by the existing `requireApiKey` middleware:

1. `GET /api/skills/marketplace` - Fetch the skill catalog from all configured registries.
   - Query params: `?search=<query>` (optional)
   - Response: `{ skills: RegistryCatalogEntry[] }`
   - Calls `registryClient.searchCatalog(query)` or `registryClient.fetchCatalog()`

2. `GET /api/skills/installed` - List all installed marketplace skills.
   - Response: `{ skills: Array<{ name, version, description, installedAt, permissions }> }`
   - Calls `skillInstaller.listInstalled()`

3. `POST /api/skills/preview` - Preview a skill install (get permissions).
   - Body: `{ skillName: string }`
   - Response: `{ entry: RegistryCatalogEntry, permissions: SkillPermission[] }` or 404
   - Calls `skillInstaller.previewInstall(skillName)`

4. `POST /api/skills/install` - Install a skill after permission review.
   - Body: `{ skillName: string, acceptedPermissions: string[] }`
   - Response: `{ success: boolean, skillName: string, error?: string }`
   - Calls `skillInstaller.install(skillName, acceptedPermissions)`

5. `POST /api/skills/uninstall` - Uninstall a marketplace skill.
   - Body: `{ skillName: string }`
   - Response: `{ success: boolean, error?: string }`
   - Calls `skillInstaller.uninstall(skillName)`

6. `GET /api/skills/builtin` - List all builtin skills (loaded from skills/ directory).
   - Response: `{ skills: Array<{ name, description, triggers, type }> }`
   - Calls `skillLoader.listSkills()` filtered to source !== 'marketplace'

**Update `nexus/packages/core/src/index.ts`:**

After the existing SkillLoader initialization (around line 69):
1. Import `SkillRegistryClient` from `./skill-registry-client.js`
2. Import `SkillInstaller` from `./skill-installer.js`
3. Create the registry client:
   ```typescript
   const skillCacheDir = process.env.SKILL_CACHE_DIR || '/opt/nexus/data/skill-cache';
   const skillRegistryClient = new SkillRegistryClient({ cacheDir: skillCacheDir });
   // Add default community registry
   const defaultRegistry = process.env.SKILL_REGISTRY_URL || 'https://github.com/utopusc/livinity-skills';
   skillRegistryClient.addRegistry(defaultRegistry);
   ```
4. Create the installer:
   ```typescript
   const skillInstallDir = process.env.SKILL_INSTALL_DIR || '/opt/nexus/skills/marketplace';
   const skillInstaller = new SkillInstaller({
     skillLoader,
     registryClient: skillRegistryClient,
     installDir: skillInstallDir,
     redis,
   });
   ```
5. After `skillLoader.loadAll()`, add: `await skillLoader.loadMarketplaceSkills(skillInstallDir);`
6. Pass `skillInstaller` to `createApiServer` in the deps object.

Ensure the shutdown handler doesn't need changes (no cleanup needed for installer).
  </action>
  <verify>
Run: `cd nexus && npx tsc --noEmit --project packages/core/tsconfig.json 2>&1 | head -20`
Expect: No type errors. API endpoints are wired.
Test with curl (after deployment): `curl -H "X-Api-Key: $KEY" http://localhost:3200/api/skills/installed` returns `{"skills":[]}`.
  </verify>
  <done>
Six REST API endpoints for skill marketplace are functional: browse catalog, list installed, preview install permissions, install, uninstall, and list builtin skills. SkillRegistryClient and SkillInstaller are created at Nexus startup. Marketplace skills are loaded from the install directory on boot.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Skills Marketplace panel in LivOS AI Chat UI</name>
  <files>livos/packages/ui/src/routes/ai-chat/skills-panel.tsx, livos/packages/ui/src/routes/ai-chat/ai-chat.tsx</files>
  <action>
**Create `livos/packages/ui/src/routes/ai-chat/skills-panel.tsx`:**

Create a React component `SkillsPanel` that serves as the skill marketplace UI. Follow the same patterns as the existing `mcp-panel.tsx` (MCP server management panel in the AI Chat settings).

The panel has two tabs: "Marketplace" and "Installed".

**Marketplace tab:**
- On mount, fetch `GET /api/skills/marketplace` from the Nexus API (use the same API base URL pattern as other components â€” check how mcp-panel.tsx makes its API calls).
- Display skills in a grid/list with: name, description, version, author, tags (as small badges), and an "Install" button.
- Include a search input that filters by name/description/tags (client-side filter on the fetched catalog, or pass `?search=query` to the API).
- When "Install" is clicked, call `POST /api/skills/preview` to get permissions. Show a dialog/modal listing the required permissions with name + reason. User must check/accept all required permissions. Then call `POST /api/skills/install` with accepted permissions.
- Show loading states, error states, and success toasts.

**Installed tab:**
- Fetch `GET /api/skills/installed` on mount.
- Display each installed skill with: name, version, description, installedAt (formatted date), permissions list, and an "Uninstall" button.
- Uninstall calls `POST /api/skills/uninstall`.
- Also show builtin skills (from `GET /api/skills/builtin`) in a separate "Builtin" section, but without uninstall buttons.

**Styling:** Use Tailwind classes consistent with the existing UI. Use the existing shadcn components (Dialog for permission review, Button, Input for search). Check how `mcp-panel.tsx` structures its layout and follow the same pattern.

**API auth:** Use the same authentication pattern as other LivOS API calls. Check how the existing `mcp-panel.tsx` or other AI chat panels attach the API key or JWT to requests. The Nexus API requires `X-Api-Key` header.

**Wire into AI Chat:**

Update `livos/packages/ui/src/routes/ai-chat/ai-chat.tsx` (or whichever file contains the AI Chat settings/tabs):
- Import `SkillsPanel` from `./skills-panel`.
- Add a "Skills" tab or section that renders `<SkillsPanel />`. Place it near the existing MCP panel. Follow the same tab/panel pattern used for MCP.
- If the AI chat uses a side panel or settings drawer, add "Skills" as an option there.

Look at how `mcp-panel.tsx` is integrated to determine the exact wiring pattern.
  </action>
  <verify>
Run: `cd livos && pnpm build --filter ui 2>&1 | tail -20`
Expect: Build succeeds with no errors.
Visual check: Navigate to AI Chat in LivOS, open settings/panels, see "Skills" tab with Marketplace and Installed sub-tabs.
  </verify>
  <done>
Skills Marketplace panel exists in LivOS AI Chat UI. Users can browse available skills, search by name/description/tags, preview permissions before install, install skills, view installed skills, and uninstall marketplace skills. Builtin skills are listed separately.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Skill marketplace end-to-end: SKILL.md manifest schema, Git registry client, install/uninstall flow with permission review, REST API endpoints, and Skills panel in LivOS AI Chat UI.</what-built>
  <how-to-verify>
1. Open LivOS web UI and navigate to AI Chat
2. Open the Skills panel/tab
3. Verify the "Marketplace" tab shows available skills (or empty state if no registry is configured)
4. Verify the "Installed" tab shows builtin skills
5. If a test registry is available, try installing a skill and verify it appears in the Installed list
6. Verify the AI agent can use a newly installed skill's tools without server restart
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in nexus/packages/core
2. `pnpm build --filter ui` succeeds in livos/
3. API endpoints respond correctly: GET /api/skills/marketplace, GET /api/skills/installed, POST /api/skills/preview, POST /api/skills/install, POST /api/skills/uninstall, GET /api/skills/builtin
4. SkillInstaller correctly downloads, validates, and loads marketplace skills
5. SkillLoader loads marketplace skills from subdirectories on boot
6. LivOS UI shows Skills panel with browse, install, and uninstall functionality
</verification>

<success_criteria>
- User can browse available skills in the marketplace UI
- User can preview permissions before installing a skill
- User can install a skill and it becomes immediately available to the AI
- User can uninstall a marketplace skill
- Builtin skills continue to work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/v1.5-05-skill-marketplace-parallel-execution/v1.5-05-02-SUMMARY.md`
</output>
