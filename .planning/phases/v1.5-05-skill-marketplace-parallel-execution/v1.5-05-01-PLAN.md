---
phase: v1.5-05-skill-marketplace-parallel-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/core/src/skill-manifest.ts
  - nexus/packages/core/src/skill-registry-client.ts
  - nexus/packages/core/src/skill-types.ts
autonomous: true

must_haves:
  truths:
    - "A SKILL.md manifest can be parsed into a typed SkillManifest object with name, version, description, permissions, and tools"
    - "A directory-based skill (skill-name/SKILL.md + skill-name/index.ts) is recognized as a valid skill format"
    - "The Git registry client can fetch a catalog of available skills from a GitHub repository"
    - "Each catalog entry includes name, description, version, required permissions, and repository URL"
  artifacts:
    - path: "nexus/packages/core/src/skill-manifest.ts"
      provides: "SKILL.md parser, SkillManifest type, validation, directory scanner"
      exports: ["SkillManifest", "SkillPermission", "parseSkillManifest", "validateManifest", "scanSkillDirectory"]
    - path: "nexus/packages/core/src/skill-registry-client.ts"
      provides: "Git-based registry client that fetches skill catalogs from GitHub repos"
      exports: ["SkillRegistryClient", "RegistryCatalogEntry"]
    - path: "nexus/packages/core/src/skill-types.ts"
      provides: "Extended skill types with SkillManifest integration"
      contains: "SkillManifest"
  key_links:
    - from: "nexus/packages/core/src/skill-manifest.ts"
      to: "nexus/packages/core/src/skill-types.ts"
      via: "SkillManifest type used in skill loading"
      pattern: "import.*SkillManifest.*skill-manifest"
    - from: "nexus/packages/core/src/skill-registry-client.ts"
      to: "nexus/packages/core/src/skill-manifest.ts"
      via: "Uses parseSkillManifest to validate fetched manifests"
      pattern: "parseSkillManifest"
---

<objective>
Define the SKILL.md manifest schema, directory-based skill format, and Git registry client for fetching community skill catalogs from GitHub repositories.

Purpose: This is the foundation of the skill marketplace. Skills need a standardized manifest format so they can be discovered, validated, and installed. The Git registry client connects to GitHub repos (like utopusc/livinity-skills) to fetch available skill catalogs.

Output: Three new source files providing manifest parsing, directory scanning, and GitHub registry fetching.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nexus/packages/core/src/skill-types.ts
@nexus/packages/core/src/skill-loader.ts
@nexus/packages/core/src/skill-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SKILL.md manifest schema and directory scanner</name>
  <files>nexus/packages/core/src/skill-manifest.ts, nexus/packages/core/src/skill-types.ts</files>
  <action>
Create `nexus/packages/core/src/skill-manifest.ts` with:

1. **SkillManifest type** (the parsed representation of a SKILL.md file):
   ```typescript
   export interface SkillPermission {
     name: string;           // e.g. "shell", "docker", "files", "network"
     reason: string;         // Why this permission is needed
     required: boolean;      // false = optional permission
   }

   export interface SkillManifest {
     name: string;           // kebab-case identifier (e.g. "server-health")
     version: string;        // semver (e.g. "1.0.0")
     description: string;    // Human-readable description
     author?: string;        // Author name/handle
     license?: string;       // e.g. "MIT", "AGPL-3.0"
     homepage?: string;      // URL to docs or repo

     // Capabilities
     tools: string[];        // Tool names this skill uses (e.g. ["shell", "docker_list"])
     triggers: string[];     // Regex patterns that activate this skill
     permissions: SkillPermission[]; // Declared permissions

     // Execution config
     type: 'simple' | 'autonomous'; // Skill execution mode
     model_tier: 'flash' | 'sonnet' | 'opus';
     max_turns?: number;
     max_tokens?: number;
     timeout_ms?: number;
     phases?: string[];      // For autonomous skills

     // Marketplace metadata
     tags?: string[];        // e.g. ["monitoring", "docker", "server"]
     min_nexus_version?: string; // Minimum Nexus version required
   }
   ```

2. **parseSkillManifest(content: string): SkillManifest | null** - Parse a SKILL.md file (YAML frontmatter between `---` delimiters at the top of the file, followed by optional markdown documentation). Use the same simple YAML parsing approach as the existing `parseFrontmatter` in skill-loader.ts (no js-yaml dependency needed for simple key-value + list parsing). Handle the `permissions` field as a list of objects with `name`, `reason`, `required` sub-keys. Return null if required fields (name, version, description, tools) are missing.

3. **validateManifest(manifest: SkillManifest): { valid: boolean; errors: string[] }** - Validate a parsed manifest: name must be kebab-case, version must match semver regex, tools array must not be empty, permissions must have name+reason fields.

4. **scanSkillDirectory(dirPath: string): Promise<{ manifest: SkillManifest; entryPoint: string } | null>** - Given a directory path, look for SKILL.md and index.ts (or index.js). Parse the manifest, return both the manifest and the resolved entry point path. Return null if either file is missing or manifest is invalid.

Also update `nexus/packages/core/src/skill-types.ts`:
- Add `import type { SkillManifest } from './skill-manifest.js';`
- Add an optional `manifest?: SkillManifest` field to the existing `Skill` interface (alongside the existing `meta: SkillFrontmatter` for backward compat)
- Add an `installedAt?: number` timestamp field to `Skill` for tracking marketplace installs
- Add a `source?: 'builtin' | 'marketplace'` field to `Skill` to distinguish bundled vs installed skills
  </action>
  <verify>
Run: `cd nexus && npx tsc --noEmit --project packages/core/tsconfig.json 2>&1 | head -20`
Expect: No type errors related to skill-manifest.ts or skill-types.ts.
  </verify>
  <done>
SkillManifest type is defined. parseSkillManifest correctly parses YAML frontmatter from SKILL.md files. validateManifest catches invalid manifests. scanSkillDirectory resolves a skill directory to manifest + entry point. Skill interface in skill-types.ts has optional manifest, installedAt, and source fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Git-based skill registry client</name>
  <files>nexus/packages/core/src/skill-registry-client.ts</files>
  <action>
Create `nexus/packages/core/src/skill-registry-client.ts` with:

1. **RegistryCatalogEntry type**:
   ```typescript
   export interface RegistryCatalogEntry {
     name: string;          // Skill name (kebab-case)
     version: string;       // Latest version
     description: string;   // From SKILL.md
     author?: string;
     tags?: string[];
     permissions: Array<{ name: string; reason: string; required: boolean }>;
     tools: string[];
     repoUrl: string;       // GitHub repo URL (e.g. "https://github.com/user/repo")
     path: string;          // Path within repo (e.g. "skills/server-health")
     downloadUrl: string;   // Direct tar/zip download URL for the skill directory
   }
   ```

2. **SkillRegistryClient class**:
   - Constructor takes `{ cacheDir: string; cacheTtlMs?: number }` (cacheDir for storing fetched catalogs, default TTL 1 hour)
   - `addRegistry(url: string): void` - Add a GitHub repo URL as a skill registry source (e.g. "https://github.com/utopusc/livinity-skills"). Store in an internal array.
   - `async fetchCatalog(): Promise<RegistryCatalogEntry[]>` - For each registered repo, fetch the catalog. Use the GitHub API pattern: fetch `https://api.github.com/repos/{owner}/{repo}/contents/skills` to list skill directories. For each directory, fetch `SKILL.md` via raw.githubusercontent.com. Parse each SKILL.md using `parseSkillManifest`. Build the catalog entry from parsed manifest + repo metadata. Cache results in `{cacheDir}/registry-{hash}.json` with TTL. Use native `fetch()` (available in Node 18+). Handle rate limits gracefully (GitHub allows 60 req/hr unauthenticated). Return combined catalog from all registries.
   - `async searchCatalog(query: string): Promise<RegistryCatalogEntry[]>` - Search by name, description, or tags (case-insensitive substring match). Fetches catalog first if cache is stale.
   - `async downloadSkill(entry: RegistryCatalogEntry, targetDir: string): Promise<string>` - Download a skill's files to targetDir. Use GitHub raw content API to fetch SKILL.md and index.ts from the skill's path. Write files to `{targetDir}/{entry.name}/SKILL.md` and `{targetDir}/{entry.name}/index.ts`. Return the path to the installed skill directory. Do NOT use git clone (too heavy) -- fetch individual files via raw.githubusercontent.com.
   - `clearCache(): void` - Remove all cached catalog files.

Implementation notes:
- This is essentially the same pattern as the existing `builtin-apps` gallery cache (`/opt/livos/data/app-stores/`), but for skills.
- GitHub raw content URL pattern: `https://raw.githubusercontent.com/{owner}/{repo}/{branch}/{path}`
- Default branch detection: fetch repo metadata from `https://api.github.com/repos/{owner}/{repo}` and read `default_branch`.
- Use a hash of the registry URL as the cache key: `crypto.createHash('md5').update(url).digest('hex').slice(0, 8)`.
- Import `parseSkillManifest` from `./skill-manifest.js`.
- Import `logger` from `./logger.js` for structured logging.
  </action>
  <verify>
Run: `cd nexus && npx tsc --noEmit --project packages/core/tsconfig.json 2>&1 | head -20`
Expect: No type errors related to skill-registry-client.ts. SkillRegistryClient is importable.
  </verify>
  <done>
SkillRegistryClient can be instantiated with a cache directory. addRegistry accepts GitHub repo URLs. fetchCatalog fetches skill listings from GitHub API and parses SKILL.md manifests. searchCatalog filters by name/description/tags. downloadSkill fetches individual skill files to a target directory. Cache is file-based with configurable TTL.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in nexus/packages/core
2. SkillManifest, parseSkillManifest, validateManifest, scanSkillDirectory are exported from skill-manifest.ts
3. SkillRegistryClient, RegistryCatalogEntry are exported from skill-registry-client.ts
4. Skill interface in skill-types.ts has manifest?, installedAt?, source? fields
5. No existing tests or functionality broken
</verification>

<success_criteria>
- SKILL.md manifest can be parsed from YAML frontmatter with permissions, tools, triggers, and metadata
- Directory-based skill format (SKILL.md + index.ts) is scannable
- Git registry client can fetch catalog from GitHub repos and cache results
- All types compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/v1.5-05-skill-marketplace-parallel-execution/v1.5-05-01-SUMMARY.md`
</output>
