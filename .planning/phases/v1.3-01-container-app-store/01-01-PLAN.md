---
phase: v1.3-01-container-app-store
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\livinity-app.yml
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\clean-singletonlock.sh
autonomous: true

must_haves:
  truths:
    - "Gallery template produces a working Docker container when built"
    - "Container uses Selkies port 3000 (not KasmVNC 6901)"
    - "Browser sessions persist via /config volume mount"
    - "Stale lock files are cleaned on container init"
    - "Container restarts on failure with health check monitoring"
    - "Anti-detection flags and remote debugging port are configured"
  artifacts:
    - path: "chromium/Dockerfile"
      provides: "Custom image extending linuxserver/chromium with Node.js 22 and @playwright/mcp"
      contains: "linuxserver/chromium"
    - path: "chromium/docker-compose.yml"
      provides: "Container orchestration with shm_size, mem_limit, health check, restart policy"
      contains: "shm_size"
    - path: "chromium/livinity-app.yml"
      provides: "App Store manifest with correct port and metadata"
      contains: "port: 3000"
    - path: "chromium/clean-singletonlock.sh"
      provides: "Stale lock file cleanup script"
      contains: "SingletonLock"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "build: . directive"
      pattern: "build:\\s*\\."
    - from: "docker-compose.yml"
      to: "/config volume"
      via: "volume mount for persistence"
      pattern: "APP_DATA_DIR.*:/config"
    - from: "livinity-app.yml"
      to: "docker-compose.yml"
      via: "port must match container's internal Selkies port"
      pattern: "port: 3000"
---

<objective>
Update the Chromium browser gallery template files to use correct Selkies-based configuration (not KasmVNC), add health check and proper container hardening, and fix the port from 6901 to 3000.

Purpose: These template files are what get copied into the app-data directory when a user installs the Chromium Browser from the App Store. They must be correct for the install to produce a working, persistent browser container.

Output: Four updated files in the livinity-apps gallery repo (chromium/ directory)
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\ROADMAP.md
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\STATE.md

IMPORTANT: The gallery repo is a SEPARATE repo at:
  C:\Users\hello\Desktop\Projects\contabo\livinity-apps\

All file modifications in this plan target that repo, NOT the main livinity-io repo.

Existing files to read and update:
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\livinity-app.yml
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\clean-singletonlock.sh

Key research findings:
- linuxserver/chromium uses Selkies (NOT KasmVNC) since mid-2025
- Ports: 3000 (HTTP) and 3001 (HTTPS), NOT 6901
- CUSTOM_USER and PASSWORD env vars control Selkies authentication
- CHROME_CLI env var passes flags to Chromium (remote-debugging-port, anti-detection, etc.)
- shm_size 1gb minimum for Docker Chromium stability
- /custom-cont-init.d/ is the linuxserver init script directory
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dockerfile and clean-singletonlock.sh</name>
  <files>
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\clean-singletonlock.sh
  </files>
  <action>
Read existing Dockerfile and clean-singletonlock.sh, then update:

**Dockerfile** - The current file is mostly correct. Verify and ensure:
- Base image: `FROM lscr.io/linuxserver/chromium:latest`
- Installs Node.js 22 via nodesource setup_22.x
- Installs `@playwright/mcp@latest` globally via npm
- Copies clean-singletonlock.sh to `/custom-cont-init.d/99-clean-singletonlock`
- Clean up apt cache in same RUN layer to minimize image size
- The existing Dockerfile should be correct as-is. Only change if something is off.

**clean-singletonlock.sh** - The current file is mostly correct. Verify and ensure:
- Removes SingletonLock, SingletonSocket, SingletonCookie from `/config/.config/chromium/`
- Note: The lock files live at `/config/.config/chromium/` (parent of Default), NOT inside Default
- The current script checks `$CHROMIUM_DIR/../$lockfile` which resolves correctly from Default to the chromium dir
- Make sure the script has a proper shebang and echo statements for logging
- The existing script should be correct as-is. Only change if the path logic is wrong.

IMPORTANT: Both files likely need NO changes. Read them, verify correctness, and only write if something is actually wrong.
  </action>
  <verify>
Read both files after any changes and confirm:
1. Dockerfile has `FROM lscr.io/linuxserver/chromium:latest`, nodejs 22 install, @playwright/mcp install, COPY of cleanup script
2. clean-singletonlock.sh removes all three lock file types from the correct path
  </verify>
  <done>
Dockerfile builds a custom image with Node.js 22 + @playwright/mcp on top of linuxserver/chromium. Cleanup script targets correct lock file paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docker-compose.yml and livinity-app.yml</name>
  <files>
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\livinity-app.yml
  </files>
  <action>
Read existing files, then update with these specific changes:

**docker-compose.yml** - Several fixes needed:

1. Remove `version: '3.7'` line (deprecated in modern Docker Compose, causes warnings)

2. Keep existing good config:
   - `build: .`
   - `shm_size: '1gb'`
   - `mem_limit: 1536m`
   - `oom_score_adj: 500`
   - `security_opt: [seccomp:unconfined]`
   - `restart: on-failure`
   - Volume: `${APP_DATA_DIR}/data:/config`

3. ADD health check to the server service:
   ```yaml
   healthcheck:
     test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
     interval: 30s
     timeout: 10s
     retries: 3
     start_period: 30s
   ```

4. Keep all existing environment variables as-is. The CHROME_CLI flags are correct:
   `--remote-debugging-port=9222 --remote-allow-origins=* --restore-last-session --disable-blink-features=AutomationControlled --disable-infobars --disable-dev-shm-usage`

5. CUSTOM_USER and PASSWORD should remain empty strings (user sets these at install time or via env overrides)

**livinity-app.yml** - Several fixes needed:

1. Change `port: 6901` to `port: 3000` (Selkies uses port 3000, not KasmVNC's 6901)

2. Update description: Replace "KasmVNC web viewer" with "Selkies web viewer" in the description field

3. Update releaseNotes: Replace "KasmVNC web viewer" with "Selkies web viewer"

4. Keep everything else the same (id, name, tagline, category, version, developer, website, repo, support, icon, gallery, dependencies, path, defaultUsername, defaultPassword, backupIgnore)

Do NOT change the manifestVersion, id, name, tagline, category, version, or any other fields not listed above.
  </action>
  <verify>
Read both files after changes and confirm:
1. docker-compose.yml has NO `version:` line, has healthcheck block with curl to localhost:3000, retains all existing config
2. livinity-app.yml has `port: 3000`, description says "Selkies" not "KasmVNC", releaseNotes says "Selkies" not "KasmVNC"
  </verify>
  <done>
docker-compose.yml has health check monitoring Selkies on port 3000, restart policy, memory limits, and security config. livinity-app.yml has correct port 3000 and Selkies references.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All four chromium/ files exist and are valid YAML/Dockerfile/shell syntax
2. Port references are consistently 3000 (Selkies), not 6901 (KasmVNC)
3. docker-compose.yml has: build, shm_size, mem_limit, security_opt, healthcheck, restart, volumes, environment
4. livinity-app.yml port matches the internal Selkies port (3000)
5. No references to "KasmVNC" remain in any file
6. Dockerfile still installs Node.js 22 and @playwright/mcp
7. clean-singletonlock.sh still removes SingletonLock/Socket/Cookie
</verification>

<success_criteria>
- All four gallery template files are correct and consistent
- Port is 3000 throughout (Selkies, not KasmVNC)
- Health check monitors Selkies on port 3000
- Container has restart policy, memory limits, shm_size, seccomp:unconfined
- Persistent sessions via /config volume mount
- Stale lock cleanup runs on container init
- Anti-detection flags present in CHROME_CLI
- CDP remote debugging port 9222 present in CHROME_CLI
</success_criteria>

<output>
After completion, create `.planning/phases/v1.3-01-container-app-store/01-01-SUMMARY.md`
</output>
