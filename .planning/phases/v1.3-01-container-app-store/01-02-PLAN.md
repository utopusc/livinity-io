---
phase: v1.3-01-container-app-store
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/livinityd/source/modules/apps/builtin-apps.ts
autonomous: true

must_haves:
  truths:
    - "User can find Chromium Browser in the App Store listing"
    - "Chromium entry shows correct port 3000 for Selkies access"
    - "Chromium entry has correct description (Selkies, not KasmVNC)"
    - "Install flow uses docker compose build for custom Dockerfile"
    - "Subdomain defaults to 'browser' for browser.domain.com access"
  artifacts:
    - path: "livos/packages/livinityd/source/modules/apps/builtin-apps.ts"
      provides: "Chromium Browser entry in BUILTIN_APPS array"
      contains: "id: 'chromium'"
  key_links:
    - from: "builtin-apps.ts chromium entry"
      to: "App Store UI listing"
      via: "getBuiltinApp('chromium') and getBuiltinAppsByCategory()"
      pattern: "id:\\s*'chromium'"
    - from: "builtin-apps.ts port field"
      to: "patchComposeFile port mapping"
      via: "manifest.port used for host:container port mapping"
      pattern: "port:\\s*3000"
    - from: "builtin-apps.ts installOptions.subdomain"
      to: "Caddy reverse proxy routing"
      via: "subdomain 'browser' maps to browser.domain.com"
      pattern: "subdomain:\\s*'browser'"
---

<objective>
Update the Chromium Browser entry in builtin-apps.ts to use the correct Selkies port (3000), fix the description, and ensure the install flow works with the custom Dockerfile.

Purpose: The builtin-apps.ts entry is what the App Store UI displays and what drives the install flow. The port field is critical because patchComposeFile() uses it to create the host:container port mapping that Caddy routes to.

Output: Updated chromium entry in builtin-apps.ts with correct port and description
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\ROADMAP.md
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\STATE.md

This plan modifies the MAIN livinity-io repo (NOT the gallery repo).

File to update:
@livos/packages/livinityd/source/modules/apps/builtin-apps.ts

Key context about how the builtin-apps entry works:
- The BuiltinAppManifest interface defines: id, name, tagline, version, category, port, description, website, developer, icon, docker (image, environment, volumes), installOptions (subdomain, environmentOverrides)
- `port` field is used by patchComposeFile() to create the host port mapping (e.g., port 3000 on host maps to internal container port)
- patchComposeFile() auto-detects internal container port: it checks ports/expose directives, then falls back to commonPorts map, then 8080 default
- For chromium, the internal Selkies port is 3000. Since patchComposeFile has no chromium entry in commonPorts, it would fall back to 8080 which is WRONG
- The docker-compose.yml in the gallery does NOT have explicit port mappings (patchComposeFile adds them)
- `installOptions.subdomain: 'browser'` makes the app accessible at browser.domain.com
- `docker.image` is shown for reference but the actual install uses `docker compose up --build` which reads the Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Chromium entry in builtin-apps.ts</name>
  <files>livos/packages/livinityd/source/modules/apps/builtin-apps.ts</files>
  <action>
Read the full builtin-apps.ts file. Find the chromium entry (starts around line 239-263). Make these specific changes:

1. Change `port: 6901` to `port: 3000`
   - This is CRITICAL. The port field is used by patchComposeFile() to create the host:container port mapping.
   - Selkies listens on port 3000 inside the container, NOT 6901 (that was KasmVNC).

2. Update the `description` string:
   - Change "KasmVNC web viewer" to "Selkies web viewer"
   - Keep the rest of the description text identical

3. Everything else stays the same:
   - id: 'chromium'
   - name: 'Chromium Browser'
   - tagline: 'Persistent web browser with AI control'
   - version: '1.0.0'
   - category: 'networking'
   - website, developer, icon: unchanged
   - docker.image: 'lscr.io/linuxserver/chromium:latest' (unchanged - this is the base image reference)
   - docker.environment: unchanged (CUSTOM_USER, PASSWORD, CHROME_CLI, TZ all stay)
   - docker.volumes: unchanged (['/config'])
   - installOptions.subdomain: 'browser' (unchanged)

Do NOT change any other app entries in the file. Only modify the chromium object.
  </action>
  <verify>
Read the updated file and confirm:
1. The chromium entry has `port: 3000` (not 6901)
2. The description contains "Selkies web viewer" (not "KasmVNC")
3. All other fields are unchanged
4. No other app entries were modified
5. File has no syntax errors (TypeScript compiles)

Run: `cd C:\Users\hello\Desktop\Projects\contabo\livinity-io && npx tsc --noEmit --project livos/packages/livinityd/tsconfig.json 2>&1 | head -20`
(If tsconfig path is different, find it first with: `ls livos/packages/livinityd/tsconfig*`)
  </verify>
  <done>
Chromium entry in builtin-apps.ts has port 3000 (Selkies), correct description, and all other fields unchanged. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add chromium to patchComposeFile commonPorts map</name>
  <files>livos/packages/livinityd/source/modules/apps/app.ts</files>
  <action>
Read app.ts and find the `commonPorts` map inside patchComposeFile() (around line 149-161). This map provides fallback internal port detection when docker-compose.yml has no explicit port mappings.

Add `'chromium': 3000` to the commonPorts Record. This ensures patchComposeFile correctly maps `3000:3000` (host port from manifest.port to container's Selkies port) even though the docker-compose.yml has no explicit ports/expose directive.

The current map looks like:
```typescript
const commonPorts: Record<string, number> = {
  'code-server': 8080,
  'vikunja': 3456,
  'nextcloud': 80,
  'jellyfin': 8096,
  'gitea': 3000,
  'grafana': 3000,
  'uptime-kuma': 3001,
  'n8n': 5678,
  'portainer': 9000,
  'home-assistant': 8123,
}
```

Add `'chromium': 3000,` to this map. Place it alphabetically (after 'code-server').

This is needed because:
- The docker-compose.yml in the gallery has no `ports:` or `expose:` directive
- Without this entry, patchComposeFile falls back to port 8080 which is WRONG
- Selkies inside linuxserver/chromium listens on port 3000
  </action>
  <verify>
Read the updated app.ts and confirm:
1. `commonPorts` map includes `'chromium': 3000`
2. No other changes were made to the file
3. TypeScript still compiles
  </verify>
  <done>
patchComposeFile correctly maps chromium's internal Selkies port 3000 when creating host:container port binding.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. builtin-apps.ts chromium entry has port 3000 and Selkies description
2. app.ts commonPorts has chromium -> 3000 entry
3. TypeScript compiles without errors
4. The install flow will work: user clicks Install -> appStore.getAppTemplateFilePath('chromium') returns gallery path -> rsync copies to app-data -> patchComposeFile creates 3000:3000 port mapping -> docker compose up --build builds Dockerfile -> container starts with Selkies on port 3000 -> Caddy routes browser.domain.com to port 3000
</verification>

<success_criteria>
- Chromium shows in App Store with correct metadata
- Port 3000 is used throughout (manifest, commonPorts, container)
- Description references Selkies, not KasmVNC
- Subdomain 'browser' configured for browser.domain.com access
- patchComposeFile will correctly map 3000:3000 for the chromium app
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/v1.3-01-container-app-store/01-02-SUMMARY.md`
</output>
