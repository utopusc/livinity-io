---
phase: 07-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/core/src/auth.ts
  - nexus/packages/core/src/api.ts
autonomous: true

must_haves:
  truths:
    - "Nexus API requires X-API-Key header for protected endpoints"
    - "Health endpoint (/api/health) remains public"
    - "Invalid or missing API key returns 401 Unauthorized"
    - "Service gracefully degrades if LIV_API_KEY not configured"
  artifacts:
    - path: "nexus/packages/core/src/auth.ts"
      provides: "API key validation middleware for Nexus"
      exports: ["requireApiKey"]
      contains: "timingSafeEqual"
    - path: "nexus/packages/core/src/api.ts"
      provides: "Nexus API with auth middleware"
      contains: "requireApiKey"
  key_links:
    - from: "nexus/packages/core/src/api.ts"
      to: "nexus/packages/core/src/auth.ts"
      via: "import requireApiKey"
      pattern: "import.*requireApiKey.*from.*auth"
    - from: "nexus/packages/core/src/auth.ts"
      to: "process.env.LIV_API_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.LIV_API_KEY"
---

<objective>
Add API key authentication to the Nexus API (port 3200).

Purpose: SEC-06 requires that internal Nexus endpoints authenticate requests. The Nexus API exposes subagent management, schedules, MCP configuration, and agent streaming endpoints.

Output: Auth middleware module and protected Nexus API endpoints.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-security-hardening/07-RESEARCH.md
@nexus/packages/core/src/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware module for Nexus core</name>
  <files>nexus/packages/core/src/auth.ts</files>
  <action>
Create a new file `nexus/packages/core/src/auth.ts` with API key validation middleware:

1. Import `timingSafeEqual` from `node:crypto`
2. Import Express types: `Request`, `Response`, `NextFunction`
3. Import `logger` from `./logger.js`
4. Read `LIV_API_KEY` from `process.env`
5. Export `requireApiKey` middleware function that:
   - If no API key configured: `logger.warn('[Auth] LIV_API_KEY not configured - running without authentication')` and call `next()`
   - Extract key from `req.headers['x-api-key']`
   - If missing: return 401 with `{ error: 'Missing API key' }`
   - Use `Buffer.from()` for both keys with `'utf8'` encoding
   - Check length match first (required for timingSafeEqual)
   - Use `timingSafeEqual` for constant-time comparison
   - If invalid: return 401 with `{ error: 'Invalid API key' }`
   - If valid: call `next()`
6. Wrap timingSafeEqual in try/catch, log error with logger.error, return 401

Use the existing `logger` module for consistency with Nexus logging patterns.
DO NOT log the actual API key values.
  </action>
  <verify>
File exists: `ls nexus/packages/core/src/auth.ts`
Contains timingSafeEqual: `grep -l "timingSafeEqual" nexus/packages/core/src/auth.ts`
Uses logger: `grep -l "logger\\.warn\\|logger\\.error" nexus/packages/core/src/auth.ts`
  </verify>
  <done>
auth.ts exists with requireApiKey middleware using timingSafeEqual and Nexus logger.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate auth middleware into Nexus API</name>
  <files>nexus/packages/core/src/api.ts</files>
  <action>
Modify `nexus/packages/core/src/api.ts` to use the auth middleware:

1. Add import at top: `import { requireApiKey } from './auth.js'`
2. Inside `createApiServer` function, after the existing setup but BEFORE routes:
   - Keep `/api/health` endpoint where it is (line ~109)
   - Add auth middleware AFTER health check: `app.use('/api', requireApiKey)`

The structure should be:
```
app.use(express.json())
app.use('/api/apps', createAppRoutes(appManager))  // This already exists

// Health check BEFORE auth
app.get('/api/health', ...)  // Already exists at line ~109

// Auth middleware for all other /api routes
app.use('/api', requireApiKey)

// All other /api/* routes (webhooks, notifications, MCP, etc.)
```

IMPORTANT: The `/api/apps` routes are mounted early - they also need protection. Move the health check BEFORE apps routes, OR apply requireApiKey to apps routes separately.

Actually, looking at the code structure:
1. Move `/api/health` handler to be the FIRST route (before apps)
2. Then add `app.use('/api', requireApiKey)` AFTER health but BEFORE apps
3. This protects all /api/* routes except /api/health

DO NOT change any route logic, only add the middleware and reorder health check.
  </action>
  <verify>
Check import: `grep -l "import.*requireApiKey" nexus/packages/core/src/api.ts`
Check health is early: `grep -n "/api/health" nexus/packages/core/src/api.ts`
Check middleware: `grep -n "app.use.*requireApiKey" nexus/packages/core/src/api.ts`
TypeScript compiles: `cd nexus && pnpm exec tsc --noEmit 2>&1 | head -30 || echo "Check for errors"`
  </verify>
  <done>
Nexus API has auth middleware applied after /api/health but before all other routes.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. auth.ts exports requireApiKey middleware
3. api.ts imports and uses requireApiKey
4. /api/health endpoint is NOT protected
5. All other /api/* endpoints are protected
</verification>

<success_criteria>
- Nexus API auth middleware created with timingSafeEqual
- /api/health remains public, all other routes require X-API-Key
- Graceful degradation when LIV_API_KEY not configured
- TypeScript compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-hardening/07-02-SUMMARY.md`
</output>
