---
phase: 07-security-hardening
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - nexus/packages/core/src/daemon.ts
autonomous: true

must_haves:
  truths:
    - "Daemon memory service calls include X-API-Key header"
    - "Memory service calls work after auth is enabled"
    - "API key is read from LIV_API_KEY environment variable"
  artifacts:
    - path: "nexus/packages/core/src/daemon.ts"
      provides: "Daemon with authenticated memory service calls"
      contains: "X-API-Key"
  key_links:
    - from: "nexus/packages/core/src/daemon.ts"
      to: "http://localhost:3300"
      via: "fetch with X-API-Key header"
      pattern: "X-API-Key.*process\\.env\\.LIV_API_KEY"
---

<objective>
Update daemon.ts to include X-API-Key headers when calling the memory service.

Purpose: After 07-01 adds API key authentication to the memory service, existing callers (daemon.ts) must send the X-API-Key header or requests will fail with 401. There are 4 fetch calls to localhost:3300 that need updating.

Output: daemon.ts with authenticated memory service calls.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-security-hardening/07-01-SUMMARY.md
@nexus/packages/core/src/daemon.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add X-API-Key header to memory service fetch calls</name>
  <files>nexus/packages/core/src/daemon.ts</files>
  <action>
Update all 4 fetch calls to localhost:3300 in daemon.ts to include the X-API-Key header.

The calls are at approximately:
- Line 840: `fetch('http://localhost:3300/add', ...)` - in message handling
- Line 1337: `fetch('http://localhost:3300/search', ...)` - memory search
- Line 1380: `fetch('http://localhost:3300/add', ...)` - memory add
- Line 2332: `fetch('http://localhost:3300/add', ...)` - another add call

For each fetch call, add the X-API-Key header to the headers object:

```typescript
headers: {
  'Content-Type': 'application/json',
  'X-API-Key': process.env.LIV_API_KEY || '',
},
```

If the fetch call doesn't have a headers object yet, add one.

DO NOT change any other logic in the fetch calls.
DO NOT modify request body or URL.
DO use `process.env.LIV_API_KEY || ''` to handle undefined case gracefully.
  </action>
  <verify>
Count X-API-Key occurrences: `grep -c "X-API-Key" nexus/packages/core/src/daemon.ts` should return 4 or more
Check pattern: `grep -n "X-API-Key.*LIV_API_KEY" nexus/packages/core/src/daemon.ts` should show 4 lines
TypeScript compiles: `cd nexus && pnpm exec tsc --noEmit 2>&1 | head -20 || echo "Check for errors"`
  </verify>
  <done>
All 4 memory service fetch calls in daemon.ts include X-API-Key header reading from LIV_API_KEY env var.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify daemon-to-memory integration</name>
  <files></files>
  <action>
After updating the fetch calls, verify the daemon can still communicate with the memory service:

1. Check TypeScript compilation passes
2. Verify the header pattern is consistent across all 4 calls
3. Confirm no syntax errors introduced

If running locally with LIV_API_KEY set, the daemon should now successfully call the memory service.
  </action>
  <verify>
TypeScript compiles: `cd nexus && pnpm exec tsc --noEmit -p packages/core/tsconfig.json 2>&1 | head -20`
All fetch calls have headers: `grep -B2 -A5 "localhost:3300" nexus/packages/core/src/daemon.ts | grep -c "X-API-Key"` equals 4
  </verify>
  <done>
daemon.ts compiles, all 4 memory service calls have X-API-Key header.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. All 4 fetch calls to localhost:3300 include X-API-Key header
3. Header value reads from process.env.LIV_API_KEY
4. No other changes to fetch call logic
</verification>

<success_criteria>
- daemon.ts has 4 fetch calls with X-API-Key headers
- API key is read from LIV_API_KEY environment variable
- TypeScript compiles successfully
- Memory service integration will work after auth is enabled
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-hardening/07-04-SUMMARY.md`
</output>
