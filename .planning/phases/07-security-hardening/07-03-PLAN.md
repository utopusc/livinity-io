---
phase: 07-security-hardening
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - livos/.env
autonomous: false

user_setup:
  - service: google-ai-studio
    why: "Rotate GEMINI_API_KEY"
    env_vars:
      - name: GEMINI_API_KEY
        source: "https://aistudio.google.com/app/apikey - Delete old key, create new"
    dashboard_config: []

must_haves:
  truths:
    - "Old GEMINI_API_KEY is revoked (no longer works)"
    - "New JWT_SECRET is 64 hex characters (32 bytes)"
    - "New LIV_API_KEY is 64 hex characters (32 bytes)"
    - "All services restart successfully with new secrets"
    - "API authentication works end-to-end after rotation"
  artifacts:
    - path: "livos/.env"
      provides: "Updated secrets"
      contains: "JWT_SECRET="
  key_links:
    - from: "livos/.env"
      to: "nexus/packages/core/src/auth.ts"
      via: "LIV_API_KEY environment variable"
      pattern: "LIV_API_KEY"
---

<objective>
Rotate all production secrets that were exposed during development.

Purpose: SEC-04 requires rotation of GEMINI_API_KEY, JWT_SECRET, and LIV_API_KEY. These secrets were visible in repository history before Phase 2 added .gitignore coverage.

Output: New secrets in .env, old secrets revoked, services verified working.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-security-hardening/07-RESEARCH.md
@livos/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate new local secrets</name>
  <files></files>
  <action>
Generate new cryptographically secure secrets using openssl:

1. Generate new JWT_SECRET:
   ```bash
   openssl rand -hex 32
   ```
   Copy this value - it's your new JWT_SECRET

2. Generate new LIV_API_KEY:
   ```bash
   openssl rand -hex 32
   ```
   Copy this value - it's your new LIV_API_KEY

3. Display both values clearly for the user to copy.

These are the secrets that can be generated locally. GEMINI_API_KEY requires manual rotation via Google dashboard (handled in checkpoint).
  </action>
  <verify>
Both commands produce 64 character hex strings.
  </verify>
  <done>
Two new 64-character hex secrets generated and displayed.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Rotate secrets and restart services</action>
  <instructions>
## Secret Rotation Checklist

### Step 1: Update livos/.env with new secrets

Open `livos/.env` and update these values:

```bash
# Replace with the generated values from Task 1:
JWT_SECRET=<new-jwt-secret-from-task-1>
LIV_API_KEY=<new-liv-api-key-from-task-1>
```

### Step 2: Rotate GEMINI_API_KEY (Google AI Studio)

1. Go to https://aistudio.google.com/app/apikey
2. Find your current API key (starts with "AIzaSy...")
3. **Delete** the old key (this revokes it immediately)
4. Create a **new** API key
5. Copy the new key to `livos/.env`:
   ```bash
   GEMINI_API_KEY=<new-key-from-google>
   ```

### Step 3: Restart all services

```bash
# On the server:
pm2 restart all
pm2 status  # Verify all services are online
```

### Step 4: Verify authentication works

Test that the new LIV_API_KEY works with the auth middleware:

```bash
# Test Memory service auth (should return 401 without key)
curl http://localhost:3300/add -X POST -H "Content-Type: application/json" -d '{"userId":"test","content":"test"}'

# Test Memory service auth (should succeed with key)
curl http://localhost:3300/add -X POST \
  -H "Content-Type: application/json" \
  -H "X-API-Key: <your-new-liv-api-key>" \
  -d '{"userId":"test","content":"test"}'

# Test health endpoints remain public
curl http://localhost:3300/health
curl http://localhost:3200/api/health
```

### Step 5: Test AI chat end-to-end

1. Open the LivOS UI in browser
2. Navigate to AI Chat
3. Send a test message
4. Verify you get a response (confirms GEMINI_API_KEY rotation worked)

  </instructions>
  <resume-signal>Type "secrets rotated" when all steps completed successfully, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify rotation success</name>
  <files></files>
  <action>
After user confirms rotation, verify the system state:

1. Check PM2 status shows all services online
2. Confirm health endpoints respond without auth
3. Confirm protected endpoints require auth
4. Log completion status

If any verification fails, report the issue for troubleshooting.
  </action>
  <verify>
Health endpoints return 200.
Protected endpoint without key returns 401.
PM2 shows all services as "online".
  </verify>
  <done>
Secret rotation verified: services online, auth working, health public.
  </done>
</task>

</tasks>

<verification>
1. JWT_SECRET is a new 64-character hex value
2. LIV_API_KEY is a new 64-character hex value
3. Old GEMINI_API_KEY is deleted from Google AI Studio
4. New GEMINI_API_KEY is active and working
5. All services restart successfully
6. Auth middleware works (401 without key, 200 with key)
7. Health endpoints remain public
8. AI chat works end-to-end
</verification>

<success_criteria>
- All three secrets rotated
- Old GEMINI_API_KEY revoked
- Services running with new secrets
- Authentication verified working
- AI functionality confirmed working
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-hardening/07-03-SUMMARY.md`
</output>
