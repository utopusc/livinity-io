---
phase: 07-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/memory/src/auth.ts
  - nexus/packages/memory/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Memory service requires X-API-Key header for protected endpoints"
    - "Health endpoint remains public (no auth required)"
    - "Invalid or missing API key returns 401 Unauthorized"
    - "Service gracefully degrades if LIV_API_KEY not configured (warns but allows)"
  artifacts:
    - path: "nexus/packages/memory/src/auth.ts"
      provides: "API key validation middleware"
      exports: ["requireApiKey"]
      contains: "timingSafeEqual"
    - path: "nexus/packages/memory/src/index.ts"
      provides: "Memory service with auth middleware"
      contains: "requireApiKey"
  key_links:
    - from: "nexus/packages/memory/src/index.ts"
      to: "nexus/packages/memory/src/auth.ts"
      via: "import requireApiKey"
      pattern: "import.*requireApiKey.*from.*auth"
    - from: "nexus/packages/memory/src/auth.ts"
      to: "process.env.LIV_API_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.LIV_API_KEY"
---

<objective>
Add API key authentication to the memory service (port 3300).

Purpose: SEC-05 requires that the memory service authenticates requests to prevent unauthorized access to user memories and embeddings. The memory service stores sensitive conversation data.

Output: Auth middleware module and protected memory service endpoints.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-security-hardening/07-RESEARCH.md
@nexus/packages/memory/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware module</name>
  <files>nexus/packages/memory/src/auth.ts</files>
  <action>
Create a new file `nexus/packages/memory/src/auth.ts` with API key validation middleware:

1. Import `timingSafeEqual` from `node:crypto` (NOT just `crypto` - use node: prefix)
2. Import Express types: `Request`, `Response`, `NextFunction`
3. Read `LIV_API_KEY` from `process.env`
4. Export `requireApiKey` middleware function that:
   - If no API key configured: `console.warn()` and call `next()` (graceful degradation)
   - Extract key from `req.headers['x-api-key']`
   - If missing: return 401 with `{ error: 'Missing API key', hint: 'Provide X-API-Key header' }`
   - Use `Buffer.from()` for both keys with `'utf8'` encoding
   - Check length match first (required for timingSafeEqual)
   - Use `timingSafeEqual` for constant-time comparison
   - If invalid: return 401 with `{ error: 'Invalid API key' }`
   - If valid: call `next()`
5. Wrap timingSafeEqual in try/catch, return 401 on any error

DO NOT log the actual API key values.
DO use console.warn for missing config (not error - it's expected in dev).
  </action>
  <verify>
File exists: `ls nexus/packages/memory/src/auth.ts`
Contains timingSafeEqual: `grep -l "timingSafeEqual" nexus/packages/memory/src/auth.ts`
Exports requireApiKey: `grep -l "export.*requireApiKey" nexus/packages/memory/src/auth.ts`
  </verify>
  <done>
auth.ts exists with requireApiKey middleware using timingSafeEqual for constant-time comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate auth middleware into memory service</name>
  <files>nexus/packages/memory/src/index.ts</files>
  <action>
Modify `nexus/packages/memory/src/index.ts` to use the auth middleware:

1. Add import at top: `import { requireApiKey } from './auth.js'`
2. Keep the `/health` endpoint where it is (before auth middleware)
3. Add `app.use(requireApiKey)` AFTER the health endpoint but BEFORE all other routes
4. The order should be:
   - `app.get('/health', ...)` - PUBLIC
   - `app.use(requireApiKey)` - AUTH BARRIER
   - `app.post('/add', ...)` - PROTECTED
   - `app.post('/search', ...)` - PROTECTED
   - `app.get('/memories/:userId', ...)` - PROTECTED
   - etc.

DO NOT move or modify the health endpoint.
DO NOT change any route logic, only add the middleware.
  </action>
  <verify>
Check import: `grep -l "import.*requireApiKey" nexus/packages/memory/src/index.ts`
Check middleware placement: `grep -n "requireApiKey\|/health" nexus/packages/memory/src/index.ts`
TypeScript compiles: `cd nexus && pnpm exec tsc --noEmit -p packages/memory/tsconfig.json 2>&1 | head -20 || echo "Check for errors"`
  </verify>
  <done>
Memory service has auth middleware applied after /health but before all other routes.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. auth.ts exports requireApiKey middleware
3. index.ts imports and uses requireApiKey
4. /health endpoint is NOT protected (comes before middleware)
5. All other endpoints are protected (come after middleware)
</verification>

<success_criteria>
- Memory service auth middleware created with timingSafeEqual
- /health remains public, all other routes require X-API-Key
- Graceful degradation when LIV_API_KEY not configured
- TypeScript compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-hardening/07-01-SUMMARY.md`
</output>
