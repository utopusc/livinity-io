---
phase: 05-configurability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/ui/vite.config.ts
  - livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx
  - livos/ecosystem.config.cjs
autonomous: true

must_haves:
  truths:
    - "Frontend marketplace URL is configurable via VITE_MARKETPLACE_URL"
    - "Frontend backend URL is configurable via VITE_BACKEND_URL"
    - "PM2 ecosystem config reads paths from environment variables"
    - "Application works with custom LIVOS_BASE_DIR setting"
  artifacts:
    - path: "livos/packages/ui/vite.config.ts"
      provides: "VITE_ variable definitions and proxy config"
      contains: "VITE_MARKETPLACE_URL"
    - path: "livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx"
      provides: "config-driven marketplace URL"
      pattern: "import\\.meta\\.env\\.VITE_"
    - path: "livos/ecosystem.config.cjs"
      provides: "environment-driven path configuration"
      contains: "process.env.LIVOS_BASE_DIR"
  key_links:
    - from: "marketplace-app-window.tsx"
      to: "vite.config.ts"
      via: "import.meta.env.VITE_MARKETPLACE_URL"
      pattern: "VITE_MARKETPLACE_URL"
    - from: "ecosystem.config.cjs"
      to: "environment"
      via: "process.env.LIVOS_*"
      pattern: "process\\.env\\.LIVOS_"
---

<objective>
Replace hardcoded domains in frontend with VITE_ environment variables and replace hardcoded paths in PM2 ecosystem config with environment variable defaults.

Purpose: Frontend code cannot import @livos/config (server-side only), so it uses Vite's build-time environment variable injection. Infrastructure files (ecosystem.config.cjs) are CommonJS and use process.env with sensible defaults.

Output: Frontend that reads marketplace URL from environment, and PM2 config that respects LIVOS_BASE_DIR for custom installations.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configurability/05-RESEARCH.md

# Files to modify
@livos/packages/ui/vite.config.ts
@livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx
@livos/ecosystem.config.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded domains in frontend with VITE_ variables</name>
  <files>
    livos/packages/ui/vite.config.ts
    livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx
  </files>
  <action>
    1. In vite.config.ts:
       - Find the hardcoded `https://livinity.cloud` in proxy target (around line 19)
       - Replace with environment variable:
         ```typescript
         target: process.env.VITE_BACKEND_URL || 'https://livinity.cloud',
         ```
       - Add a `define` block if not present to expose marketplace URL:
         ```typescript
         define: {
           '__MARKETPLACE_URL__': JSON.stringify(
             process.env.VITE_MARKETPLACE_URL || 'https://apps.livinity.io'
           ),
         },
         ```
       - This makes the URL available at build time without exposing it in import.meta.env

    2. In marketplace-app-window.tsx:
       - Find the hardcoded MARKETPLACE_URL constant (around line 7):
         ```typescript
         const MARKETPLACE_URL = 'https://apps.livinity.io';
         ```
       - Replace with build-time constant:
         ```typescript
         declare const __MARKETPLACE_URL__: string;
         const MARKETPLACE_URL = __MARKETPLACE_URL__;
         ```
       - Find any other hardcoded `apps.livinity.io` references (around line 23) and replace similarly
       - The `declare const` tells TypeScript about the global defined in vite.config.ts

    Note: Using `define` with `__MARKETPLACE_URL__` instead of `import.meta.env.VITE_MARKETPLACE_URL` because define does string replacement at build time, which is cleaner for constants.
  </action>
  <verify>
    1. Grep for remaining hardcoded domains:
       ```bash
       grep -n "livinity\.cloud\|apps\.livinity\.io" livos/packages/ui/vite.config.ts livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx
       ```
       vite.config.ts may show the fallback default (acceptable).
       marketplace-app-window.tsx should show no matches.

    2. TypeScript check:
       ```bash
       cd livos/packages/ui && pnpm tsc --noEmit
       ```
  </verify>
  <done>
    - vite.config.ts proxy target uses VITE_BACKEND_URL with fallback
    - vite.config.ts defines __MARKETPLACE_URL__ from VITE_MARKETPLACE_URL
    - marketplace-app-window.tsx uses __MARKETPLACE_URL__ constant
    - No hardcoded domains in marketplace-app-window.tsx
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded paths in ecosystem.config.cjs</name>
  <files>
    livos/ecosystem.config.cjs
  </files>
  <action>
    1. At the top of ecosystem.config.cjs, add base path variable:
       ```javascript
       const LIVOS_BASE = process.env.LIVOS_BASE_DIR || '/opt/livos';
       const LIVOS_DATA = process.env.LIVOS_DATA_DIR || `${LIVOS_BASE}/data`;
       const LIVOS_LOGS = process.env.LIVOS_LOGS_DIR || `${LIVOS_BASE}/logs`;
       ```

    2. Replace all hardcoded `/opt/livos` paths in the apps array:
       - `cwd: '/opt/livos/packages/livinityd'` -> `cwd: \`${LIVOS_BASE}/packages/livinityd\``
       - `--data-directory /opt/livos/data` -> `--data-directory ${LIVOS_DATA}`
       - `log_file: '/opt/livos/logs/...'` -> `log_file: \`${LIVOS_LOGS}/...\``
       - And similar for error_file, out_file paths

    3. Each app in the config should use the variables:
       ```javascript
       {
         name: 'livos',
         script: 'source/cli.ts',
         cwd: `${LIVOS_BASE}/packages/livinityd`,
         args: `--data-directory ${LIVOS_DATA} --port 8080`,
         log_file: `${LIVOS_LOGS}/livos.log`,
         error_file: `${LIVOS_LOGS}/livos-error.log`,
         out_file: `${LIVOS_LOGS}/livos-out.log`,
         // ... rest of config
       }
       ```

    4. Apply same pattern to all apps defined in the file (typically 3-4 apps).

    Note: This is a CommonJS file, so use template literals with ${} for string interpolation, not ES6 imports.
  </action>
  <verify>
    1. Grep for remaining hardcoded paths:
       ```bash
       grep -n "/opt/livos" livos/ecosystem.config.cjs
       ```
       Should only show the default fallback values in the variable declarations.

    2. Syntax check:
       ```bash
       node --check livos/ecosystem.config.cjs
       ```
  </verify>
  <done>
    - LIVOS_BASE, LIVOS_DATA, LIVOS_LOGS variables defined at top
    - All cwd paths use ${LIVOS_BASE}
    - All data paths use ${LIVOS_DATA}
    - All log paths use ${LIVOS_LOGS}
    - File parses without syntax errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Frontend config is environment-driven:
   ```bash
   grep -c "VITE_" livos/packages/ui/vite.config.ts
   ```
   Should return at least 2 (VITE_BACKEND_URL and VITE_MARKETPLACE_URL references).

2. No hardcoded domains in frontend component:
   ```bash
   grep "livinity" livos/packages/ui/src/modules/window/app-contents/app-store-routes/marketplace-app-window.tsx
   ```
   Should return empty.

3. ecosystem.config.cjs uses environment variables:
   ```bash
   grep -c "process.env.LIVOS" livos/ecosystem.config.cjs
   ```
   Should return at least 3 (BASE_DIR, DATA_DIR, LOGS_DIR).

4. Both files parse correctly:
   ```bash
   cd livos/packages/ui && pnpm tsc --noEmit
   node --check livos/ecosystem.config.cjs
   ```
</verification>

<success_criteria>
- vite.config.ts uses VITE_BACKEND_URL and VITE_MARKETPLACE_URL
- marketplace-app-window.tsx uses __MARKETPLACE_URL__ constant (no hardcoded domains)
- ecosystem.config.cjs reads LIVOS_BASE_DIR, LIVOS_DATA_DIR, LIVOS_LOGS_DIR from environment
- Zero hardcoded "/opt/livos" in ecosystem.config.cjs (except as fallback defaults)
- All files parse/compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-configurability/05-02-SUMMARY.md`
</output>
