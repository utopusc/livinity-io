---
phase: 05-configurability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - nexus/packages/core/src/logger.ts
  - nexus/packages/core/src/daemon.ts
  - nexus/packages/core/src/shell.ts
  - nexus/packages/core/src/index.ts
  - nexus/skills/content.ts
  - nexus/skills/leadgen-auto.ts
  - nexus/skills/research.ts
  - nexus/skills/site-audit.ts
autonomous: true

must_haves:
  truths:
    - "Nexus logger writes to configurable log path"
    - "Nexus daemon uses configurable base directory"
    - "Nexus shell operates in configurable workspace"
    - "Nexus index loads skills from configurable directory"
    - "Nexus skills save output to configurable directory"
  artifacts:
    - path: "nexus/packages/core/src/logger.ts"
      provides: "config-driven log file path"
      pattern: "process\\.env\\.NEXUS_"
    - path: "nexus/packages/core/src/daemon.ts"
      provides: "config-driven log paths"
      pattern: "process\\.env\\.NEXUS_"
    - path: "nexus/packages/core/src/shell.ts"
      provides: "config-driven base directory"
      pattern: "process\\.env\\.NEXUS_"
    - path: "nexus/packages/core/src/index.ts"
      provides: "config-driven skills and base paths"
      pattern: "process\\.env\\.NEXUS_"
    - path: "nexus/skills/content.ts"
      provides: "config-driven output path in prompts"
      pattern: "process\\.env\\.NEXUS_OUTPUT_DIR"
    - path: "nexus/skills/leadgen-auto.ts"
      provides: "config-driven output path in prompts"
      pattern: "process\\.env\\.NEXUS_OUTPUT_DIR"
    - path: "nexus/skills/research.ts"
      provides: "config-driven output path in prompts"
      pattern: "process\\.env\\.NEXUS_OUTPUT_DIR"
    - path: "nexus/skills/site-audit.ts"
      provides: "config-driven output path in prompts"
      pattern: "process\\.env\\.NEXUS_OUTPUT_DIR"
  key_links:
    - from: "nexus/packages/core/src/logger.ts"
      to: "environment"
      via: "process.env.NEXUS_LOGS_DIR"
      pattern: "NEXUS_LOGS_DIR"
    - from: "nexus/packages/core/src/index.ts"
      to: "environment"
      via: "process.env.NEXUS_SKILLS_DIR"
      pattern: "NEXUS_SKILLS_DIR"
    - from: "nexus/skills/*.ts"
      to: "environment"
      via: "process.env.NEXUS_OUTPUT_DIR"
      pattern: "NEXUS_OUTPUT_DIR"
---

<objective>
Replace hardcoded /opt/nexus paths in Nexus core package and skills with environment variable-driven configuration.

Purpose: Nexus is a separate workspace that may not have direct access to @livos/config. Using environment variables with NEXUS_ prefix (established in Phase 1) provides the same configurability without adding a cross-workspace dependency.

Output: Nexus core modules and skill files that read NEXUS_BASE_DIR, NEXUS_LOGS_DIR, NEXUS_SKILLS_DIR, and NEXUS_OUTPUT_DIR from environment with sensible defaults.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configurability/05-RESEARCH.md

# Files to modify - core
@nexus/packages/core/src/logger.ts
@nexus/packages/core/src/daemon.ts
@nexus/packages/core/src/shell.ts
@nexus/packages/core/src/index.ts

# Files to modify - skills
@nexus/skills/content.ts
@nexus/skills/leadgen-auto.ts
@nexus/skills/research.ts
@nexus/skills/site-audit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded paths in logger.ts and daemon.ts</name>
  <files>
    nexus/packages/core/src/logger.ts
    nexus/packages/core/src/daemon.ts
  </files>
  <action>
    1. In logger.ts:
       - Add path import at top: `import path from 'node:path';`
       - Add environment variable with default at top of file:
         ```typescript
         const NEXUS_LOGS_DIR = process.env.NEXUS_LOGS_DIR || '/opt/nexus/logs';
         ```
       - Find hardcoded `/opt/nexus/logs/nexus.log` (around line 14)
       - Replace with:
         ```typescript
         filename: path.join(NEXUS_LOGS_DIR, 'nexus.log')
         ```

    2. In daemon.ts:
       - Add path import if not present: `import path from 'node:path';`
       - Add environment variable with default near top:
         ```typescript
         const NEXUS_LOGS_DIR = process.env.NEXUS_LOGS_DIR || '/opt/nexus/logs';
         ```
       - Find hardcoded `/opt/nexus/logs/nexus.log` references (around lines 567, 998)
       - Replace each with:
         ```typescript
         path.join(NEXUS_LOGS_DIR, 'nexus.log')
         ```

    Use path.join() for cross-platform safety (even though production is Linux, development may be Windows/macOS).
  </action>
  <verify>
    1. Grep for remaining hardcoded paths:
       ```bash
       grep -n "/opt/nexus" nexus/packages/core/src/logger.ts nexus/packages/core/src/daemon.ts
       ```
       Should only show default fallback values.

    2. TypeScript check:
       ```bash
       cd nexus/packages/core && npm run build 2>/dev/null || npx tsc --noEmit
       ```
  </verify>
  <done>
    - logger.ts uses NEXUS_LOGS_DIR environment variable
    - daemon.ts uses NEXUS_LOGS_DIR environment variable
    - Both use path.join() for path construction
    - No hardcoded /opt/nexus/logs paths (except fallback defaults)
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded paths in shell.ts, index.ts, and nexus skills</name>
  <files>
    nexus/packages/core/src/shell.ts
    nexus/packages/core/src/index.ts
    nexus/skills/content.ts
    nexus/skills/leadgen-auto.ts
    nexus/skills/research.ts
    nexus/skills/site-audit.ts
  </files>
  <action>
    1. In shell.ts:
       - Add path import if not present: `import path from 'node:path';`
       - Add environment variable with default near top:
         ```typescript
         const NEXUS_BASE_DIR = process.env.NEXUS_BASE_DIR || '/opt/nexus';
         ```
       - Find hardcoded `/opt/nexus` reference (around line 21)
       - Replace with `NEXUS_BASE_DIR`
       - If it's used in a path construction, use path.join()

    2. In index.ts:
       - Add path import if not present: `import path from 'node:path';`
       - Add environment variables with defaults near top:
         ```typescript
         const NEXUS_BASE_DIR = process.env.NEXUS_BASE_DIR || '/opt/nexus';
         const NEXUS_SKILLS_DIR = process.env.NEXUS_SKILLS_DIR || '/opt/nexus/app/skills';
         ```
       - Find hardcoded `/opt/nexus` references (around lines 38, 87)
       - Replace with `NEXUS_BASE_DIR`
       - Find hardcoded `/opt/nexus/app/skills` reference (around line 41)
       - Replace with `NEXUS_SKILLS_DIR`
       - Use path.join() where paths are being constructed

    3. For each nexus skill file (content.ts, leadgen-auto.ts, research.ts, site-audit.ts):
       - Add path import at top: `import path from 'node:path';`
       - Add environment variable with default:
         ```typescript
         const NEXUS_OUTPUT_DIR = process.env.NEXUS_OUTPUT_DIR || '/opt/nexus/output';
         ```
       - Find hardcoded `/opt/nexus/output/` in prompt/instruction strings
       - Replace with dynamic path construction:
         ```typescript
         const outputPath = path.join(NEXUS_OUTPUT_DIR, `research-${Date.now()}.md`);
         // Use outputPath in the prompt string
         ```
       - Preserve existing filename patterns for each skill type

    Note: Each file can define its own constants - no need to share across files within the same package.
  </action>
  <verify>
    1. Grep for remaining hardcoded paths in core:
       ```bash
       grep -n "/opt/nexus" nexus/packages/core/src/shell.ts nexus/packages/core/src/index.ts
       ```
       Should only show default fallback values in variable declarations.

    2. Grep for remaining hardcoded paths in skills:
       ```bash
       grep -n "/opt/nexus" nexus/skills/content.ts nexus/skills/leadgen-auto.ts nexus/skills/research.ts nexus/skills/site-audit.ts
       ```
       Should only show default fallback values.

    3. TypeScript check:
       ```bash
       cd nexus/packages/core && npm run build 2>/dev/null || npx tsc --noEmit
       ```
  </verify>
  <done>
    - shell.ts uses NEXUS_BASE_DIR environment variable
    - index.ts uses NEXUS_BASE_DIR and NEXUS_SKILLS_DIR environment variables
    - All 4 nexus skill files use NEXUS_OUTPUT_DIR environment variable
    - Paths constructed with path.join() where appropriate
    - No hardcoded /opt/nexus paths (except fallback defaults)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. All Nexus core files use environment variables:
   ```bash
   grep -c "process.env.NEXUS" nexus/packages/core/src/logger.ts nexus/packages/core/src/daemon.ts nexus/packages/core/src/shell.ts nexus/packages/core/src/index.ts
   ```
   Each file should have at least 1 match.

2. All Nexus skill files use environment variables:
   ```bash
   grep -c "process.env.NEXUS" nexus/skills/content.ts nexus/skills/leadgen-auto.ts nexus/skills/research.ts nexus/skills/site-audit.ts
   ```
   Each file should have at least 1 match.

3. No hardcoded /opt/nexus in code (only in fallback defaults):
   ```bash
   grep -n "/opt/nexus" nexus/packages/core/src/*.ts nexus/skills/*.ts | grep -v "process.env" | grep -v "||"
   ```
   Should return empty (all /opt/nexus references should be in fallback context).

4. TypeScript compiles:
   ```bash
   cd nexus/packages/core && npm run build 2>/dev/null || npx tsc --noEmit
   ```
</verification>

<success_criteria>
- logger.ts reads NEXUS_LOGS_DIR from environment
- daemon.ts reads NEXUS_LOGS_DIR from environment
- shell.ts reads NEXUS_BASE_DIR from environment
- index.ts reads NEXUS_BASE_DIR and NEXUS_SKILLS_DIR from environment
- content.ts reads NEXUS_OUTPUT_DIR from environment
- leadgen-auto.ts reads NEXUS_OUTPUT_DIR from environment
- research.ts reads NEXUS_OUTPUT_DIR from environment
- site-audit.ts reads NEXUS_OUTPUT_DIR from environment
- All path construction uses path.join()
- Zero hardcoded /opt/nexus paths in active code (defaults in || expressions are acceptable)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-configurability/05-03-SUMMARY.md`
</output>
