---
phase: 05-configurability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/config/src/paths.ts
  - livos/packages/config/src/domains.ts
  - livos/packages/config/src/index.ts
  - livos/packages/livinityd/source/modules/system/update.ts
  - livos/packages/livinityd/source/modules/server/index.ts
autonomous: true

must_haves:
  truths:
    - "Config package exports paths.output for skills output directory"
    - "Config package exports domains.marketplace for app store URL"
    - "Config package exports domains.api for API subdomain"
    - "Backend update module reads API domain from config"
    - "Backend server module reads marketplace domain from config"
  artifacts:
    - path: "livos/packages/config/src/paths.ts"
      provides: "output path schema"
      contains: "output:"
    - path: "livos/packages/config/src/domains.ts"
      provides: "marketplace and api domain schemas"
      contains: "marketplace:"
    - path: "livos/packages/config/src/index.ts"
      provides: "environment variable bindings for new config values"
      contains: "LIVOS_OUTPUT_DIR"
    - path: "livos/packages/livinityd/source/modules/system/update.ts"
      provides: "config-driven API URL"
      pattern: "domains\\.(api|primary)"
    - path: "livos/packages/livinityd/source/modules/server/index.ts"
      provides: "config-driven CSP and marketplace URL"
      pattern: "domains\\.marketplace"
  key_links:
    - from: "livos/packages/livinityd/source/modules/system/update.ts"
      to: "@livos/config"
      via: "import { domains }"
      pattern: "from ['\"]@livos/config['\"]"
    - from: "livos/packages/livinityd/source/modules/server/index.ts"
      to: "@livos/config"
      via: "import { domains }"
      pattern: "from ['\"]@livos/config['\"]"
---

<objective>
Extend @livos/config with output path and marketplace/API domains, then replace hardcoded domain references in backend modules.

Purpose: Backend services need config-driven domains for API endpoints and CSP headers. Skills need an output directory path. This plan adds the missing config values and migrates the first batch of hardcoded domains.

Output: Extended config package with new paths/domains, and backend modules using config imports instead of hardcoded "livinity.cloud" and "livinity.io" strings.
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configurability/05-RESEARCH.md

# Config package (created in Phase 1)
@livos/packages/config/src/paths.ts
@livos/packages/config/src/domains.ts
@livos/packages/config/src/index.ts

# Files to modify
@livos/packages/livinityd/source/modules/system/update.ts
@livos/packages/livinityd/source/modules/server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend @livos/config with output path and marketplace/API domains</name>
  <files>
    livos/packages/config/src/paths.ts
    livos/packages/config/src/domains.ts
    livos/packages/config/src/index.ts
  </files>
  <action>
    1. In paths.ts, add to PathsConfigSchema:
       ```typescript
       /** Output directory for generated files (reports, exports) */
       output: z.string().default('/opt/livos/output'),
       ```

    2. In domains.ts, add to DomainsConfigSchema:
       ```typescript
       /** Marketplace/app store domain */
       marketplace: z.string().default('apps.livinity.io'),
       /** API subdomain prefix (combined with primary to form api.{primary}) */
       api: z.string().default('api'),
       ```

    3. In index.ts, add environment variable bindings in the paths object:
       ```typescript
       output: process.env.LIVOS_OUTPUT_DIR,
       ```

    4. In index.ts, add environment variable bindings in the domains object:
       ```typescript
       marketplace: process.env.LIVOS_MARKETPLACE_DOMAIN,
       api: process.env.LIVOS_API_SUBDOMAIN,
       ```

    Preserve the Object.freeze() pattern. Keep all existing fields unchanged.
  </action>
  <verify>
    Run TypeScript compilation:
    ```bash
    cd livos/packages/config && pnpm build
    ```
    Verify no type errors and dist/ files are updated.
  </verify>
  <done>
    - paths.output exists with default '/opt/livos/output'
    - domains.marketplace exists with default 'apps.livinity.io'
    - domains.api exists with default 'api'
    - Environment variables LIVOS_OUTPUT_DIR, LIVOS_MARKETPLACE_DOMAIN, LIVOS_API_SUBDOMAIN are bound
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded domains in backend modules</name>
  <files>
    livos/packages/livinityd/source/modules/system/update.ts
    livos/packages/livinityd/source/modules/server/index.ts
  </files>
  <action>
    1. In update.ts:
       - Add import: `import { domains } from '@livos/config';`
       - Find the hardcoded URL `https://api.livinity.cloud` (around line 52)
       - Replace with config-driven construction:
         ```typescript
         const apiDomain = `${domains.api}.${domains.primary}`;
         const protocol = domains.useHttps ? 'https' : 'http';
         const updateUrl = new URL(`${protocol}://${apiDomain}/latest-release`);
         ```
       - Remove any inline fallback strings like 'api.livinity.cloud'

    2. In server/index.ts:
       - Add import: `import { domains } from '@livos/config';`
       - Find the hardcoded CSP frameSrc containing `apps.livinity.io` (around line 137)
       - Replace with config-driven values:
         ```typescript
         frameSrc: [
           "'self'",
           `https://${domains.marketplace}`,
           `https://*.${domains.primary}`,
         ],
         ```
       - Remove any other hardcoded 'livinity.io' or 'livinity.cloud' references

    Ensure @livos/config is in the package's dependencies (should already be from monorepo setup).
  </action>
  <verify>
    1. Grep for remaining hardcoded domains in modified files:
       ```bash
       grep -n "livinity\.cloud\|livinity\.io" livos/packages/livinityd/source/modules/system/update.ts livos/packages/livinityd/source/modules/server/index.ts
       ```
       Should return no matches (or only comments).

    2. Verify TypeScript compiles:
       ```bash
       cd livos/packages/livinityd && pnpm build
       ```
  </verify>
  <done>
    - No hardcoded "livinity.cloud" in update.ts
    - No hardcoded "apps.livinity.io" in server/index.ts
    - Both files import and use @livos/config domains
    - CSP frameSrc is config-driven
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Config package exports new values:
   ```bash
   cd livos/packages/config
   node -e "const c = require('./dist/index.js'); console.log(c.paths.output, c.domains.marketplace, c.domains.api)"
   ```
   Should output: `/opt/livos/output apps.livinity.io api`

2. No hardcoded domains remain in backend:
   ```bash
   grep -rn "livinity\.cloud" livos/packages/livinityd/source/modules/system/
   grep -rn "apps\.livinity\.io" livos/packages/livinityd/source/modules/server/
   ```
   Both should return empty (no matches).

3. TypeScript builds succeed across affected packages.
</verification>

<success_criteria>
- @livos/config exports paths.output, domains.marketplace, domains.api
- update.ts uses domains.api + domains.primary for API URL construction
- server/index.ts uses domains.marketplace for CSP frameSrc
- Zero hardcoded "livinity.cloud" or "apps.livinity.io" in the modified backend files
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-configurability/05-01-SUMMARY.md`
</output>
