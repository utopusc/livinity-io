# Plan v1.5-02-02 Summary: Dual-mode AgentLoop

## Status: COMPLETE

## What was built

Dual-mode AgentLoop that detects the active AI provider and uses the appropriate tool calling mechanism:

- **Claude mode**: Native `tool_use` content blocks via API, proper `tool_use_id` tracking, `tool_result` blocks with `is_error` flag, simplified system prompt (no JSON format instructions)
- **Gemini mode**: Existing JSON-in-text `parseStep()` with `AGENT_SYSTEM_PROMPT` — completely unchanged

## Files modified

| File | Change |
|------|--------|
| `nexus/packages/core/src/agent.ts` | Added `CLAUDE_NATIVE_SYSTEM_PROMPT`, `useNativeTools` branching, Claude message array with content blocks, tool execution with `tool_use_id` tracking (+313 lines) |
| `nexus/packages/core/src/brain.ts` | Added `tools`, `rawClaudeMessages` to ChatOptions; `toolCalls`, `stopReason` to return types; `getActiveProviderId()` method |
| `nexus/packages/core/src/providers/manager.ts` | Added `getActiveProviderId()` method |

## Key implementation details

1. **Provider detection**: `brain.getActiveProviderId()` → `manager.getActiveProviderId()` checks availability in fallback order
2. **Parallel message arrays**: `messages[]` (ChatMessage, generic) + `claudeMessages[]` (raw Claude content blocks with tool_use/tool_result)
3. **rawClaudeMessages bypass**: When provided, Brain skips normalization and passes directly to provider
4. **spawn_subagent in Claude mode**: Dynamically added to `claudeTools` array with proper `input_schema`
5. **Tool results**: Each tool result includes `tool_use_id` from the original tool call, wrapped in `ToolResultBlock` format

## Verification

- TypeScript: `tsc --noEmit` — zero errors
- `useNativeTools` branching confirmed at 5 locations
- `tool_use_id` tracking confirmed at 2 locations
- `rawClaudeMessages` passthrough confirmed at 5 locations
- `parseStep` preserved for Gemini path
- `CLAUDE_NATIVE_SYSTEM_PROMPT` defined and used
- All existing callers unchanged

## Commit

`fe62cb1` — feat: dual-mode AgentLoop with native Claude tool calling
