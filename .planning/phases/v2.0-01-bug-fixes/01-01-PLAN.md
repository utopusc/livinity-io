---
phase: v2.0-01-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/ui/src/providers/window-manager.tsx
autonomous: true

must_haves:
  truths:
    - "Windows spawn at staggered positions based on current window count"
    - "Position calculation uses live state, not stale closure"
  artifacts:
    - path: "livos/packages/ui/src/providers/window-manager.tsx"
      provides: "Fixed window stacking with position calculation in reducer"
---

<objective>
Fix the window stacking bug where all windows spawn at the same position.

Root cause: openWindow useCallback has [] deps, capturing stale state.windows.length (always 0).
Fix: Move position calculation into the OPEN_WINDOW reducer case, which has access to live state.
</objective>

<context>
@livos/packages/ui/src/providers/window-manager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move position calculation into reducer</name>
  <files>livos/packages/ui/src/providers/window-manager.tsx</files>
  <action>
1. Change the OPEN_WINDOW action payload type to include appId for position calculation:

Change line 101 from:
```
| {type: 'OPEN_WINDOW'; payload: Omit<WindowState, 'zIndex'>}
```
to:
```
| {type: 'OPEN_WINDOW'; payload: Omit<WindowState, 'zIndex' | 'position'> & {appId: string}}
```

2. In the OPEN_WINDOW reducer case (lines 111-115), calculate position from live state:

Change from:
```typescript
case 'OPEN_WINDOW':
    return {
        windows: [...state.windows, {...action.payload, zIndex: state.nextZIndex}],
        nextZIndex: state.nextZIndex + 1,
    }
```
to:
```typescript
case 'OPEN_WINDOW': {
    const windowCount = state.windows.length
    const position = getInitialPosition(windowCount, action.payload.size, action.payload.appId)
    return {
        windows: [...state.windows, {...action.payload, position, zIndex: state.nextZIndex}],
        nextZIndex: state.nextZIndex + 1,
    }
}
```

3. In the openWindow callback (lines 174-197), remove the position calculation and pass appId:

Change from:
```typescript
const openWindow = useCallback((appId: string, route: string, title: string, icon: string): WindowId => {
    const id = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now().toString(36)
    const baseSize = DEFAULT_WINDOW_SIZES[appId] || DEFAULT_WINDOW_SIZES.default
    const size = getResponsiveSize(baseSize.width, baseSize.height)
    // Use current state.windows.length at call time, not as dependency
    const windowCount = state.windows.length

    dispatch({
        type: 'OPEN_WINDOW',
        payload: {
            id,
            appId,
            route,
            position: getInitialPosition(windowCount, size, appId),
            size,
            isMinimized: false,
            title,
            icon,
        },
    })

    return id
// eslint-disable-next-line react-hooks/exhaustive-deps
}, [])
```
to:
```typescript
const openWindow = useCallback((appId: string, route: string, title: string, icon: string): WindowId => {
    const id = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now().toString(36)
    const baseSize = DEFAULT_WINDOW_SIZES[appId] || DEFAULT_WINDOW_SIZES.default
    const size = getResponsiveSize(baseSize.width, baseSize.height)

    dispatch({
        type: 'OPEN_WINDOW',
        payload: {
            id,
            appId,
            route,
            size,
            isMinimized: false,
            title,
            icon,
        },
    })

    return id
}, [])
```
  </action>
  <verify>
Read livos/packages/ui/src/providers/window-manager.tsx and confirm:
- Position calculation happens inside OPEN_WINDOW case using state.windows.length
- openWindow callback no longer reads state.windows.length
- Empty deps array [] is now correct (no stale closure)
  </verify>
  <done>Windows now spawn at staggered positions using live state from the reducer.</done>
</task>

</tasks>

<verification>
After task completion:
1. Confirm getInitialPosition is called inside the reducer with state.windows.length
2. Confirm openWindow no longer references state.windows
3. Run `cd livos && pnpm build` to verify no TypeScript errors
</verification>
