---
phase: v2.0-01-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - livos/packages/ui/src/modules/window/windows-container.tsx
  - livos/packages/ui/src/modules/desktop/dock.tsx
  - livos/packages/ui/src/modules/desktop/dock-item.tsx
autonomous: true

must_haves:
  truths:
    - "On mobile, tapping AI Chat/Terminal/etc in dock opens a full-screen sheet instead of a broken window"
    - "WindowsContainer still returns null on mobile (windows are desktop-only)"
  artifacts:
    - path: "livos/packages/ui/src/modules/desktop/dock.tsx"
      provides: "Mobile dock items navigate to sheet routes instead of opening windows"
    - path: "livos/packages/ui/src/modules/desktop/dock-item.tsx"
      provides: "Dual-mode: window on desktop, link on mobile"
---

<objective>
Fix window-only apps being completely inaccessible on mobile.

Root cause: AI Chat, Terminal, Server Control, Subagents, and Schedules only have onOpenWindow (no `to` route). On mobile, WindowsContainer returns null, so these apps never render.

Fix approach: On mobile, dock items with onOpenWindow should navigate to a sheet route instead. We'll add the window-only apps as sheet routes and make the dock items route-aware on mobile.
</objective>

<context>
@livos/packages/ui/src/modules/desktop/dock.tsx
@livos/packages/ui/src/modules/desktop/dock-item.tsx
@livos/packages/ui/src/router.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sheet routes for window-only apps</name>
  <files>livos/packages/ui/src/router.tsx</files>
  <action>
Add lazy imports at the top (after the existing lazy imports around line 27-36):
```typescript
const AiChatPage = React.lazy(() => import('./routes/ai-chat'))
const ServerControlPage = React.lazy(() => import('./routes/server-control'))
const SubagentsPage = React.lazy(() => import('./routes/subagents'))
const SchedulesPage = React.lazy(() => import('./routes/schedules'))
const TerminalPage = React.lazy(() => import('./routes/terminal'))
```

Inside the SheetLayout children array (after the community-app-store routes, around line 116), add:
```typescript
{
    path: 'ai-chat',
    Component: AiChatPage,
    ErrorBoundary: ErrorBoundaryComponentFallback,
},
{
    path: 'server-control',
    Component: ServerControlPage,
    ErrorBoundary: ErrorBoundaryComponentFallback,
},
{
    path: 'subagents',
    Component: SubagentsPage,
    ErrorBoundary: ErrorBoundaryComponentFallback,
},
{
    path: 'schedules',
    Component: SchedulesPage,
    ErrorBoundary: ErrorBoundaryComponentFallback,
},
{
    path: 'terminal',
    Component: TerminalPage,
    ErrorBoundary: ErrorBoundaryComponentFallback,
},
```

Remove or update the NOTE comment on lines 38-39 about window-only apps.
  </action>
  <verify>
Read the file and confirm the new routes exist inside SheetLayout children.
  </verify>
  <done>Window-only apps now have sheet routes for mobile access.</done>
</task>

<task type="auto">
  <name>Task 2: Make dock items dual-mode (window on desktop, route on mobile)</name>
  <files>livos/packages/ui/src/modules/desktop/dock.tsx</files>
  <action>
For each window-only dock item (ai-chat, server-control, subagents, schedules, terminal), add a `to` prop alongside `onOpenWindow`. The `to` prop will be used on mobile, `onOpenWindow` on desktop.

Change each DockItem that currently has ONLY onOpenWindow:

For AI Chat (lines 159-172), change to:
```tsx
<DockItem
    appId='LIVINITY_ai-chat'
    iconSize={iconSize}
    iconSizeZoomed={iconSizeZoomed}
    open={pathname.startsWith('/ai-chat')}
    mouseX={mouseX}
    to='/ai-chat'
    onOpenWindow={() =>
        handleOpenWindow(
            'LIVINITY_ai-chat',
            '/ai-chat',
            'AI Chat',
            systemAppsKeyed['LIVINITY_ai-chat'].icon,
        )
    }
/>
```

Same pattern for server-control (to='/server-control'), subagents (to='/subagents'), schedules (to='/schedules'), terminal (to='/terminal').
  </action>
  <verify>
Read dock.tsx and confirm all 5 window-only DockItems now have both `to` and `onOpenWindow` props.
  </verify>
  <done>Dock items now have both to (mobile) and onOpenWindow (desktop) props.</done>
</task>

<task type="auto">
  <name>Task 3: Update DockItem to prefer window on desktop, route on mobile</name>
  <files>livos/packages/ui/src/modules/desktop/dock-item.tsx</files>
  <action>
Find the conditional rendering section that checks `onOpenWindow` (around lines 159-172):

```tsx
{onOpenWindow ? (
    <button
        className='absolute inset-0 outline-none rounded-xl'
        onClick={() => {
            onOpenWindow()
        }}
    />
) : (
    <Link
        to={to || '/'}
        className='absolute inset-0 outline-none rounded-xl'
        unstable_viewTransition
    />
)}
```

Change to prefer onOpenWindow on desktop, but use Link on mobile even if onOpenWindow exists:

```tsx
{onOpenWindow && !isMobile ? (
    <button
        className='absolute inset-0 outline-none rounded-xl'
        onClick={() => {
            onOpenWindow()
        }}
    />
) : (
    <Link
        to={to || '/'}
        className='absolute inset-0 outline-none rounded-xl'
        unstable_viewTransition
    />
)}
```

Add the useIsMobile import at the top if not already present:
```typescript
import {useIsMobile} from '@/hooks/use-is-mobile'
```

And in the DockItem component body, add:
```typescript
const isMobile = useIsMobile()
```
  </action>
  <verify>
Read dock-item.tsx and confirm:
- useIsMobile is imported and used
- onOpenWindow is only used when NOT mobile
- Mobile always uses the Link with `to` prop
  </verify>
  <done>DockItem now uses windows on desktop and routes on mobile.</done>
</task>

</tasks>

<verification>
1. All 5 window-only apps now have sheet routes in router.tsx
2. All 5 dock items have both `to` and `onOpenWindow` props
3. DockItem renders Link on mobile, button on desktop
4. Run `cd livos && pnpm build` to verify no errors
</verification>
