---
phase: v1.3-03-proxy-anti-detection
plan: 01
subsystem: networking
tags: [chromium, proxy, socks5, http, anti-detection, docker, linuxserver, s6-overlay]

# Dependency graph
requires:
  - phase: v1.3-01-container-app-store
    provides: Chromium app in builtin-apps.ts and gallery template structure
provides:
  - Dynamic CHROME_CLI assembly via container init script
  - PROXY_URL environment variable for SOCKS5/HTTP proxy support
  - DNS leak prevention for SOCKS5 proxies
  - User-configurable proxy at app install time
affects: [browser, automation, privacy, mcp-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Dynamic environment variable assembly via s6-overlay container_environment
    - Init script pattern for linuxserver images (custom-cont-init.d)
    - Proxy bypass lists for localhost traffic

key-files:
  created:
    - livinity-apps/chromium/custom-cont-init.d/50-build-chrome-cli.sh
  modified:
    - livinity-apps/chromium/docker-compose.yml
    - livinity-apps/chromium/Dockerfile
    - livos/packages/livinityd/source/modules/apps/builtin-apps.ts

key-decisions:
  - "Remove hardcoded CHROME_CLI from docker-compose.yml and builtin-apps.ts, build dynamically at runtime"
  - "Use s6-overlay /run/s6/container_environment/ for runtime environment variable setting"
  - "Include --remote-debugging-address=0.0.0.0 in base flags (discovered in docker-compose.yml)"
  - "PROXY_URL empty by default (no proxy unless user configures)"

patterns-established:
  - "Init scripts in custom-cont-init.d/ for dynamic environment setup"
  - "environmentOverrides in builtin-apps.ts for user-configurable fields"

# Metrics
duration: 2min
completed: 2026-02-08
---

# Phase v1.3-03-01: Proxy Anti-Detection Summary

**Dynamic CHROME_CLI with SOCKS5/HTTP proxy support and DNS leak prevention via container init script**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-08T05:26:04Z
- **Completed:** 2026-02-08T05:28:01Z
- **Tasks:** 2
- **Files modified:** 4 (3 in gallery repo, 1 in main repo)

## Accomplishments
- Dynamic CHROME_CLI assembly with proxy support eliminates hardcoded flags
- SOCKS5 proxy with DNS leak prevention via --host-resolver-rules
- HTTP proxy support with bypass list for localhost
- User can configure PROXY_URL at app install time via environmentOverrides
- All anti-detection flags preserved (--disable-blink-features=AutomationControlled, --disable-infobars, --disable-dev-shm-usage)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create dynamic CHROME_CLI entrypoint and update gallery template** - `fe5ab7d` (feat) - Gallery repo
2. **Task 2: Update builtin-apps.ts chromium entry with PROXY_URL support** - `4a72408` (feat) - Main repo

## Files Created/Modified

**Gallery repo (livinity-apps):**
- `chromium/custom-cont-init.d/50-build-chrome-cli.sh` - Init script that assembles CHROME_CLI dynamically with base flags + optional proxy configuration
- `chromium/docker-compose.yml` - Removed hardcoded CHROME_CLI, added PROXY_URL environment variable (empty default)
- `chromium/Dockerfile` - Added COPY for init script into /custom-cont-init.d/50-build-chrome-cli

**Main repo (livinity-io):**
- `livos/packages/livinityd/source/modules/apps/builtin-apps.ts` - Removed CHROME_CLI from chromium docker.environment, added PROXY_URL, added environmentOverrides for user configuration

## Decisions Made

1. **Remove hardcoded CHROME_CLI entirely:** The init script builds CHROME_CLI dynamically at container startup by writing to `/run/s6/container_environment/CHROME_CLI`. This allows conditional proxy flags without Docker environment string manipulation.

2. **Include --remote-debugging-address=0.0.0.0:** Discovered this flag already present in docker-compose.yml (added in a previous session), preserved it in base flags for remote debugging access.

3. **PROXY_URL empty by default:** No proxy is configured unless user explicitly provides PROXY_URL at install time. This maintains zero-config simplicity while enabling advanced proxy usage.

4. **DNS leak prevention for SOCKS5:** When PROXY_URL starts with `socks5://`, the script adds `--host-resolver-rules=MAP * ~NOTFOUND , EXCLUDE $PROXY_HOST` to prevent DNS queries from bypassing the SOCKS5 proxy.

## Deviations from Plan

None - plan executed exactly as written. The script correctly includes --remote-debugging-address=0.0.0.0 which was already present in docker-compose.yml.

## Issues Encountered

None

## User Setup Required

None - PROXY_URL is optional. Users can:
- Leave PROXY_URL empty (default) for direct internet access
- Set PROXY_URL to `socks5://host:port` for SOCKS5 proxy with DNS leak prevention
- Set PROXY_URL to `http://host:port` for HTTP proxy

Configuration happens at app install time via the App Store UI (environmentOverrides field).

## Next Phase Readiness

- Proxy support complete and ready for testing
- Anti-detection flags verified and preserved
- Ready for MCP integration phase if needed
- Container startup mechanism works with linuxserver/chromium s6-overlay lifecycle

**No blockers or concerns.**

---
*Phase: v1.3-03-proxy-anti-detection*
*Completed: 2026-02-08*
