---
phase: v1.3-03-proxy-anti-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
  - C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\custom-cont-init.d\50-build-chrome-cli.sh
  - C:\Users\hello\Desktop\Projects\contabo\livinity-io\livos\packages\livinityd\source\modules\apps\builtin-apps.ts
autonomous: true

must_haves:
  truths:
    - "When PROXY_URL is set to a socks5:// URL, Chromium launches with --proxy-server pointing to that URL"
    - "When PROXY_URL is set to an http:// URL, Chromium launches with --proxy-server pointing to that URL"
    - "When PROXY_URL is not set, Chromium launches normally without any --proxy-server flag"
    - "Anti-detection flags --disable-blink-features=AutomationControlled, --disable-infobars, and --disable-dev-shm-usage are always present"
    - "Browser remains stable — the entrypoint script does not break container startup"
  artifacts:
    - path: "livinity-apps/chromium/custom-cont-init.d/50-build-chrome-cli.sh"
      provides: "Dynamic CHROME_CLI assembly with optional proxy flag"
      contains: "proxy-server"
    - path: "livinity-apps/chromium/docker-compose.yml"
      provides: "PROXY_URL environment variable passthrough"
      contains: "PROXY_URL"
    - path: "livinity-apps/chromium/Dockerfile"
      provides: "COPY of entrypoint script into container"
      contains: "custom-cont-init.d"
    - path: "livos/packages/livinityd/source/modules/apps/builtin-apps.ts"
      provides: "PROXY_URL in chromium docker.environment"
      contains: "PROXY_URL"
  key_links:
    - from: "docker-compose.yml"
      to: "50-build-chrome-cli.sh"
      via: "PROXY_URL env var passed into container, script reads it"
      pattern: "PROXY_URL"
    - from: "50-build-chrome-cli.sh"
      to: "CHROME_CLI"
      via: "Script assembles CHROME_CLI dynamically and exports it"
      pattern: "CHROME_CLI.*proxy-server"
    - from: "builtin-apps.ts"
      to: "docker-compose.yml"
      via: "Both define same environment variables for chromium app"
      pattern: "PROXY_URL"
---

<objective>
Add SOCKS5/HTTP proxy support via PROXY_URL environment variable and verify all anti-detection flags are present in the Chromium browser app.

Purpose: Enable users to route browser traffic through a proxy for privacy/automation, while ensuring the browser resists basic automation fingerprinting detection.

Output:
- Entrypoint script that dynamically assembles CHROME_CLI with --proxy-server when PROXY_URL is set
- Updated docker-compose.yml with PROXY_URL environment variable
- Updated Dockerfile to copy entrypoint script
- Updated builtin-apps.ts with PROXY_URL in chromium environment
</objective>

<execution_context>
@C:\Users\hello\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hello\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\PROJECT.md
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\ROADMAP.md
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\STATE.md

# Source files to modify
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\livos\packages\livinityd\source\modules\apps\builtin-apps.ts

# Reference for patterns
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\clean-singletonlock.sh
@C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\livinity-app.yml

# Research findings
@C:\Users\hello\Desktop\Projects\contabo\livinity-io\.planning\research\STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic CHROME_CLI entrypoint and update gallery template</name>
  <files>
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\custom-cont-init.d\50-build-chrome-cli.sh
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\docker-compose.yml
    C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\Dockerfile
  </files>
  <action>
    **1. Create `custom-cont-init.d/50-build-chrome-cli.sh`:**

    This script runs during container init (linuxserver's `/custom-cont-init.d/` mechanism, same as the existing `99-clean-singletonlock` script). It dynamically assembles CHROME_CLI and writes it so Chromium picks it up.

    The script must:
    - Define the base CHROME_CLI flags as a variable:
      `--remote-debugging-port=9222 --remote-allow-origins=* --restore-last-session --disable-blink-features=AutomationControlled --disable-infobars --disable-dev-shm-usage`
    - Check if `PROXY_URL` environment variable is set and non-empty
    - If PROXY_URL is set: append `--proxy-server=${PROXY_URL}` to the base flags. Also append `--proxy-bypass-list="localhost;127.0.0.1;*.local"` to prevent proxying local traffic.
    - If PROXY_URL starts with `socks5://`: also append `--host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE $(echo $PROXY_URL | sed 's|socks5://||' | cut -d: -f1)"` to prevent DNS leaks through SOCKS5.
    - Export the final CHROME_CLI by writing it to `/etc/cont-init.d/chrome-cli-env` or by using the linuxserver env mechanism. IMPORTANT: The linuxserver/chromium image reads CHROME_CLI from the container's environment. The simplest approach is to write the assembled value to `/etc/s6-overlay/s6-rc.d/svc-chromium/env/CHROME_CLI` (if s6 v3) or use a simpler approach: write to a file that gets sourced. Actually, the cleanest approach for linuxserver images is to write the env override to `/config/custom-cont-init.d/` won't work for env setting. Instead: since CHROME_CLI is already passed via docker-compose.yml environment, we need a DIFFERENT approach.

    **REVISED APPROACH - Override via wrapper:** Since linuxserver/chromium reads CHROME_CLI from the Docker environment and we cannot easily override env vars from init scripts, use this approach instead:

    The docker-compose.yml should NOT set CHROME_CLI directly. Instead:
    - Set `CHROME_CLI_BASE` with the base flags
    - Set `PROXY_URL` (empty by default)
    - The init script `50-build-chrome-cli.sh` reads CHROME_CLI_BASE and PROXY_URL, assembles the final CHROME_CLI, and writes it using s6-overlay's env mechanism.

    For linuxserver images using s6-overlay v3, you can set runtime environment variables by writing to:
    `/run/s6/container_environment/CHROME_CLI`

    The script should:
    ```bash
    #!/bin/bash
    # Dynamically assemble CHROME_CLI from base flags + optional proxy
    # Runs via linuxserver's /custom-cont-init.d/ mechanism

    BASE_FLAGS="--remote-debugging-port=9222 --remote-allow-origins=* --restore-last-session --disable-blink-features=AutomationControlled --disable-infobars --disable-dev-shm-usage"

    FINAL_FLAGS="$BASE_FLAGS"

    if [ -n "$PROXY_URL" ]; then
      FINAL_FLAGS="$FINAL_FLAGS --proxy-server=$PROXY_URL"
      FINAL_FLAGS="$FINAL_FLAGS --proxy-bypass-list=localhost;127.0.0.1;*.local"

      # For SOCKS5, prevent DNS leaks
      if echo "$PROXY_URL" | grep -qi "^socks5://"; then
        PROXY_HOST=$(echo "$PROXY_URL" | sed 's|socks5://||i' | cut -d: -f1)
        FINAL_FLAGS="$FINAL_FLAGS --host-resolver-rules=MAP * ~NOTFOUND , EXCLUDE $PROXY_HOST"
      fi

      echo "[chrome-cli] Proxy enabled: $PROXY_URL"
    else
      echo "[chrome-cli] No proxy configured"
    fi

    # Write assembled CHROME_CLI for s6-overlay to pick up
    printf "%s" "$FINAL_FLAGS" > /run/s6/container_environment/CHROME_CLI
    echo "[chrome-cli] CHROME_CLI assembled: $FINAL_FLAGS"
    ```

    Make the script executable (chmod +x).

    **2. Update `docker-compose.yml`:**

    Change the environment section:
    - REMOVE the hardcoded `CHROME_CLI=...` line entirely (the init script now builds it dynamically)
    - ADD `PROXY_URL=` (empty string default — no proxy by default)
    - Keep all other environment variables unchanged (PUID, PGID, CUSTOM_USER, PASSWORD, TZ)

    The CHROME_CLI will be set by the init script at runtime, so it should NOT appear in docker-compose.yml environment.

    **3. Update `Dockerfile`:**

    Add a COPY line to copy the init script into the container. Add it AFTER the existing COPY for clean-singletonlock.sh:
    ```
    COPY custom-cont-init.d/50-build-chrome-cli.sh /custom-cont-init.d/50-build-chrome-cli
    ```

    Note: The `50-` prefix ensures it runs BEFORE the `99-clean-singletonlock` script (numerically ordered). No `.sh` extension in the destination path — linuxserver convention for cont-init.d scripts (match the existing `99-clean-singletonlock` pattern which also drops the extension).
  </action>
  <verify>
    1. Verify the init script exists and is syntactically valid: `bash -n C:\Users\hello\Desktop\Projects\contabo\livinity-apps\chromium\custom-cont-init.d\50-build-chrome-cli.sh`
    2. Verify docker-compose.yml has PROXY_URL and does NOT have CHROME_CLI in environment
    3. Verify Dockerfile copies the new init script
    4. Verify the anti-detection flags are present in the BASE_FLAGS string inside the init script:
       - `--disable-blink-features=AutomationControlled`
       - `--disable-infobars`
       - `--disable-dev-shm-usage`
  </verify>
  <done>
    - `50-build-chrome-cli.sh` exists with proper proxy logic (SOCKS5 DNS leak prevention, bypass list)
    - docker-compose.yml has `PROXY_URL=` in environment, no hardcoded CHROME_CLI
    - Dockerfile copies both init scripts (50-build-chrome-cli and 99-clean-singletonlock)
    - All three anti-detection flags present in base flags
  </done>
</task>

<task type="auto">
  <name>Task 2: Update builtin-apps.ts chromium entry with PROXY_URL support</name>
  <files>
    C:\Users\hello\Desktop\Projects\contabo\livinity-io\livos\packages\livinityd\source\modules\apps\builtin-apps.ts
  </files>
  <action>
    Update the `chromium` entry in the BUILTIN_APPS array in `builtin-apps.ts`:

    1. In the `docker.environment` object for the chromium entry:
       - REMOVE the `CHROME_CLI` key entirely (the init script now builds it dynamically at container runtime)
       - ADD `PROXY_URL: ''` (empty string — no proxy by default)
       - Keep CUSTOM_USER, PASSWORD, and TZ unchanged

    2. In the `installOptions` for the chromium entry:
       - ADD an `environmentOverrides` array with a PROXY_URL field so users can configure it during install:
         ```typescript
         environmentOverrides: [
           { name: 'PROXY_URL', label: 'Proxy URL (e.g. socks5://host:port)', type: 'string', default: '', required: false },
         ],
         ```
       - Keep the existing `subdomain: 'browser'`

    The final chromium entry should look like:
    ```typescript
    {
      id: 'chromium',
      name: 'Chromium Browser',
      tagline: 'Persistent web browser with AI control',
      version: '1.0.0',
      category: 'networking',
      port: 6901,
      description: 'A persistent Chromium browser running in Docker with KasmVNC web viewer. Sessions survive restarts -- stay logged into Google, Facebook, and other sites. Includes Playwright MCP for AI-powered browser automation via LivOS. Anti-detection flags prevent automation fingerprinting.',
      website: 'https://www.chromium.org/Home/',
      developer: 'Livinity',
      icon: 'https://raw.githubusercontent.com/nicedoc/browser-logos/refs/heads/main/src/chromium/chromium.svg',
      docker: {
        image: 'lscr.io/linuxserver/chromium:latest',
        environment: {
          CUSTOM_USER: '',
          PASSWORD: '',
          PROXY_URL: '',
          TZ: 'Europe/Istanbul',
        },
        volumes: ['/config'],
      },
      installOptions: {
        subdomain: 'browser',
        environmentOverrides: [
          { name: 'PROXY_URL', label: 'Proxy URL (e.g. socks5://host:port)', type: 'string', default: '', required: false },
        ],
      },
    }
    ```

    Do NOT modify any other app entries in the file. Only touch the chromium entry.
  </action>
  <verify>
    1. Verify the file has no TypeScript syntax errors: check that PROXY_URL appears in the chromium docker.environment
    2. Verify CHROME_CLI does NOT appear anywhere in the chromium entry
    3. Verify PROXY_URL appears in environmentOverrides with required: false
    4. Verify no other app entries were modified (diff should only show changes in the chromium block)
  </verify>
  <done>
    - builtin-apps.ts chromium entry has PROXY_URL in docker.environment (empty default)
    - CHROME_CLI removed from builtin-apps.ts (now built dynamically by init script)
    - PROXY_URL configurable at install time via environmentOverrides
    - All other app entries untouched
  </done>
</task>

</tasks>

<verification>
1. Gallery template (livinity-apps/chromium/):
   - docker-compose.yml has PROXY_URL env var, no CHROME_CLI
   - Dockerfile copies both init scripts
   - 50-build-chrome-cli.sh assembles CHROME_CLI dynamically with proxy support
   - All anti-detection flags present in base flags string
2. LivOS codebase (builtin-apps.ts):
   - Chromium entry has PROXY_URL in environment, no CHROME_CLI
   - PROXY_URL is user-configurable via environmentOverrides
3. Requirements coverage:
   - PROXY-01 (SOCKS5): Covered by --proxy-server=socks5://... assembly
   - PROXY-02 (HTTP): Covered by --proxy-server=http://... assembly
   - PROXY-03 (env vars): Covered by PROXY_URL in docker-compose.yml
   - SEC-01 (anti-detection): Covered by base flags in init script
   - SEC-02 (disable-dev-shm-usage): Covered by base flags in init script
</verification>

<success_criteria>
- PROXY_URL=socks5://host:port results in CHROME_CLI containing --proxy-server=socks5://host:port --proxy-bypass-list=... --host-resolver-rules=...
- PROXY_URL=http://host:port results in CHROME_CLI containing --proxy-server=http://host:port --proxy-bypass-list=...
- PROXY_URL= (empty) results in CHROME_CLI with only base flags (no --proxy-server)
- Anti-detection flags --disable-blink-features=AutomationControlled, --disable-infobars, --disable-dev-shm-usage are always in CHROME_CLI
- builtin-apps.ts allows PROXY_URL configuration at install time
</success_criteria>

<output>
After completion, create `.planning/phases/v1.3-03-proxy-anti-detection/v1.3-03-01-SUMMARY.md`
</output>
